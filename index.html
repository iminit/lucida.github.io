
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="xcnfIp24QN30miBMIDuuCCQF5IKPlu9_-U0785KdzLc" />
  <title>Lucida</title>
  <meta name="author" content="Lucida">

  
  <meta name="description" content="90分钟实现一门编程语言——极简解释器教程 关键字 解释器, C#, Scheme, 函数式编程 本文链接：http://zh.lucida.me/blog/how-to-implement-an-intepreter-in-csharp/ 关于 本文介绍了如何使用C#实现一个简化Scheme—— &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://lucida.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Lucida" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Lucida</a></h1>
  
    <h2>Life Love Tech</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://www.duckduckgo.com/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sites" value="lucida.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search&hellip;"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="http://en.lucida.me">English</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/how-to-implement-an-interpreter-in-csharp/">90分钟实现一门编程语言——极简解释器教程</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-23T19:08:35+00:00" pubdate data-updated="true">Mar 23<span>rd</span>, 2014</time>
        
           | <a href="/blog/how-to-implement-an-interpreter-in-csharp/#disqus_thread"
             data-disqus-identifier="http://lucida.github.io/blog/how-to-implement-an-interpreter-in-csharp/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>90分钟实现一门编程语言——极简解释器教程</h1>

<h2>关键字</h2>

<p>解释器, C#, Scheme, 函数式编程</p>

<p>本文链接：<a href="http://zh.lucida.me/blog/how-to-implement-an-intepreter-in-csharp/">http://zh.lucida.me/blog/how-to-implement-an-intepreter-in-csharp/</a></p>

<h2>关于</h2>

<p>本文介绍了如何使用C#实现一个简化Scheme——iScheme及其解释器。</p>

<p>如果你对下面的内容感兴趣：</p>

<ul>
<li>实现基本的词法分析，语法分析并生成抽象语法树。</li>
<li>实现嵌套作用域和函数调用。</li>
<li>解释器的基本原理。</li>
<li>以及一些C#编程技巧。</li>
</ul>


<p>那么请继续阅读。</p>

<p>如果你对以下内容感兴趣：</p>

<ul>
<li>高级的词法/语法分析技术。</li>
<li>类型推导/分析。</li>
<li>目标代码优化。</li>
</ul>


<p>本文则过于初级，你可以跳过本文，但欢迎指出本文的错误 :&ndash;)</p>

<h2>代码样例</h2>

<figure class='code'><figcaption><span>代码示例</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">a</span> <span class="p">+</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="n">Add</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">)</span>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="m">7</span>
</span><span class='line'>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="n">Add</span><span class="p">(</span><span class="m">5</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="m">10</span>
</span></code></pre></td></tr></table></div></figure>


<p>这段代码定义了<code>Add</code>函数，接下来的<code>&gt;&gt;</code>符号表示对<code>Add(3, 4)</code>进行求值，再下一行的<code>&gt;&gt; 7</code>表示上一行的求值结果，不同的求值用换行分开。可以把这里的<code>&gt;&gt;</code>理解成控制台提示符（即Terminal中的PS）。</p>

<h2>什么是解释器</h2>

<p><img src="http://i.imgur.com/C8lxHfr.jpg" alt="解释器图示" /></p>

<p><a href="http://zh.wikipedia.org/wiki/%E8%A7%A3%E9%87%8A%E5%99%A8">解释器</a>（Interpreter）是一种程序，能够读入程序并直接输出结果，如上图。相对于<a href="http://zh.wikipedia.org/wiki/%E7%BC%96%E8%AF%91%E5%99%A8">编译器</a>（Compiler），<a href="http://zh.wikipedia.org/wiki/%E8%A7%A3%E9%87%8A%E5%99%A8">解释器</a>并不会生成目标机器代码，而是直接运行源程序，简单来说：</p>

<blockquote><p><a href="http://zh.wikipedia.org/wiki/%E8%A7%A3%E9%87%8A%E5%99%A8">解释器</a>是运行程序的程序。</p></blockquote>

<p>计算器就是一个典型的解释器，我们把数学公式（源程序）给它，它通过运行它内部的&#8221;解释器&#8221;给我们答案。</p>

<p><img src="http://i.imgur.com/FC1nqko.jpg" alt="CASIO 计算器" /></p>

<h2>iScheme编程语言</h2>

<p>iScheme是什么？</p>

<ul>
<li>Scheme语言的一个极简子集。</li>
<li>虽然小，但变量，算术|比较|逻辑运算，列表，函数和递归这些编程语言元素一应俱全。</li>
<li>非常非常慢——可以说它只是为演示本文的概念而存在。</li>
</ul>


<p>OK，那么Scheme是什么？</p>

<ul>
<li>一种函数式程序设计语言。</li>
<li>一种Lisp方言。</li>
<li>麻省理工学院程序设计入门课程使用的语言（参见<a href="http://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-001-structure-and-interpretation-of-computer-programs-spring-2005/">MIT 6.001</a>和《<a href="http://book.douban.com/subject/1148282/">计算机程序的构造与解释</a>》）。</li>
</ul>


<p><img src="http://i.imgur.com/66TdRMD.jpg" alt="计算机程序的构造与解释" /></p>

<ul>
<li>使用<a href="http://zh.wikipedia.org/wiki/%E6%B3%A2%E5%85%B0%E8%A1%A8%E7%A4%BA%E6%B3%95">波兰表达式</a>（Polish Notation）。</li>
<li>更多的介绍参见<a href="http://zh.wikipedia.org/wiki/Scheme">Scheme编程语言</a>。</li>
</ul>


<p>以计算阶乘为例：</p>

<figure class='code'><figcaption><span>C#版阶乘</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">Factorial</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">n</span> <span class="p">*</span> <span class="n">Factorial</span><span class="p">(</span><span class="n">n</span> <span class="p">-</span> <span class="m">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>iScheme版阶乘</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">factorial</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">n</span><span class="p">)</span> <span class="p">(</span>
</span><span class='line'>    <span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">n</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>       <span class="mi">1</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">* </span><span class="nv">n</span> <span class="p">(</span><span class="nf">factorial</span> <span class="p">(</span><span class="nb">- </span><span class="nv">n</span> <span class="mi">1</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>


<h3>数值类型</h3>

<p>由于iScheme只是一个用于演示的语言，所以目前只提供对整数的支持。iScheme使用C#的<code>Int64</code>类型作为其内部的数值表示方法。</p>

<h3>定义变量</h3>

<figure class='code'><figcaption><span>iScheme使用`def`关键字定义变量</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">def</span> <span class="nv">a</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">3</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="nv">a</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">3</span>
</span></code></pre></td></tr></table></div></figure>


<h3>算术|逻辑|比较操作</h3>

<p>与常见的编程语言（C#, Java, C++, C）不同，Scheme使用<a href="http://zh.wikipedia.org/wiki/%E6%B3%A2%E5%85%B0%E8%A1%A8%E7%A4%BA%E6%B3%95">波兰表达式</a>，即前缀表示法。例如：</p>

<figure class='code'><figcaption><span>C#中的算术|逻辑|比较操作</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// Arithmetic ops</span>
</span><span class='line'><span class="n">a</span> <span class="p">+</span> <span class="n">b</span> <span class="p">*</span> <span class="n">c</span>
</span><span class='line'><span class="n">a</span> <span class="p">/</span> <span class="p">(</span><span class="n">b</span> <span class="p">+</span> <span class="n">c</span> <span class="p">+</span> <span class="n">d</span><span class="p">)</span>
</span><span class='line'><span class="c1">// Logical ops</span>
</span><span class='line'><span class="p">(</span><span class="n">cond1</span> <span class="p">&amp;&amp;</span> <span class="n">cond2</span><span class="p">)</span> <span class="p">||</span> <span class="n">cond3</span>
</span><span class='line'><span class="c1">// Comparing ops</span>
</span><span class='line'><span class="n">a</span> <span class="p">==</span> <span class="n">b</span>
</span><span class='line'><span class="m">1</span> <span class="p">&lt;</span> <span class="n">a</span> <span class="p">&amp;&amp;</span> <span class="n">a</span> <span class="p">&lt;</span> <span class="m">3</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>对应的iScheme代码</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="c1">; Arithmetic ops</span>
</span><span class='line'><span class="p">(</span><span class="nb">+ </span><span class="nv">a</span> <span class="p">(</span><span class="nb">* </span><span class="nv">b</span> <span class="nv">c</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="nb">/ </span><span class="nv">a</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">b</span> <span class="nv">c</span> <span class="nv">d</span><span class="p">))</span>
</span><span class='line'><span class="c1">; Logical ops</span>
</span><span class='line'><span class="p">(</span><span class="k">or </span><span class="p">(</span><span class="k">and </span><span class="nv">cond1</span> <span class="nv">cond2</span><span class="p">)</span> <span class="nv">cond3</span><span class="p">)</span>
</span><span class='line'><span class="c1">; Comparing ops</span>
</span><span class='line'><span class="p">(</span><span class="nb">= </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nb">&lt; </span><span class="mi">1</span> <span class="nv">a</span> <span class="mi">3</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>需要注意的几点：</p>

<ol>
<li>iScheme中的操作符可以接受不止两个参数——这在一定程度上控制了括号的数量。</li>
<li>iScheme逻辑操作使用<code>and</code>, <code>or</code>和<code>not</code>代替了常见的<code>&amp;&amp;</code>, <code>||</code>和<code>!</code>——这在一定程度上增强了程序的可读性。</li>
</ol>


<h3>顺序语句</h3>

<p>iScheme使用<code>begin</code>关键字标识顺序语句，并以最后一条语句的值作为返回结果。以求两个数的平均值为例：</p>

<figure class='code'><figcaption><span>C#的顺序语句</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">int</span> <span class="n">a</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">b</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">c</span> <span class="p">=</span> <span class="p">(</span><span class="n">a</span> <span class="p">+</span> <span class="n">b</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>iScheme的顺序语句</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">c</span> <span class="p">(</span><span class="nf">begin</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">def</span> <span class="nv">a</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">def</span> <span class="nv">b</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">/ </span><span class="p">(</span><span class="nb">+ </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="mi">2</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<h3>控制流操作</h3>

<p>iScheme中的控制流操作只包含<code>if</code>。</p>

<figure class='code'><figcaption><span>if语句示例</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="k">define </span><span class="nv">a</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="mi">3</span> <span class="mi">2</span><span class="p">)</span> <span class="mi">1</span> <span class="mi">2</span><span class="p">))</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="nv">a</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<h3>列表类型</h3>

<p>iScheme使用<code>list</code>关键字定义列表，并提供<code>first</code>关键字获取列表的第一个元素；提供<code>rest</code>关键字获取列表除第一个元素外的元素。</p>

<figure class='code'><figcaption><span>iScheme的列表示例</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="k">define </span><span class="nv">alist</span> <span class="p">(</span><span class="nb">list </span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">))</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nb">list </span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">first</span> <span class="nv">alist</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">rest</span> <span class="nv">alist</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>定义函数</h3>

<p>iScheme使用<code>func</code>关键字定义函数：</p>

<figure class='code'><figcaption><span>iScheme的函数定义</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">square</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">x</span> <span class="nv">x</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">sum_square</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">a</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">square</span> <span class="nv">a</span><span class="p">)</span> <span class="p">(</span><span class="nf">square</span> <span class="nv">b</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>对应的C#代码</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">Square</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">x</span> <span class="p">*</span> <span class="n">x</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">SumSquare</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">Square</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">+</span> <span class="n">Square</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>递归</h3>

<p>由于iScheme中没有<code>for</code>或<code>while</code>这种命令式语言（Imperative Programming Language）的循环结构，递归成了重复操作的唯一选择。</p>

<p>以计算最大公约数为例：</p>

<figure class='code'><figcaption><span>iScheme计算最大公约数</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">gcd</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">a</span> <span class="nv">b</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">b</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">a</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">b</span> <span class="p">(</span><span class="nf">%</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>对应的C#代码</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">GCD</span> <span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">GCD</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="p">%</span> <span class="n">b</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>高阶函数</h3>

<p>和Scheme一样，函数在iScheme中是头等对象，这意味着：</p>

<ul>
<li>可以定义一个变量为函数。</li>
<li>函数可以接受一个函数作为参数。</li>
<li>函数返回一个函数。</li>
</ul>


<figure class='code'><figcaption><span>iScheme的高阶函数示例</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="c1">; Defines a multiply function.</span>
</span><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">mul</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">a</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)))</span>
</span><span class='line'><span class="c1">; Defines a list map function.</span>
</span><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">map</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">f</span> <span class="nv">alist</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">empty?</span> <span class="nv">alist</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">list </span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">append </span><span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nf">f</span> <span class="p">(</span><span class="nf">first</span> <span class="nv">alist</span><span class="p">)))</span> <span class="p">(</span><span class="nb">map </span><span class="nv">f</span> <span class="p">(</span><span class="nf">rest</span> <span class="nv">alist</span><span class="p">)))</span>
</span><span class='line'>        <span class="p">)))</span>
</span><span class='line'><span class="c1">; Doubles a list using map and mul.</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="nf">mul</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="nb">list </span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nb">list </span><span class="mi">2</span> <span class="mi">4</span> <span class="mi">6</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>小结</h3>

<p>对iScheme的介绍就到这里——事实上这就是iScheme的所有元素，会不会太简单了？ &ndash;_&ndash;</p>

<p>接下来进入正题——从头开始构造iScheme的解释程序。</p>

<h2>解释器构造</h2>

<p>iScheme解释器主要分为两部分，解析（Parse）和求值（Evaluation）：</p>

<ul>
<li>解析（Parse）：解析源程序，并生成解释器可以理解的中间（Intermediate）结构。这部分包含词法分析，语法分析，语义分析，生成语法树。</li>
<li>求值（Evaluation）：执行解析阶段得到的中介结构然后得到运行结果。这部分包含作用域，类型系统设计和语法树遍历。</li>
</ul>


<h3>词法分析</h3>

<p>词法分析负责把源程序解析成一个个词法单元（Lex），以便之后的处理。</p>

<p>iScheme的词法分析极其简单——由于iScheme的词法元素只包含括号，空白，数字和变量名，因此C#自带的<code>String#Split</code>就足够。</p>

<figure class='code'><figcaption><span>iScheme的词法分析及测试</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">String</span><span class="p">[]</span> <span class="nf">Tokenize</span><span class="p">(</span><span class="n">String</span> <span class="n">text</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">String</span><span class="p">[]</span> <span class="n">tokens</span> <span class="p">=</span> <span class="n">text</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">,</span> <span class="s">&quot; ( &quot;</span><span class="p">).</span><span class="n">Replace</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">,</span> <span class="s">&quot; ) &quot;</span><span class="p">).</span><span class="n">Split</span><span class="p">(</span><span class="s">&quot; \t\r\n&quot;</span><span class="p">.</span><span class="n">ToArray</span><span class="p">(),</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">RemoveEmptyEntries</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">tokens</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Extends String.Join for a smooth API.</span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">String</span> <span class="nf">Join</span><span class="p">(</span><span class="k">this</span> <span class="n">String</span> <span class="n">separator</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Object</span><span class="p">&gt;</span> <span class="n">values</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="n">separator</span><span class="p">,</span> <span class="n">values</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Displays the lexes in a readable form.</span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">String</span> <span class="nf">PrettyPrint</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">lexes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;[&quot;</span> <span class="p">+</span> <span class="s">&quot;, &quot;</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="n">lexes</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="s">&quot;&#39;&quot;</span> <span class="p">+</span> <span class="n">s</span> <span class="p">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">)</span> <span class="p">+</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Some tests</span>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="n">PrettyPrint</span><span class="p">(</span><span class="n">Tokenize</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="p">[</span><span class="sc">&#39;a&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="n">PrettyPrint</span><span class="p">(</span><span class="n">Tokenize</span><span class="p">(</span><span class="s">&quot;(def a 3)&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="p">[</span><span class="sc">&#39;(&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">def</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;)&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="n">PrettyPrint</span><span class="p">(</span><span class="n">Tokenize</span><span class="p">(</span><span class="s">&quot;(begin (def a 3) (* a a))&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">begin</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;(&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">def</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;)&#39;</span><span class="p">,</span> <span class="sc">&#39;(&#39;</span><span class="p">,</span> <span class="sc">&#39;*&#39;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;)&#39;</span><span class="p">,</span> <span class="sc">&#39;)&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h4>注意</h4>

<ul>
<li>个人不喜欢<code>String.Join</code>这个静态方法，所以这里使用C#的<a href="http://msdn.microsoft.com/zh-cn/library/bb383977.aspx">扩展方法</a>（Extension Methods）对String类型做了一个扩展。</li>
<li>相对于LINQ Syntax，我个人更喜欢LINQ Extension Methods，接下来的代码也都会是这种风格。</li>
<li>不要以为词法分析都是这么离谱般简单！vczh的<a href="http://www.cnblogs.com/geniusvczh/p/3577561.html">词法分析教程</a>给出了一个完整编程语言的词法分析教程。</li>
</ul>


<h3>语法树生成</h3>

<p>得到了词素之后，接下来就是进行语法分析。不过由于Lisp类语言的程序即是语法树，所以语法分析可以直接跳过。</p>

<p>以下面的程序为例：</p>

<figure class='code'><figcaption><span>程序即语法树</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="c1">;</span>
</span><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">x</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">a</span> <span class="mi">1</span><span class="p">)</span> <span class="nv">a</span> <span class="mi">1</span><span class="p">))</span>
</span><span class='line'><span class="c1">; 换一个角度看的话：</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>    <span class="nv">def</span>
</span><span class='line'>    <span class="nv">x</span>
</span><span class='line'>    <span class="p">(</span>
</span><span class='line'>        <span class="nv">if</span>
</span><span class='line'>        <span class="p">(</span>
</span><span class='line'>            <span class="nv">&gt;</span>
</span><span class='line'>            <span class="nv">a</span>
</span><span class='line'>            <span class="mi">1</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="nv">a</span>
</span><span class='line'>        <span class="mi">1</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>更加直观的图片：</p>

<p><img src="http://i.imgur.com/NVolNQE.png" alt="抽象语法树" /></p>

<p>这使得<a href="http://zh.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E8%AA%9E%E6%B3%95%E6%A8%B9">抽象语法树</a>（Abstract Syntax Tree）的构建变得极其简单（无需考虑操作符优先级等问题），我们使用<code>SExpression</code>类型定义iScheme的语法树（事实上<a href="http://en.wikipedia.org/wiki/S-expression">S Expression</a>也是Lisp表达式的名字）。</p>

<figure class='code'><figcaption><span>抽象语法树的定义</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SExpression</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">String</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">&gt;</span> <span class="n">Children</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">SExpression</span> <span class="n">Parent</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">SExpression</span><span class="p">(</span><span class="n">String</span> <span class="k">value</span><span class="p">,</span> <span class="n">SExpression</span> <span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Children</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">&gt;();</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Parent</span> <span class="p">=</span> <span class="n">parent</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="n">String</span> <span class="nf">ToString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;(&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="p">+</span> <span class="s">&quot; &quot;</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="n">Children</span><span class="p">)</span> <span class="p">+</span> <span class="s">&quot;)&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后用下面的步骤构建语法树：</p>

<ol>
<li>碰到左括号，创建一个新的节点到当前节点（<code>current</code>），然后重设当前节点。</li>
<li>碰到右括号，回退到当前节点的父节点。</li>
<li>否则把为当前词素创建节点，添加到当前节点中。</li>
</ol>


<figure class='code'><figcaption><span>抽象语法树的构建过程</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">SExpression</span> <span class="nf">ParseAsIScheme</span><span class="p">(</span><span class="k">this</span> <span class="n">String</span> <span class="n">code</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SExpression</span> <span class="n">program</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SExpression</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="k">null</span><span class="p">);</span>
</span><span class='line'>    <span class="n">SExpression</span> <span class="n">current</span> <span class="p">=</span> <span class="n">program</span><span class="p">;</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">lex</span> <span class="k">in</span> <span class="n">Tokenize</span><span class="p">(</span><span class="n">code</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">lex</span> <span class="p">==</span> <span class="s">&quot;(&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">SExpression</span> <span class="n">newNode</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SExpression</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="s">&quot;(&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">current</span><span class="p">);</span>
</span><span class='line'>            <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">newNode</span><span class="p">);</span>
</span><span class='line'>            <span class="n">current</span> <span class="p">=</span> <span class="n">newNode</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lex</span> <span class="p">==</span> <span class="s">&quot;)&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">current</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Parent</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">SExpression</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="n">lex</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">current</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">program</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>注意</h4>

<ul>
<li>使用<a href="http://msdn.microsoft.com/zh-cn/library/bb384054.aspx">自动属性</a>（Auto Property），从而避免重复编写样版代码（Boilerplate Code）。</li>
<li>使用<a href="http://msdn.microsoft.com/zh-cn/library/dd264739.aspx">命名参数</a>（Named Parameters）提高代码可读性：<code>new SExpression(value: "", parent: null)</code>比<code>new SExpression("", null)</code>可读。</li>
<li>使用<a href="http://msdn.microsoft.com/zh-cn/library/bb383977.aspx">扩展方法</a>提高代码流畅性：<code>code.Tokenize().ParseAsIScheme</code>比<code>ParseAsIScheme(Tokenize(code))</code>流畅。</li>
<li>大多数编程语言的语法分析不会这么简单！如果打算实现一个类似C#的编程语言，你需要更强大的语法分析技术：

<ul>
<li>如果打算手写语法分析器，可以参考LL(k), Precedence Climbing和Top Down Operator Precedence。</li>
<li>如果打算生成语法分析器，可以参考ANTLR或Bison。</li>
</ul>
</li>
</ul>


<h3>作用域</h3>

<p><a href="http://zh.wikipedia.org/wiki/%E4%BD%9C%E7%94%A8%E5%9F%9F">作用域</a>决定程序的运行环境。iScheme使用嵌套作用域。</p>

<p>以下面的程序为例</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">def</span> <span class="nv">x</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">def</span> <span class="nv">y</span> <span class="p">(</span><span class="k">begin </span><span class="p">(</span><span class="nf">def</span> <span class="nv">x</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">x</span> <span class="nv">x</span><span class="p">)))</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">4</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="nv">x</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://i.imgur.com/TzBY0vd.jpg" alt="作用域示例" /></p>

<p>利用C#提供的<code>Dictionary&lt;TKey, TValue&gt;</code>类型，我们可以很容易的实现iScheme的作用域<code>SScope</code>：</p>

<figure class='code'><figcaption><span>iScheme的作用域实现</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SScope</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">SScope</span> <span class="n">Parent</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">SObject</span><span class="p">&gt;</span> <span class="n">variableTable</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">SScope</span><span class="p">(</span><span class="n">SScope</span> <span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Parent</span> <span class="p">=</span> <span class="n">parent</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">variableTable</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">SObject</span><span class="p">&gt;();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">SObject</span> <span class="nf">Find</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SScope</span> <span class="n">current</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">current</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">variableTable</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">current</span><span class="p">.</span><span class="n">variableTable</span><span class="p">[</span><span class="n">name</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">current</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Parent</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="n">name</span> <span class="p">+</span> <span class="s">&quot; is not defined.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">SObject</span> <span class="nf">Define</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">SObject</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">variableTable</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">value</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>类型实现</h3>

<p>iScheme的类型系统极其简单——只有数值，Bool，列表和函数，考虑到他们都是iScheme里面的值对象（Value Object），为了便于对它们进行统一处理，这里为它们设置一个统一的父类型<code>SObject</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SObject</span> <span class="p">{</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>数值类型</h4>

<p>iScheme的数值类型只是对.Net中<code>Int64</code>（即C#里的<code>long</code>）的简单封装：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SNumber</span> <span class="p">:</span> <span class="n">SObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Int64</span> <span class="k">value</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">SNumber</span><span class="p">(</span><span class="n">Int64</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="k">value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="n">String</span> <span class="nf">ToString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="k">value</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">Int64</span><span class="p">(</span><span class="n">SNumber</span> <span class="n">number</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">number</span><span class="p">.</span><span class="k">value</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">SNumber</span><span class="p">(</span><span class="n">Int64</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">SNumber</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意这里使用了C#的<a href="http://msdn.microsoft.com/zh-cn/library/z5z9kes2.aspx">隐式操作符重载</a>，这使得我们可以：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">SNumber</span> <span class="n">foo</span> <span class="p">=</span> <span class="m">30</span><span class="p">;</span>
</span><span class='line'><span class="n">SNumber</span> <span class="n">bar</span> <span class="p">=</span> <span class="m">40</span><span class="p">;</span>
</span><span class='line'><span class="n">SNumber</span> <span class="n">foobar</span> <span class="p">=</span> <span class="n">foo</span> <span class="p">*</span> <span class="n">bar</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>而不必：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">SNumber</span> <span class="n">foo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SNumber</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="m">30</span><span class="p">);</span>
</span><span class='line'><span class="n">SNumber</span> <span class="n">bar</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SNumber</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="m">40</span><span class="p">);</span>
</span><span class='line'><span class="n">SNumber</span> <span class="n">foobar</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SNumber</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="n">foo</span><span class="p">.</span><span class="n">Value</span> <span class="p">*</span> <span class="n">bar</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>为了方便，这里也为SObject增加了<a href="http://msdn.microsoft.com/zh-cn/library/z5z9kes2.aspx">隐式操作符重载</a>（尽管<code>Int64</code>可以被转换为<code>SNumber</code>且<code>SNumber</code>继承自<code>SObject</code>，但.Net无法直接把<code>Int64</code>转化为<code>SObject</code>）：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">SObject</span><span class="p">(</span><span class="n">Int64</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">SNumber</span><span class="p">)</span><span class="k">value</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Bool类型</h4>

<p>由于Bool类型只有True和False，所以使用静态对象就足矣。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SBool</span> <span class="p">:</span> <span class="n">SObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">SBool</span> <span class="n">False</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SBool</span><span class="p">();</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">SBool</span> <span class="n">True</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SBool</span><span class="p">();</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="kt">string</span> <span class="nf">ToString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">((</span><span class="n">Boolean</span><span class="p">)</span><span class="k">this</span><span class="p">).</span><span class="n">ToString</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">Boolean</span><span class="p">(</span><span class="n">SBool</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">value</span> <span class="p">==</span> <span class="n">SBool</span><span class="p">.</span><span class="n">True</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">SBool</span><span class="p">(</span><span class="n">Boolean</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">value</span> <span class="p">?</span> <span class="n">True</span> <span class="p">:</span> <span class="n">False</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里同样使用了C#的<a href="http://msdn.microsoft.com/zh-cn/library/z5z9kes2.aspx">隐式操作符重载</a>，这使得我们可以：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">SBool</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">a</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">foo</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Do something...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>而不用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">SBool</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">a</span> <span class="p">&gt;</span> <span class="m">1</span> <span class="p">?</span> <span class="n">SBool</span><span class="p">.</span><span class="n">True</span><span class="p">:</span> <span class="n">SBool</span><span class="p">.</span><span class="n">False</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">foo</span> <span class="p">==</span> <span class="n">SBool</span><span class="p">.</span><span class="n">True</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Do something...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>同样，为<code>SObject</code>增加<a href="http://msdn.microsoft.com/zh-cn/library/z5z9kes2.aspx">隐式操作符重载</a>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">SObject</span><span class="p">(</span><span class="n">Boolean</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">SBool</span><span class="p">)</span><span class="k">value</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>列表类型</h4>

<p>iScheme使用.Net中的<code>IEnumberable&lt;T&gt;</code>实现列表类型<code>SList</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SList</span> <span class="p">:</span> <span class="n">SObject</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">SObject</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">SObject</span><span class="p">&gt;</span> <span class="n">values</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">SList</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">SObject</span><span class="p">&gt;</span> <span class="n">values</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">values</span> <span class="p">=</span> <span class="n">values</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="n">String</span> <span class="nf">ToString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&quot;(list &quot;</span> <span class="p">+</span> <span class="s">&quot; &quot;</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">values</span><span class="p">)</span> <span class="p">+</span> <span class="s">&quot;)&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="n">SObject</span><span class="p">&gt;</span> <span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">values</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">IEnumerator</span> <span class="n">IEnumerable</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">values</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>实现<code>IEnumerable&lt;SObject&gt;</code>后，就可以直接使用LINQ的一系列扩展方法，十分方便。</p>

<h4>函数类型</h4>

<p>iScheme的函数类型（<code>SFunction</code>）由三部分组成：</p>

<ul>
<li>函数体：即对应的<code>SExpression</code>。</li>
<li>参数列表。</li>
<li>作用域：函数拥有自己的作用域</li>
</ul>


<figure class='code'><figcaption><span>SFunction的实现</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SFunction</span> <span class="p">:</span> <span class="n">SObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">SExpression</span> <span class="n">Body</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">String</span><span class="p">[]</span> <span class="n">Parameters</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">SScope</span> <span class="n">Scope</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">Boolean</span> <span class="n">IsPartial</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">get</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">ComputeFilledParameters</span><span class="p">().</span><span class="n">Length</span><span class="p">.</span><span class="n">InBetween</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">SFunction</span><span class="p">(</span><span class="n">SExpression</span> <span class="n">body</span><span class="p">,</span> <span class="n">String</span><span class="p">[]</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">SScope</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Body</span> <span class="p">=</span> <span class="n">body</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Parameters</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Scope</span> <span class="p">=</span> <span class="n">scope</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">SObject</span> <span class="nf">Evaluate</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">String</span><span class="p">[]</span> <span class="n">filledParameters</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">ComputeFilledParameters</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">filledParameters</span><span class="p">.</span><span class="n">Length</span> <span class="p">&lt;</span> <span class="n">Parameters</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Scope</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="n">String</span> <span class="nf">ToString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;(func ({0}) {1})&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot; &quot;</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">SObject</span> <span class="k">value</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">((</span><span class="k">value</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Scope</span><span class="p">.</span><span class="n">FindInTop</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">return</span> <span class="n">p</span> <span class="p">+</span> <span class="s">&quot;:&quot;</span> <span class="p">+</span> <span class="k">value</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>            <span class="p">})),</span> <span class="k">this</span><span class="p">.</span><span class="n">Body</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">String</span><span class="p">[]</span> <span class="nf">ComputeFilledParameters</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">Scope</span><span class="p">.</span><span class="n">FindInTop</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">!=</span> <span class="k">null</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h5>需要注意的几点</h5>

<ul>
<li>iScheme支持部分求值（Partial Evaluation），这意味着：</li>
</ul>


<figure class='code'><figcaption><span>部分求值</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">def</span> <span class="nv">mul</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">a</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)))</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">a</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">mul</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">12</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">mul</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">a:3</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">((</span><span class="nf">mul</span> <span class="mi">3</span><span class="p">)</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">12</span>
</span></code></pre></td></tr></table></div></figure>


<p>也就是说，当<code>SFunction</code>的实际参数（Argument）数量小于其形式参数（Parameter）的数量时，它依然是一个函数，无法被求值。</p>

<p>这个功能有什么用呢？生成高阶函数。有了部分求值，我们就可以使用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">mul</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">a</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)))</span>
</span><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">mul3</span> <span class="p">(</span><span class="nf">mul</span> <span class="mi">3</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">mul3</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">9</span>
</span></code></pre></td></tr></table></div></figure>


<p>而不用专门定义一个生成函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">times</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">n</span><span class="p">)</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">n</span> <span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">n</span> <span class="nv">x</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">mul3</span> <span class="p">(</span><span class="nf">times</span> <span class="mi">3</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">mul3</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">9</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>SFunction#ToString</code>可以将其自身还原为源代码——从而大大简化了iScheme的理解和测试。</li>
</ul>


<h3>内置操作</h3>

<p>iScheme的内置操作有四种：算术|逻辑|比较|列表操作。</p>

<p>我选择了表达力（Expressiveness）强的lambda方法表来定义内置操作：</p>

<p>首先在<code>SScope</code>中添加静态字段<code>builtinFunctions</code>，以及对应的访问属性<code>BuiltinFunctions</code>和操作方法<code>BuildIn</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SScope</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">[],</span> <span class="n">SScope</span><span class="p">,</span> <span class="n">SObject</span><span class="p">&gt;&gt;</span> <span class="n">builtinFunctions</span> <span class="p">=</span>
</span><span class='line'>        <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">[],</span> <span class="n">SScope</span><span class="p">,</span> <span class="n">SObject</span><span class="p">&gt;&gt;();</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">[],</span> <span class="n">SScope</span><span class="p">,</span> <span class="n">SObject</span><span class="p">&gt;&gt;</span> <span class="n">BuiltinFunctions</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">builtinFunctions</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">// Dirty HACK for fluent API.</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">SScope</span> <span class="nf">BuildIn</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">[],</span> <span class="n">SScope</span><span class="p">,</span> <span class="n">SObject</span><span class="p">&gt;</span> <span class="n">builtinFuntion</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SScope</span><span class="p">.</span><span class="n">builtinFunctions</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">builtinFuntion</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意：</p>

<ol>
<li><code>Func&lt;T1, T2, TRESULT&gt;</code>是C#提供的委托类型，表示一个接受<code>T1</code>和<code>T2</code>，返回<code>TRESULT</code></li>
<li>这里有一个小HACK，使用实例方法（Instance Method）修改静态成员（Static Member），从而实现一套流畅的API（参见<a href="http://en.wikipedia.org/wiki/Fluent_interface">Fluent Interface</a>）。</li>
</ol>


<p>接下来就可以这样定义内置操作：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">new</span> <span class="nf">SScope</span><span class="p">(</span><span class="n">parent</span><span class="p">:</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="n">addMethod</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="n">subMethod</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">mulMethod</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="n">divMethod</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>一目了然。</p>

<h4>断言（Assertion）扩展</h4>

<p>为了便于进行<a href="http://zh.wikipedia.org/wiki/%E6%96%B7%E8%A8%80_(%E7%A8%8B%E5%BC%8F)">断言</a>，我对<code>Boolean</code>类型做了一点点扩展。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">OrThrows</span><span class="p">(</span><span class="k">this</span> <span class="n">Boolean</span> <span class="n">condition</span><span class="p">,</span> <span class="n">String</span> <span class="n">message</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(!</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="n">message</span> <span class="p">??</span> <span class="s">&quot;WTF&quot;</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>从而可以写出流畅的断言：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">(</span><span class="n">a</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;Value must be less than 3.&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>而不用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;Value must be less than 3.&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>算术操作</h4>

<p>iScheme算术操作包含<code>+ - * / %</code>五个操作，它们仅应用于数值类型（也就是<code>SNumber</code>）。</p>

<p>从加减法开始：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">numbers</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">obj</span> <span class="p">=&gt;</span> <span class="n">obj</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">Cast</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">numbers</span><span class="p">.</span><span class="n">Sum</span><span class="p">(</span><span class="n">n</span> <span class="p">=&gt;</span> <span class="n">n</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">numbers</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">obj</span> <span class="p">=&gt;</span> <span class="n">obj</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">Cast</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;().</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="n">Int64</span> <span class="n">firstValue</span> <span class="p">=</span> <span class="n">numbers</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">numbers</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">-</span><span class="n">firstValue</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">firstValue</span> <span class="p">-</span> <span class="n">numbers</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Sum</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意到这里有一段重复逻辑负责转型求值（Cast then Evaluation），考虑到接下来还有不少地方要用这个逻辑，我把这段逻辑抽象成扩展方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">&gt;</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">SScope</span> <span class="n">scope</span><span class="p">)</span>
</span><span class='line'><span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">SObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">expressions</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">).</span><span class="n">Cast</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">SObject</span><span class="p">&gt;</span> <span class="n">Evaluate</span><span class="p">(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">&gt;</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">SScope</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">expressions</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">exp</span> <span class="p">=&gt;</span> <span class="n">exp</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后加减法就可以如此定义：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;(</span><span class="n">scope</span><span class="p">).</span><span class="n">Sum</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">)))</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">numbers</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;(</span><span class="n">scope</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="n">Int64</span> <span class="n">firstValue</span> <span class="p">=</span> <span class="n">numbers</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">numbers</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">-</span><span class="n">firstValue</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">firstValue</span> <span class="p">-</span> <span class="n">numbers</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Sum</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>乘法，除法和求模定义如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;(</span><span class="n">scope</span><span class="p">).</span><span class="n">Aggregate</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">a</span> <span class="p">*</span> <span class="n">b</span><span class="p">))</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">numbers</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;(</span><span class="n">scope</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="n">Int64</span> <span class="n">firstValue</span> <span class="p">=</span> <span class="n">numbers</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">firstValue</span> <span class="p">/</span> <span class="n">numbers</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Aggregate</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">a</span> <span class="p">*</span> <span class="n">b</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">2</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;Parameters count in mod should be 2&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">numbers</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;(</span><span class="n">scope</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">numbers</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">%</span> <span class="n">numbers</span><span class="p">[</span><span class="m">1</span><span class="p">];</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h4>逻辑操作</h4>

<p>iScheme逻辑操作包括<code>and</code>，<code>or</code>和<code>not</code>，即与，或和非。</p>

<p>需要注意的是iScheme逻辑操作是<a href="http://zh.wikipedia.org/wiki/%E7%9F%AD%E8%B7%AF%E6%B1%82%E5%80%BC">短路求值</a>（Short-circuit evaluation），也就是说：</p>

<ul>
<li><code>(and condA condB)</code>，如果<code>condA</code>为假，那么整个表达式为假，无需对<code>condB</code>求值。</li>
<li><code>(or condA condB)</code>，如果<code>condA</code>为真，那么整个表达式为真，无需对<code>condB</code>求值。</li>
</ul>


<p>此外和<code>+ - * /</code>一样，<code>and</code>和<code>or</code>也可以接收任意数量的参数。</p>

<p>需求明确了接下来就是实现，iScheme的逻辑操作实现如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;and&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">!</span><span class="n">args</span><span class="p">.</span><span class="n">Any</span><span class="p">(</span><span class="n">arg</span> <span class="p">=&gt;</span> <span class="p">!(</span><span class="n">SBool</span><span class="p">)</span><span class="n">arg</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;or&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">args</span><span class="p">.</span><span class="n">Any</span><span class="p">(</span><span class="n">arg</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">SBool</span><span class="p">)</span><span class="n">arg</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;not&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h4>比较操作</h4>

<p>iScheme的比较操作包括<code>= &lt; &gt; &gt;= &lt;=</code>，需要注意下面几点：</p>

<ul>
<li><code>=</code>是比较操作而非赋值操作。</li>
<li>同算术操作一样，它们应用于数值类型，并支持任意数量的参数。</li>
</ul>


<p><code>=</code>的实现如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;Must have more than 1 argument in relation operation.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">SNumber</span> <span class="n">current</span> <span class="p">=</span> <span class="p">(</span><span class="n">SNumber</span><span class="p">)</span><span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">arg</span> <span class="k">in</span> <span class="n">args</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SNumber</span> <span class="n">next</span> <span class="p">=</span> <span class="p">(</span><span class="n">SNumber</span><span class="p">)</span><span class="n">arg</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="p">==</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">current</span> <span class="p">=</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以预见所有的比较操作都将使用这段逻辑，因此把这段比较逻辑抽象成一个扩展方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">SBool</span> <span class="nf">ChainRelation</span><span class="p">(</span><span class="k">this</span> <span class="n">SExpression</span><span class="p">[]</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">SScope</span> <span class="n">scope</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">,</span> <span class="n">SNumber</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">&gt;</span> <span class="n">relation</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="n">expressions</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;Must have more than 1 parameter in relation operation.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">SNumber</span> <span class="n">current</span> <span class="p">=</span> <span class="p">(</span><span class="n">SNumber</span><span class="p">)</span><span class="n">expressions</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">obj</span> <span class="k">in</span> <span class="n">expressions</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SNumber</span> <span class="n">next</span> <span class="p">=</span> <span class="p">(</span><span class="n">SNumber</span><span class="p">)</span><span class="n">obj</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">relation</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">next</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">current</span> <span class="p">=</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">SBool</span><span class="p">.</span><span class="n">False</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">SBool</span><span class="p">.</span><span class="n">True</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来就可以很方便的定义比较操作：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">ChainRelation</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">Int64</span><span class="p">)</span><span class="n">s1</span> <span class="p">==</span> <span class="p">(</span><span class="n">Int64</span><span class="p">)</span><span class="n">s2</span><span class="p">))</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">ChainRelation</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">s1</span> <span class="p">&gt;</span> <span class="n">s2</span><span class="p">))</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">ChainRelation</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">s1</span> <span class="p">&lt;</span> <span class="n">s2</span><span class="p">))</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;&gt;=&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">ChainRelation</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">s1</span> <span class="p">&gt;=</span> <span class="n">s2</span><span class="p">))</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">ChainRelation</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">s1</span> <span class="p">&lt;=</span> <span class="n">s2</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意<code>=</code>操作的实现里面有<code>Int64</code>强制转型——因为我们没有重载<code>SNumber#Equals</code>，所以无法直接通过<code>==</code>来比较两个<code>SNumber</code>。</p>

<h4>列表操作</h4>

<p>iScheme的列表操作包括<code>first</code>，<code>rest</code>，<code>empty?</code>和<code>append</code>，分别用来取列表的第一个元素，除第一个以外的部分，判断列表是否为空和拼接列表。</p>

<p><code>first</code>和<code>rest</code>操作如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;first&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SList</span> <span class="n">list</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">list</span> <span class="p">=</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="k">as</span> <span class="n">SList</span><span class="p">))</span> <span class="p">!=</span> <span class="k">null</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;&lt;first&gt; must apply to a list.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">list</span><span class="p">.</span><span class="n">First</span><span class="p">();</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;rest&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SList</span> <span class="n">list</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">list</span> <span class="p">=</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="k">as</span> <span class="n">SList</span><span class="p">))</span> <span class="p">!=</span> <span class="k">null</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;&lt;rest&gt; must apply to a list.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">SList</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">));</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>又发现相当的重复逻辑——判断参数是否是一个合法的列表，重复代码很邪恶，所以这里把这段逻辑抽象为扩展方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">SList</span> <span class="nf">RetrieveSList</span><span class="p">(</span><span class="k">this</span> <span class="n">SExpression</span><span class="p">[]</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">SScope</span> <span class="n">scope</span><span class="p">,</span> <span class="n">String</span> <span class="n">operationName</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SList</span> <span class="n">list</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="p">(</span><span class="n">expressions</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">list</span> <span class="p">=</span> <span class="p">(</span><span class="n">expressions</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="k">as</span> <span class="n">SList</span><span class="p">))</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span> <span class="p">+</span> <span class="n">operationName</span> <span class="p">+</span> <span class="s">&quot;&gt; must apply to a list&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">list</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>有了这个扩展方法，接下来的列表操作就很容易实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;first&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">RetrieveSList</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="s">&quot;first&quot;</span><span class="p">).</span><span class="n">First</span><span class="p">())</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;rest&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">SList</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">RetrieveSList</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="s">&quot;rest&quot;</span><span class="p">).</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">)))</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;append&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SList</span> <span class="n">list0</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span> <span class="n">list1</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">2</span>
</span><span class='line'>        <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">list0</span> <span class="p">=</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="k">as</span> <span class="n">SList</span><span class="p">))</span> <span class="p">!=</span> <span class="k">null</span>
</span><span class='line'>        <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">list1</span> <span class="p">=</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="k">as</span> <span class="n">SList</span><span class="p">))</span> <span class="p">!=</span> <span class="k">null</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;Input must be two lists&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">SList</span><span class="p">(</span><span class="n">list0</span><span class="p">.</span><span class="n">Concat</span><span class="p">(</span><span class="n">list1</span><span class="p">));</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;empty?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">RetrieveSList</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="s">&quot;empty?&quot;</span><span class="p">).</span><span class="n">Count</span><span class="p">()</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>测试</h4>

<p>iScheme的内置操作完成之后，就可以测试下初步成果了。</p>

<p>首先添加基于控制台的分析/求值（Parse/Evaluation）循环：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">KeepInterpretingInConsole</span><span class="p">(</span><span class="k">this</span> <span class="n">SScope</span> <span class="n">scope</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">SScope</span><span class="p">,</span> <span class="n">SObject</span><span class="p">&gt;</span> <span class="n">evaluate</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Gray</span><span class="p">;</span>
</span><span class='line'>            <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;&gt;&gt; &quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">code</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(!</span><span class="n">String</span><span class="p">.</span><span class="n">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">code</span> <span class="p">=</span> <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">()))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Green</span><span class="p">;</span>
</span><span class='line'>                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;&gt;&gt; &quot;</span> <span class="p">+</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">scope</span><span class="p">));</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Red</span><span class="p">;</span>
</span><span class='line'>            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;&gt;&gt; &quot;</span> <span class="p">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后在<code>SExpression#Evaluate</code>中补充调用代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">override</span> <span class="n">SObject</span> <span class="nf">Evaluate</span><span class="p">(</span><span class="n">SScope</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Int64</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">Int64</span><span class="p">.</span><span class="n">TryParse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="k">out</span> <span class="n">number</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SExpression</span> <span class="n">first</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">arguments</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">node</span> <span class="p">=&gt;</span> <span class="n">node</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">[</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">](</span><span class="n">arguments</span><span class="p">,</span> <span class="n">scope</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;THIS IS JUST TEMPORARY!&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后在<code>Main</code>中调用该解释/求值循环：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">cmdArgs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">new</span> <span class="nf">SScope</span><span class="p">(</span><span class="n">parent</span><span class="p">:</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;(</span><span class="n">scope</span><span class="p">).</span><span class="n">Sum</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">)))</span>
</span><span class='line'>        <span class="c1">// 省略若干内置函数</span>
</span><span class='line'>        <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;empty?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">RetrieveSList</span><span class="p">(</span><span class="s">&quot;empty?&quot;</span><span class="p">).</span><span class="n">Count</span><span class="p">()</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">KeepInterpretingInConsole</span><span class="p">((</span><span class="n">code</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">code</span><span class="p">.</span><span class="n">ParseAsScheme</span><span class="p">().</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>运行程序，输入一些简单的表达式：</p>

<p><img src="http://i.imgur.com/FEVEVGW.jpg" alt="运行结果" /></p>

<p>看样子还不错 :&ndash;)</p>

<p>接下来开始实现iScheme的执行（Evaluation）逻辑。</p>

<h3>执行逻辑</h3>

<p>iScheme的执行就是把语句（SExpression）在作用域（SScope）转化成对象（SObject）并对作用域（SScope）产生作用的过程，如下图所示。</p>

<p><img src="http://i.imgur.com/2j4ztfF.png" alt="编程语言的实质" /></p>

<p>iScheme的执行逻辑就在<code>SExpression#Evaluate</code>里面：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SExpression</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="n">SObject</span> <span class="nf">Evaluate</span><span class="p">(</span><span class="n">SScope</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// TODO: Todo your ass.</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>首先明确输入和输出：</p>

<ol>
<li>处理字面量（Literals）：<code>3</code>；和具名量（Named Values）：<code>x</code></li>
<li>处理<code>if</code>：<code>(if (&lt; a 3) 3 a)</code></li>
<li>处理<code>def</code>：<code>(def pi 3.14)</code></li>
<li>处理<code>begin</code>：<code>(begin (def a 3) (* a a))</code></li>
<li>处理<code>func</code>：<code>(func (x) (* x x))</code></li>
<li>处理内置函数调用：<code>(+ 1 2 3 (first (list 1 2)))</code></li>
<li>处理自定义函数调用：<code>(map (func (x) (* x x)) (list 1 2 3))</code></li>
</ol>


<p>此外，情况1和2中的<code>SExpression</code>没有子节点，可以直接读取其<code>Value</code>进行求值，余下的情况需要读取其<code>Children</code>进行求值。</p>

<p>首先处理没有子节点的情况：</p>

<h4>处理字面量和具名量</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Int64</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">Int64</span><span class="p">.</span><span class="n">TryParse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="k">out</span> <span class="n">number</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">scope</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来处理带有子节点的情况：</p>

<p>首先获得当前节点的第一个节点：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">SExpression</span> <span class="n">first</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后根据该节点的<code>Value</code>决定下一步操作：</p>

<h4>处理<code>if</code></h4>

<p><code>if</code>语句的处理方法很直接——根据判断条件（condition）的值判断执行哪条语句即可：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;if&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SBool</span> <span class="n">condition</span> <span class="p">=</span> <span class="p">(</span><span class="n">SBool</span><span class="p">)(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">condition</span> <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">3</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>处理<code>def</code></h4>

<p>直接定义即可：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;def&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">scope</span><span class="p">.</span><span class="n">Define</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="k">new</span> <span class="n">SScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>处理<code>begin</code></h4>

<p>遍历语句，然后返回最后一条语句的值：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;begin&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SObject</span> <span class="n">result</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="n">SExpression</span> <span class="n">statement</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">result</span> <span class="p">=</span> <span class="n">statement</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>处理<code>func</code></h4>

<p>利用<code>SExpression</code>构建<code>SFunction</code>，然后返回：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;func&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SExpression</span> <span class="n">body</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">];</span>
</span><span class='line'>    <span class="n">String</span><span class="p">[]</span> <span class="n">parameters</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Children</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">exp</span> <span class="p">=&gt;</span> <span class="n">exp</span><span class="p">.</span><span class="n">Value</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="n">SScope</span> <span class="n">newScope</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SScope</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">SFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">newScope</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>处理<code>list</code></h4>

<p>首先把获得<code>list</code>里元素的值，然后创建<code>SList</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;list&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">SList</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">exp</span> <span class="p">=&gt;</span> <span class="n">exp</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>处理内置操作</h4>

<p>首先对参数求值，然后调用对应的内置函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">arguments</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">node</span> <span class="p">=&gt;</span> <span class="n">node</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">[</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">](</span><span class="n">arguments</span><span class="p">,</span> <span class="n">scope</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>处理自定义函数调用</h4>

<p>自定义函数调用有两种情况：</p>

<ol>
<li>非具名函数调用：<code>((func (x) (* x x)) 3)</code></li>
<li>具名函数调用：<code>(square 3)</code></li>
</ol>


<p>调用自定义函数时应使用新的作用域，所以为<code>SFunction</code>增加<code>Update</code>方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">SFunction</span> <span class="nf">Update</span><span class="p">(</span><span class="n">SObject</span><span class="p">[]</span> <span class="n">arguments</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">existingArguments</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">Scope</span><span class="p">.</span><span class="n">FindInTop</span><span class="p">(</span><span class="n">p</span><span class="p">)).</span><span class="n">Where</span><span class="p">(</span><span class="n">obj</span> <span class="p">=&gt;</span> <span class="n">obj</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">newArguments</span> <span class="p">=</span> <span class="n">existingArguments</span><span class="p">.</span><span class="n">Concat</span><span class="p">(</span><span class="n">arguments</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="n">SScope</span> <span class="n">newScope</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Scope</span><span class="p">.</span><span class="n">Parent</span><span class="p">.</span><span class="n">SpawnScopeWith</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Parameters</span><span class="p">,</span> <span class="n">newArguments</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">SFunction</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Body</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">Parameters</span><span class="p">,</span> <span class="n">newScope</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>为了便于创建自定义作用域，并判断函数的参数是否被赋值，为<code>SScope</code>增加<code>SpawnScopeWith</code>和<code>FindInTop</code>方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">SScope</span> <span class="nf">SpawnScopeWith</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">names</span><span class="p">,</span> <span class="n">SObject</span><span class="p">[]</span> <span class="n">values</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="n">names</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;=</span> <span class="n">values</span><span class="p">.</span><span class="n">Length</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;Too many arguments.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">SScope</span> <span class="n">scope</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SScope</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">Int32</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">values</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">scope</span><span class="p">.</span><span class="n">variableTable</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">scope</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">public</span> <span class="n">SObject</span> <span class="nf">FindInTop</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">variableTable</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">variableTable</span><span class="p">[</span><span class="n">name</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面是函数调用的实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SFunction</span> <span class="n">function</span> <span class="p">=</span> <span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;(&quot;</span> <span class="p">?</span> <span class="p">(</span><span class="n">SFunction</span><span class="p">)</span><span class="n">first</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">SFunction</span><span class="p">)</span><span class="n">scope</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">arguments</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">function</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">arguments</span><span class="p">).</span><span class="n">Evaluate</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>完整的求值代码</h4>

<p>综上所述，求值代码如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">SObject</span> <span class="nf">Evaluate</span><span class="p">(</span><span class="n">SScope</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Int64</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">Int64</span><span class="p">.</span><span class="n">TryParse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="k">out</span> <span class="n">number</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">scope</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SExpression</span> <span class="n">first</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;if&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">SBool</span> <span class="n">condition</span> <span class="p">=</span> <span class="p">(</span><span class="n">SBool</span><span class="p">)(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">condition</span> <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">3</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;def&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">scope</span><span class="p">.</span><span class="n">Define</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="k">new</span> <span class="n">SScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)));</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;begin&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">SObject</span> <span class="n">result</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>            <span class="k">foreach</span> <span class="p">(</span><span class="n">SExpression</span> <span class="n">statement</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">result</span> <span class="p">=</span> <span class="n">statement</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;func&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">SExpression</span> <span class="n">body</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">];</span>
</span><span class='line'>            <span class="n">String</span><span class="p">[]</span> <span class="n">parameters</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Children</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">exp</span> <span class="p">=&gt;</span> <span class="n">exp</span><span class="p">.</span><span class="n">Value</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>            <span class="n">SScope</span> <span class="n">newScope</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SScope</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">new</span> <span class="nf">SFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">newScope</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;list&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">new</span> <span class="nf">SList</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">exp</span> <span class="p">=&gt;</span> <span class="n">exp</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)));</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">arguments</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">node</span> <span class="p">=&gt;</span> <span class="n">node</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">[</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">](</span><span class="n">arguments</span><span class="p">,</span> <span class="n">scope</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">SFunction</span> <span class="n">function</span> <span class="p">=</span> <span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;(&quot;</span> <span class="p">?</span> <span class="p">(</span><span class="n">SFunction</span><span class="p">)</span><span class="n">first</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">SFunction</span><span class="p">)</span><span class="n">scope</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">arguments</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">function</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">arguments</span><span class="p">).</span><span class="n">Evaluate</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>去除尾递归</h4>

<p>到了这里iScheme解释器就算完成了。但仔细观察求值过程还是有一个很大的问题，尾递归调用：</p>

<ul>
<li>处理<code>if</code>的尾递归调用。</li>
<li>处理函数调用中的尾递归调用。</li>
</ul>


<p>Alex Stepanov曾在<a href="http://www.amazon.co.uk/Elements-Programming-Alexander-Stepanov/dp/032163537X/">Elements of Programming</a>中介绍了一种将严格尾递归调用（Strict tail-recursive call）转化为迭代的方法，细节恕不赘述，以阶乘为例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// Recursive factorial.</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">fact</span> <span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="n">fact</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// First tranform to tail recursive version.</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">fact</span> <span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">*=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">fact</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span><span class="c1">// This is a strict tail-recursive call which can be omitted</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// Then transform to iterative version.</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">fact</span> <span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>        <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">*=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>应用这种方法到<code>SExpression#Evaluate</code>，得到转换后的版本：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">SObject</span> <span class="nf">Evaluate</span><span class="p">(</span><span class="n">SScope</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SExpression</span> <span class="n">current</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Int64</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">Int64</span><span class="p">.</span><span class="n">TryParse</span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="k">out</span> <span class="n">number</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">scope</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">SExpression</span> <span class="n">first</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;if&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">SBool</span> <span class="n">condition</span> <span class="p">=</span> <span class="p">(</span><span class="n">SBool</span><span class="p">)(</span><span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'>                <span class="n">current</span> <span class="p">=</span> <span class="n">condition</span> <span class="p">?</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">:</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">3</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;def&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">scope</span><span class="p">.</span><span class="n">Define</span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span><span class="p">,</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="k">new</span> <span class="n">SScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)));</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;begin&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">SObject</span> <span class="n">result</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>                <span class="k">foreach</span> <span class="p">(</span><span class="n">SExpression</span> <span class="n">statement</span> <span class="k">in</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">result</span> <span class="p">=</span> <span class="n">statement</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;func&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">SExpression</span> <span class="n">body</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">];</span>
</span><span class='line'>                <span class="n">String</span><span class="p">[]</span> <span class="n">parameters</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Children</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">exp</span> <span class="p">=&gt;</span> <span class="n">exp</span><span class="p">.</span><span class="n">Value</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>                <span class="n">SScope</span> <span class="n">newScope</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SScope</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="k">new</span> <span class="nf">SFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">newScope</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;list&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="k">new</span> <span class="nf">SList</span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">exp</span> <span class="p">=&gt;</span> <span class="n">exp</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)));</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="kt">var</span> <span class="n">arguments</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">node</span> <span class="p">=&gt;</span> <span class="n">node</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">[</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">](</span><span class="n">arguments</span><span class="p">,</span> <span class="n">scope</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">SFunction</span> <span class="n">function</span> <span class="p">=</span> <span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;(&quot;</span> <span class="p">?</span> <span class="p">(</span><span class="n">SFunction</span><span class="p">)</span><span class="n">first</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">SFunction</span><span class="p">)</span><span class="n">scope</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>                <span class="kt">var</span> <span class="n">arguments</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>                <span class="n">SFunction</span> <span class="n">newFunction</span> <span class="p">=</span> <span class="n">function</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">arguments</span><span class="p">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">newFunction</span><span class="p">.</span><span class="n">IsPartial</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">return</span> <span class="n">newFunction</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">();</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">current</span> <span class="p">=</span> <span class="n">newFunction</span><span class="p">.</span><span class="n">Body</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">scope</span> <span class="p">=</span> <span class="n">newFunction</span><span class="p">.</span><span class="n">Scope</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>一些演示</h4>

<p>基本的运算</p>

<p><img src="http://i.imgur.com/3417GE2.jpg" alt="基本的运算" /></p>

<p>高阶函数</p>

<p><img src="http://i.imgur.com/47a7jhf.jpg" alt="高阶函数" /></p>

<h2>回顾</h2>

<h3>小结</h3>

<p>除去注释（貌似没有注释-_-），iScheme的解释器的实现代码一共333行——包括空行，括号等元素。</p>

<p>在这300余行代码里，实现了函数式编程语言的大部分功能：算术|逻辑|运算，嵌套作用域，顺序语句，控制语句，递归，<a href="http://zh.wikipedia.org/wiki/%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0">高阶函数</a>，<a href="http://zh.wikipedia.org/wiki/%E9%83%A8%E5%88%86%E6%B1%82%E5%80%BC">部分求值</a>。</p>

<p>与我两年之前实现的Scheme方言<a href="http://www.cnblogs.com/figure9/archive/2011/07/10/2102613.html">Lucida</a>相比，iScheme除了没有字符串类型，其它功能和Lucida相同，而代码量只是前者的八分之一，编写时间是前者的十分之一（Lucida用了两天，iScheme用了一个半小时），可扩展性和易读性均秒杀前者。这说明了：</p>

<ol>
<li>代码量不能说明问题。</li>
<li>不同开发者生产效率的差别会非常巨大。</li>
<li>这两年我还是学到了一点东西的。-_&ndash;</li>
</ol>


<h3>一些设计决策</h3>

<h4>使用扩展方法提高可读性</h4>

<p>例如，通过定义<code>OrThrows</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">OrThrows</span><span class="p">(</span><span class="k">this</span> <span class="n">Boolean</span> <span class="n">condition</span><span class="p">,</span> <span class="n">String</span> <span class="n">message</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(!</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="n">message</span> <span class="p">??</span> <span class="s">&quot;WTF&quot;</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>写出流畅的断言：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">(</span><span class="n">a</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;Value must be less than 3.&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4>声明式编程风格</h4>

<p>以<code>Main</code>函数为例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">cmdArgs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">new</span> <span class="nf">SScope</span><span class="p">(</span><span class="n">parent</span><span class="p">:</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;(</span><span class="n">scope</span><span class="p">).</span><span class="n">Sum</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">)))</span>
</span><span class='line'>        <span class="c1">// Other build</span>
</span><span class='line'>        <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;empty?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">RetrieveSList</span><span class="p">(</span><span class="s">&quot;empty?&quot;</span><span class="p">).</span><span class="n">Count</span><span class="p">()</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">KeepInterpretingInConsole</span><span class="p">((</span><span class="n">code</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">code</span><span class="p">.</span><span class="n">ParseAsIScheme</span><span class="p">().</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>非常直观，而且</p>

<ul>
<li>如果需要添加新的操作，添加写一行<code>BuildIn</code>即可。</li>
<li>如果需要使用其它语法，替换解析函数<code>ParseAsIScheme</code>即可。</li>
<li>如果需要从文件读取代码，替换执行函数<code>KeepInterpretingInConsole</code>即可。</li>
</ul>


<h3>不足</h3>

<p>当然iScheme还是有很多不足：</p>

<p>语言特性方面：</p>

<ol>
<li>缺乏实用类型：没有<code>Double</code>和<code>String</code>这两个关键类型，更不用说复合类型（Compound Type）。</li>
<li>没有IO操作，更不要说网络通信。</li>
<li>效率低下：尽管去除尾递归挽回了一点效率，但iScheme的执行效率依然惨不忍睹。</li>
<li>错误信息：错误信息基本不可读，往往出错了都不知道从哪里找起。</li>
<li>不支持延续调用（Call with current continuation，即call/cc）。</li>
<li>没有并发。</li>
<li>各种bug：比如可以定义文本量，无法重载默认操作，空括号被识别等等。</li>
</ol>


<p>设计实现方面：</p>

<ol>
<li>使用了可变（Mutable）类型。</li>
<li>没有任何注释（因为觉得没有必要 &ndash;_-）。</li>
<li>糟糕的类型系统：Lisp类语言中的数据和程序可以不分彼此，而iScheme的实现中确把数据和程序分成了<code>SObject</code>和<code>SExpression</code>，现在我依然没有找到一个融合他们的好办法。</li>
</ol>


<p>这些就留到以后慢慢处理了 &ndash;_-（TODO YOUR ASS）</p>

<h2>延伸阅读</h2>

<h3>书籍</h3>

<ol>
<li>Compilers: Priciples, Techniques and Tools Principles: <a href="http://www.amazon.co.uk/Compilers-Principles-Techniques-V-Aho/dp/1292024348/">http://www.amazon.co.uk/Compilers-Principles-Techniques-V-Aho/dp/1292024348/</a></li>
<li>Language Implementation Patterns: <a href="http://www.amazon.co.uk/Language-Implementation-Patterns-Domain-Specific-Programming/dp/193435645X/">http://www.amazon.co.uk/Language-Implementation-Patterns-Domain-Specific-Programming/dp/193435645X/</a></li>
<li>*The Definitive ANTLR4 Reference: <a href="http://www.amazon.co.uk/Definitive-ANTLR-4-Reference/dp/1934356999/">http://www.amazon.co.uk/Definitive-ANTLR-4-Reference/dp/1934356999/</a></li>
<li>Engineering a compiler: <a href="http://www.amazon.co.uk/Engineering-Compiler-Keith-Cooper/dp/012088478X/">http://www.amazon.co.uk/Engineering-Compiler-Keith-Cooper/dp/012088478X/</a></li>
<li>Flex &amp; Bison: <a href="http://www.amazon.co.uk/flex-bison-John-Levine/dp/0596155972/">http://www.amazon.co.uk/flex-bison-John-Levine/dp/0596155972/</a></li>
<li>*Writing Compilers and Interpreters: <a href="http://www.amazon.co.uk/Writing-Compilers-Interpreters-Software-Engineering/dp/0470177071/">http://www.amazon.co.uk/Writing-Compilers-Interpreters-Software-Engineering/dp/0470177071/</a></li>
<li>Elements of Programming: <a href="http://www.amazon.co.uk/Elements-Programming-Alexander-Stepanov/dp/032163537X/">http://www.amazon.co.uk/Elements-Programming-Alexander-Stepanov/dp/032163537X/</a></li>
</ol>


<p>注：带*号的没有中译本。</p>

<h3>文章</h3>

<p>大多和编译前端相关，自己没时间也没能力研究后端。-_&ndash;</p>

<p>为什么编译技术很重要？看看Steve Yegge（没错，就是被王垠黑过的Google高级技术工程师）是怎么说的（需要翻墙）。</p>

<p><a href="http://steve-yegge.blogspot.co.uk/2007/06/rich-programmer-food.html">http://steve-yegge.blogspot.co.uk/2007/06/rich-programmer-food.html</a></p>

<p>本文重点参考的Peter Norvig的两篇文章：</p>

<ol>
<li>How to write a lisp interpreter in Python: <a href="http://norvig.com/lispy.html">http://norvig.com/lispy.html</a></li>
<li>An even better lisp interpreter in Python: <a href="http://norvig.com/lispy2.html">http://norvig.com/lispy2.html</a></li>
</ol>


<p>几种简单实用的语法分析技术：</p>

<ol>
<li>LL(k) Parsing：

<ul>
<li><a href="http://eli.thegreenplace.net/2008/09/26/recursive-descent-ll-and-predictive-parsers/">http://eli.thegreenplace.net/2008/09/26/recursive-descent-ll-and-predictive-parsers/</a></li>
<li><a href="http://eli.thegreenplace.net/2009/03/20/a-recursive-descent-parser-with-an-infix-expression-evaluator/">http://eli.thegreenplace.net/2009/03/20/a-recursive-descent-parser-with-an-infix-expression-evaluator/</a></li>
<li><a href="http://eli.thegreenplace.net/2009/03/14/some-problems-of-recursive-descent-parsers/">http://eli.thegreenplace.net/2009/03/14/some-problems-of-recursive-descent-parsers/</a></li>
</ul>
</li>
<li>Top Down Operator Precendence：<a href="http://javascript.crockford.com/tdop/tdop.html">http://javascript.crockford.com/tdop/tdop.html</a></li>
<li>Precendence Climbing Parsing：<a href="http://en.wikipedia.org/wiki/Operator-precedence_parser">http://en.wikipedia.org/wiki/Operator-precedence_parser</a></li>
</ol>


<h2>关于本文作者</h2>

<p>曾经的Windows/.Net/C#程序员，研究生毕业后糊里糊涂变成Linux/Java开发者。所谓一入Java深似海，现在无比怀念使用C#的岁月。</p>

<p>对解释器/编译器感兴趣，现在正在自学Coursera的<a href="https://class.coursera.org/compilers-004">Compiler课程</a>。</p>

<p>欢迎来信交流技术：lunageek#gmail#com</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/on-reading-books/">如何阅读书籍</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-15T20:05:35+00:00" pubdate data-updated="true">Mar 15<span>th</span>, 2014</time>
        
           | <a href="/blog/on-reading-books/#disqus_thread"
             data-disqus-identifier="http://lucida.github.io/blog/on-reading-books/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>如何阅读书籍</h1>

<h2>摘要</h2>

<p>这篇文章从如何阅读书籍出发，简单讨论了如何选择书籍、是否阅读原版和阅读数量这几个常见问题，然后自己的阅读问题进行了分析和总结。</p>

<h2>注意</h2>

<ol>
<li>“如何阅读”指“What to read”而非“How to read”，Mortimer J. Adler的<a href="http://book.douban.com/subject/1013208/">怎样阅读一本书</a>对How to read有着精彩的描述。</li>
<li>“书籍”指非小说（Non-fiction）类书籍。</li>
</ol>


<h2>目标</h2>

<p>我是一个功利主义者（<a href="http://en.wikipedia.org/wiki/Utilitarianism">Utilitarianism</a>），因此我认为阅读的目标在于为自己创造实际价值，所以：</p>

<ol>
<li>我不会因为某本书看起来很有趣就去阅读（机会成本）。</li>
<li>也不会因为很多人推荐某本书就去阅读（从众）。</li>
<li>更不会因为某本书难就去阅读（追求智商优越感）</li>
</ol>


<p>一本书值得阅读，当且仅当：</p>

<ol>
<li>它可以直接为我创造价值。</li>
<li>它可以间接为我创造价值。</li>
</ol>


<p>我的阅读目标：</p>

<blockquote><p>形成T型知识结构：专业知识尽可能深入，专业周边知识尽可能精炼。</p></blockquote>

<h2>如何选择？</h2>

<h3>专业书籍</h3>

<blockquote><p>专业知识尽可能深入。</p></blockquote>

<p>我是一个软件开发者（Software Developer），因此这里的专业书籍均和软件开发有关。</p>

<p>这里介绍我自己用的两种方法：</p>

<h4>根据引用列表</h4>

<p>从一本经典书籍出发，深度优先遍历它的引用列表，通过书评和摘要了解这些引用书籍，再根据自己的实际情况决定自己的阅读次序。</p>

<p>这里以<a href="http://book.douban.com/subject/1477390/">代码大全</a>为例（为了方便和一致性，这里使用英文书名）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Code Complete：软件构建全程最佳实践指南。
</span><span class='line'>|
</span><span class='line'>|----How to Solve it：系统解决问题。
</span><span class='line'>|
</span><span class='line'>|----Conceptual Blockbusting：跳出思维的壁垒。
</span><span class='line'>|
</span><span class='line'>|----Mythical Man Month：软件工程不能做什么。
</span><span class='line'>|
</span><span class='line'>|----Programming Pearls：极简算法手册。
</span><span class='line'>     |
</span><span class='line'>     |----The Science of Programming：编写正确的程序。
</span><span class='line'>     |
</span><span class='line'>     |----Writing Efficient Programs：编写高效的程序。
</span><span class='line'>|
</span><span class='line'>|----Pragmatic Programmer：高效程序员的实践。
</span><span class='line'>|
</span><span class='line'>|----Refactoring：如何改进自己的代码。
</span><span class='line'>|
</span><span class='line'>|----Programming on Purposes：用正确的编程模式处理问题。
</span><span class='line'>|
</span><span class='line'>|----Software Tools：用合适的抽象封装复杂度。
</span><span class='line'>     |
</span><span class='line'>     |----The Practice of Programming：极简编程风格指南。
</span><span class='line'>          |
</span><span class='line'>          |---- Writing Solid Code：减少调试的时间。
</span><span class='line'>          |
</span><span class='line'>          |---- Elements of Programming Style：极简编程风格指南。</span></code></pre></td></tr></table></div></figure>


<p>可以发现，通过<a href="http://book.douban.com/subject/1477390/">代码大全</a>一本书，经过短短两层引用联系，几乎可以找到2004年以前所有软件开发的经典书籍。事实上，我阅读的80%以上的软件开发经典书籍，都源自于<a href="http://book.douban.com/subject/1477390/">代码大全</a>的引用列表。</p>

<p>这种方法的好处：</p>

<ul>
<li>简单直接：相对于从茫茫书海里找出10本经典书籍，找1本经典书籍再从它的引用列表里面找到20本经典书籍要容易的多。</li>
<li>质量保证：靠谱书籍的引用书籍的质量一般都很高。</li>
<li>发现一些被忽视的经典：相当一部分的书籍随着时间的流逝而淡出人们的视野，但这并不代表它们本身没有价值，例如：

<ul>
<li><a href="http://book.douban.com/subject/1989284/">Programming on Purposes</a></li>
<li><a href="http://book.douban.com/subject/1815459/">Software Tools</a></li>
<li><a href="http://book.douban.com/subject/2350559/">The Science of Programming</a></li>
<li><a href="http://book.douban.com/subject/1456967/">Writing Solid Code</a></li>
<li><a href="http://book.douban.com/subject/1768600/">Writing Efficient Programs</a></li>
<li>等等&hellip; 这些书或者绝版，但它们都对我的软件开发理念产生了巨大影响。</li>
</ul>
</li>
<li>形成知识体系：引用书籍彼此具有天然的联系，这使得创建知识体系更加容易。</li>
</ul>


<p>我认为这种方法适用于任何需要严肃阅读的领域：</p>

<ol>
<li>锚点：找到一本经典书籍。</li>
<li>撒网：了解该书引用列表中的书籍。</li>
<li>收网：根据自己实际需要，精读相关书籍。</li>
</ol>


<h4>根据作者</h4>

<p>这里以计算机书籍为例（以下仅代表个人口味）：</p>

<ol>
<li>Richard Stevens：善。</li>
<li>Brian Kernighan：极善。</li>
<li>Deitel Series：翔。</li>
<li>Bruce Eckel：废话连篇。</li>
<li>Jon Bentley：善。</li>
<li>Andrew S Tanenbaum：大善。</li>
<li>Jeffrey D Ullman：善。</li>
<li>P.J. Plauger：大善。</li>
<li>Robert C Martin：善。</li>
<li>Bjarne Stroustrup：善，但略神叨（神侃世界观方法论有点顶不住）。</li>
<li>Martin Fowler：善，但略唠叨。</li>
<li>Ron Jeffries：翔（好吧我是故意来黑的，尼玛连个<a href="http://devgrind.com/2007/04/25/how-to-not-solve-a-sudoku/">Sudoku</a>都解不出来写毛程序）</li>
</ol>


<p>这种方法的问题在于需要一定阅读经验，但是它非常有效——以至于不用看内容就对书的质量有七八成把握。</p>

<h3>非本专业书籍</h3>

<blockquote><p>专业周边知识尽可能精炼。</p></blockquote>

<ol>
<li>对于专业周边知识，了解关键概念及指导思想即可。</li>
<li>不需要，也没有必要对专业周边知识进行深入了解。</li>
<li>&ldquo;Know what&rdquo; is enough, &ldquo;Know how&rdquo; is expensive.</li>
</ol>


<p>以我2年前编写手机应用，学习用户体验为例：</p>

<ol>
<li>分别在现实中（身边有几个很不错的交互设计师）和线上（Quora和知乎）进行提问和搜索，得到一个书单。</li>
<li>按照下面的原则过滤书单：

<ul>
<li>去掉教科书和大部头。</li>
<li>去掉包含大量原理或论证的书籍。</li>
<li>保留结论型书籍。</li>
<li>保留指南型书籍。</li>
</ul>
</li>
<li>总结出书单，迅速的阅读并找到关键点。

<ul>
<li><a href="http://book.douban.com/subject/3323633/">给大家看的设计书</a>：CRAP原则，字体与配色。</li>
<li><a href="http://book.douban.com/subject/4606471/">设计心理学</a>：心智模型，心智摩擦，最小惊讶。</li>
<li><a href="http://book.douban.com/subject/1493316/">交互设计之路</a>：为什么需要交互，交互有哪些坑。</li>
<li><a href="http://book.douban.com/subject/4254166/">Tapworthy</a>：具有实际操作性的移动平台交互设计指南。</li>
</ul>
</li>
</ol>


<p>了解设计的人可能认为上面的书单过于初级——没错，它们都是结论型或指南型书籍，没有原理，也没有论证——但这正是对于我这样的非专业者所需要的书籍：我不需要知道这些知识是怎么来的，知道怎么用足矣。</p>

<p>此外，受价值驱动，而非兴趣——大多数情况下兴趣只是把自己脱离当前困境的接口。</p>

<h3>学习型书籍</h3>

<p>学习型书籍是一种元（Meta）方法书籍：这类书籍用于提升学习能力，换句话说，就是缩短吸收知识所需要的时间。</p>

<p>这类书籍我只读过下面的几本，效果有但不明显：</p>

<ul>
<li><a href="http://book.douban.com/subject/2345548/">学习之道</a>：冥想，体会。</li>
<li><a href="http://book.douban.com/subject/1013208/">如何阅读一本书</a>：检视阅读，主题阅读。</li>
<li><a href="http://www.scotthyoung.com/learnmorestudyless/">Learn more, study less</a>：建立知识体系及联系。</li>
</ul>


<p>需要注意的是，不要陷入到寻求最优学习方法的误区——Best is the worthest enemy of better。</p>

<h2>阅读原版？</h2>

<h3>如何在翻译版和原版做选择？</h3>

<ol>
<li>优先选择翻译版。计算机书籍这种描述精确知识的书籍更是如此。</li>
<li>此外，如果阅读中出现难以理解的问题，不要下意识的把其归咎于翻译问题——多数情况是理解问题。</li>
</ol>


<h3>为什么还有那么多人阅读原版？</h3>

<ol>
<li>因为翻译版还没出版。</li>
<li>知识的价值有其时效性。</li>
<li>逼格。</li>
</ol>


<h2>越多越好？</h2>

<p>我经常逛豆瓣，豆瓣有一个很有意思的现象就是人们喜欢去比较自己每年读书的数量，或者是截图炫耀自己读过几千本书云云。</p>

<p>我在这里酸一下：书的数量并没有什么参考价值，就好比无法用盖一栋大楼的砖数评价这栋大楼的质量；换个说法，Effort不等于Progress。</p>

<blockquote><p>关键在于读过书的质量，吸收的程度，以及创造的价值。</p></blockquote>

<p>此外，盲目追求读书的数量会带来另一个问题——浅尝辄止。本应花在专业书籍上的时间被分配到其它无关紧要的事情上，导致该学好的没学好，没必要的学了一滩但用不上。</p>

<h2>总结</h2>

<ol>
<li>形成T型知识结构：专业知识尽可能深入，专业周边知识尽可能精炼。

<ul>
<li>按照引用列表和作者深入阅读专业书籍。</li>
<li>利用结论型/指南型书籍精炼阅读专业周边书籍。</li>
<li>不断强化自己的按需学习能力。</li>
</ul>
</li>
<li>不一定非要阅读原版。</li>
<li>读书并非多多益善。</li>
<li>读书之前回答下面几个问题：

<ul>
<li>这本书能给自己带来什么改变？</li>
<li>自己是否需要这种改变？</li>
<li>如果均为Yes，继续；如果有一个No，砍掉。</li>
</ul>
</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/on-suppressing-the-internet-addiction/">网络上瘾及其解决方法</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-09T17:14:28+00:00" pubdate data-updated="true">Mar 9<span>th</span>, 2014</time>
        
           | <a href="/blog/on-suppressing-the-internet-addiction/#disqus_thread"
             data-disqus-identifier="http://lucida.github.io/blog/on-suppressing-the-internet-addiction/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>网络上瘾及其解决方法</h1>

<h2>症状</h2>

<h3>起床后</h3>

<p>拿起手机，微博->论坛A->论坛B->知乎->人人，大概20分钟。</p>

<h3>工作中</h3>

<p>大概每隔半小时刷一下微博或论坛，点进去看两分钟再切回来。</p>

<h3>睡觉前</h3>

<p>拿起手机，微博->论坛A->论坛B->知乎->人人->草榴（-_-），大概30分钟。</p>

<h2>原因</h2>

<h3>智能手机带来的极其便利的信息可访问性</h3>

<p>平板和智能手机使互联网的可访问性（accessibility）提升了至少两个数量级——三年前我的NOKIA E51只能在WIFI环境下浏览简单的文字信息，而现在我的iPhone5可以无时无刻的阅读/观看互联网上几乎所有的信息，得益于4G，即便是包含大量图片甚至视频的信息也可以轻松阅读。</p>

<h3>碎片化时间不知如何处理</h3>

<p>无论是工作还是学习，都会有疲倦或无聊的时刻，大概10分钟左右。</p>

<p>微博这种碎片化信息的出现正好填补了碎片化时间。但比较恶心的是这种东西会上瘾——慢慢的它会占据越来越多的时间：清晨，睡眠甚至路上和正常阅读的时间。</p>

<h3>长时间从事同一种工作带来的无聊感</h3>

<p>无论多么有激情有兴趣，长时间从事同一种工作总会无聊的，低智力门槛的社交网络就成了一个打发时间的好选择。</p>

<p>然后时间就都耗里面了。-_&ndash;</p>

<h2>现实 V.S. 虚拟</h2>

<p>人是社会性动物，社会性动物通过与其他对象建立联系来确定自己的存在感，也就是交流（Communication），现实和虚拟中都是如此。交流包括一对一交流和一对多交流：现实中，一对一交流通过谈话/电话/信件，一对多交流通过电视/广播；虚拟中，一对一交流通过IM（Instant Messenger），一对多交流通过微博/论坛/博客。</p>

<h3>一对一交流：</h3>

<ol>
<li>现实中，一对一交流通过谈话/电话/信件，一对一交流通过IM（Instant Messenger）。</li>
<li>现实的一对一交流大多无状态——双方的交流同时开始，同时结束。虚拟的一对一交流大多有状态——双方的交流可以从某一方开始，然后若干小时后另一方看到消息回复，然后如此继续。</li>
<li>现实中的一对一交流需要考虑对方的状态——也就是交流需要建立在双方都有时间的基础上；虚拟的一对一交流无需考虑对方的状态，有意交流的一方可以随时给对方发送信息。</li>
</ol>


<p>虚拟带来的问题：</p>

<ol>
<li>任何人都可以与你交流，无论你愿意与否。</li>
<li>你可以与任何人交流，无论是否值得。</li>
<li>可能会陷入一种等待交流的焦虑中。</li>
</ol>


<h3>一对多交流：</h3>

<ol>
<li>现实的一对多交流需要大量人力物力（广播/电视/报纸），虚拟的一对多交流几乎零成本（微博/博客/社交网络）。</li>
<li>现实的一对多交流需要信息审核/证伪，虚拟的一对多交流几乎没有信息审核。</li>
<li>现实的一对多交流中接收方是完全被动的，虚拟的一对多交流接收方和广播方之间可以有交互。</li>
</ol>


<p>虚拟带来的问题：</p>

<ol>
<li>没有审核带来的大量低质量无意义信息（通常会以一种很有趣或是令人热血沸腾的形式出现）。</li>
<li><a href="http://book.douban.com/subject/1012611/">乌合之众</a>，最热门的信息不是最有价值的，而是吵的最响（或是争议最多）的。</li>
<li>与广播方（例如名人）的交流会带来成就感，也会使自己陷入等待回复的焦虑中。</li>
<li>可能会陷入一种不断查看新信息（尽管这些信息毫无意义）的焦虑中。</li>
</ol>


<h2>解决方法</h2>

<p>为此在豆瓣阅读买了一本<a href="http://book.douban.com/subject/24383461/">网络素养</a>，原版：<a href="http://www.amazon.com/Net-Smart-How-Thrive-Online/dp/0262526131/">Net Smart: How to thrive online</a>。</p>

<p><img src="http://img5.douban.com/lpic/s26842036.jpg" title="网络素养" alt="网络素养" /></p>

<p><img src="http://ecx.images-amazon.com/images/I/41LRFD-SVlL._BO2,204,203,200_PIsitb-sticker-arrow-click,TopRight,35,-76_SX385_SY500_CR,0,0,385,500_SH20_OU02_.jpg" title="Net Smart" alt="Net Smart" /></p>

<p>这本书废话极多，关键的两点：控制注意力，鉴别垃圾信息。</p>

<h3>控制注意力</h3>

<ul>
<li>下意识的控制注意力，可以通过关注自己的呼吸来调节。</li>
<li>即便忽略几条微博几条信息，也不会对生活造成多大影响。</li>
<li>此外可以使用冥想提升自己的集中力（Focus）。</li>
<li>番茄工作法（没看明白要点，25分钟休息一次是什么原理，如果这样岂不是更不靠谱）。</li>
</ul>


<h3>鉴别垃圾信息</h3>

<ul>
<li>冷静面对夸张的标题，此类信息一般有意断章取义，或是掩盖上下文。</li>
<li>恰当的使用三点式验证争议信息：使用三个不同可信来源验证信息的有效性。</li>
<li>选取可信/有效/有价值的信息来源，屏蔽哗众取宠/断章取义的信息源。</li>
</ul>


<h3>集中时间处理社交网络</h3>

<ul>
<li>在固定的时间段（例：12:40 &ndash; 13:10, 20:20 &ndash; 21:00）处理社交网络信息，而非随时随地的查看状态。</li>
<li>如有特别需求，可以编写Crawler来发送Reminder邮件，替代人工轮询。</li>
</ul>


<h2>用不上瘾的行为填充碎片化时间</h2>

<p>碎片化时间可以进行其它益智或体育活动，包括但不限于：</p>

<ul>
<li>拆解/还原九连环。</li>
<li>单手还原魔方。</li>
<li>背诵单词。</li>
<li>绘画。</li>
<li>乒乓。</li>
<li>桌球。</li>
</ul>


<h2>尝试其它活动</h2>

<p>为了得到新鲜感，包括但不限于：</p>

<ul>
<li>学习自己感兴趣但不了解的技术（例如ANTLR）或学科（例如经济/心理学）。</li>
<li>尝试集体运动（例如攀岩，射箭）。</li>
<li>尝试旅行（例如在周末去荷兰、芬兰或瑞典进行两日游）。</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/tarqie-a-quantized-continous-growing-approach/">TARQIE——一种量化成长的方法（上）</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-02T23:31:27+00:00" pubdate data-updated="true">Mar 2<span>nd</span>, 2014</time>
        
           | <a href="/blog/tarqie-a-quantized-continous-growing-approach/#disqus_thread"
             data-disqus-identifier="http://lucida.github.io/blog/tarqie-a-quantized-continous-growing-approach/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>TARQIE——一种量化成长的方法（上）</h1>

<h2>问题</h2>

<p>工作到现在大概三个多月，但始终感觉有些不对——没有之前高速成长的感觉，换句话说，就是感觉自己相比三个月之前没有多大进步。</p>

<p>这是一个很危险的讯息——如果三个月还没感受到实质性的成长，那么就相当于倒退，尤其还是在Google这种奇人遍地的公司。</p>

<p>反复思考后发现自己现在掉到几个怪圈里——</p>

<h3>选择瘫痪（Analysis Paralysis）</h3>

<ol>
<li>想做事情A，做了一小半。</li>
<li>想做事情B。</li>
<li>发现事情C也有必要搞。</li>
<li>结果A，B，C都没有搞定。</li>
<li>陷入深深的自责。</li>
<li>回到步骤A。</li>
</ol>


<h3>呆滞沉浸（Dumb Dump）</h3>

<ol>
<li>看着电脑屏幕发呆。</li>
<li>或者不停的刷微博。</li>
<li>或者开始看一部早已经看过的美剧。</li>
<li>或者撸来撸去。</li>
<li>总之就是一种知道不该继续但又停不下来的感觉。-_&ndash;</li>
</ol>


<h3>拖延（Procrastination）</h3>

<ol>
<li>无法持续一件事情。（比如看书或是锻炼）</li>
<li>缺乏行动力，做事之前束手束脚。</li>
</ol>


<h2>分析</h2>

<p>回想自己过去并不是这个样子——不断成长（Continuous Growing）是自己过去几年的关键字，某种上来所自己有一种强迫症，极端的说：</p>

<blockquote><p>如果自己大脑里面一半都是半年以前的东西，那么证明自己这半年什么都没做。</p></blockquote>

<p>但自己现在处于一个更好的环境，没有理由比之前做的差。于是我决定从之前的成功经历里找到答案，试着用简短的关键字回顾自己前10年的几个关键点：</p>

<h3>关键点（Milestones）</h3>

<h4>高考</h4>

<ul>
<li>目标

<ol>
<li>考上一个不错的大学。</li>
</ol>
</li>
<li>量化

<ol>
<li>考到年级60名以内。</li>
<li>或者是班级第一。</li>
</ol>
</li>
<li>改进

<ol>
<li>海量习题练习。</li>
<li>规律作息。</li>
<li>每天至少踢腿二十分钟。</li>
</ol>
</li>
<li>验证

<ol>
<li>月考成绩。</li>
<li>模拟成绩。</li>
</ol>
</li>
</ul>


<h4>考研</h4>

<ul>
<li>目标

<ol>
<li>考上北航计算机系。</li>
</ol>
</li>
<li>量化

<ol>
<li>超过提档线50分。</li>
</ol>
</li>
<li>改进

<ol>
<li>海量习题练习。</li>
<li>规律作息。</li>
<li>禁欲（即停止手淫，保存精力）。</li>
</ol>
</li>
<li>验证

<ol>
<li>前期：监测学习进度。</li>
<li>后期：各种模拟试卷，给自己打分。</li>
</ol>
</li>
</ul>


<h4>找工作</h4>

<ul>
<li>目标

<ol>
<li>找到一个不错的外企工作。</li>
</ol>
</li>
<li>量化

<ol>
<li>解答Top Coder D2L1和D1L2区段的题目。</li>
<li>在纸上流畅写出可运行的算法C代码。</li>
</ol>
</li>
<li>改进

<ol>
<li>每天练习Top Coder一道大题，若干道小题。</li>
<li>用EOP的思路编写纸上代码。</li>
</ol>
</li>
<li>验证

<ol>
<li>找到MS正式员工为自己做模拟面试+评估。</li>
<li>独立解答CareerCup上7成以上的编程题目。</li>
<li>不断拿到新的Offer。</li>
</ol>
</li>
</ul>


<h3>总结</h3>

<p>我惊奇的发现自己找到了一个和《机器学习》里几乎雷同的模型：</p>

<ul>
<li>目标（TARget）：一个清晰的目标。</li>
<li>量化（Quantization）：该目标可以被量化成具体数据。</li>
<li>改进（Improvement）：有一种或几种改进途径不断接近目标。</li>
<li>验证（Evaluation）：有一种或几种验证方法确认（Verify）自己正在接近目标。</li>
</ul>


<p>综合到一起——TARQIE，即标题里这个奇怪的词汇（很高兴这个词压根不存在）。</p>

<h2>应用</h2>

<p>根据自己的现状，对自己的工作和生活（或学习），分别创建对应的Tarqie模型，这里我称其为Tarqie-J（ob）和Tarqie-L（ife）。</p>

<h3>Tarqie-J</h3>

<ul>
<li>目标

<ol>
<li>高效完成Q1 OKR。</li>
</ol>
</li>
<li>量化

<ol>
<li>成功迁移124个Test。</li>
<li>为这些Test配置一个可稳定运行的环境。</li>
</ol>
</li>
<li>改进

<ol>
<li>恬着脸皮向不同的同事请教。</li>
<li>理解当前Test的架构和流程。</li>
<li>阅读The Art Of Unit Test，Guice Book和GuiceBerry Manual，了解如何用Guice写良好的Test。</li>
<li>阅读Java Best Practices和Effective Java。</li>
<li>阅读Java Performance，了解JVM。</li>
</ol>
</li>
<li>验证

<ol>
<li>每周与mentor交流，进行进度控制/难点求助。</li>
<li>Test的数量不断增加。</li>
<li>CL中review的数量持续降低。</li>
<li>逐步理解项目代码背后的机理。</li>
</ol>
</li>
</ul>


<h3>Tarqie-L</h3>

<ul>
<li>目标

<ol>
<li>提高精力，理解Python。</li>
</ol>
</li>
<li>量化

<ol>
<li>精力提高（自然醒，不赖床）。</li>
<li>熟悉Python及其实现。</li>
<li>理解4个开源项目的架构。</li>
</ol>
</li>
<li>改进

<ol>
<li>早睡早起（11:30 PM ~ 8:30 AM）+每天运动20分钟。</li>
<li>阅读相关技术书籍（Python源码剖析，开源项目架构等）。</li>
<li>增强学习能力（阅读《Study Less, Learn More》）</li>
<li>控制手淫频率至两周一次。</li>
</ol>
</li>
<li>验证

<ol>
<li>早睡早起+运动不间断。</li>
<li>学习能力增强（+系统学习能力）。</li>
<li>逐步理解Python各个部分的实现（对象，语句，元组，列表，字典，控制流，异常，自定义类型，列表理解，生成器，模块，从源码了解其机制）。</li>
<li>每周理解1个开源项目的架构。</li>
</ol>
</li>
</ul>


<h2>实验</h2>

<h3>内容</h3>

<p>在接下来的一个月（2014年3月），分别应用Tarqie-J和Tarqie-L到自己的工作和学习中。</p>

<h3>假设</h3>

<ol>
<li>效率比之前提升50%。</li>
<li>掌握两样新技能。</li>
</ol>


<h3>实验开始</h3>

<h2>未完待续</h2>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/memoirs-on-my-postgraduate-life/">从挣钱的角度回忆下自己的研究生三年</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-16T22:08:39+00:00" pubdate data-updated="true">Feb 16<span>th</span>, 2014</time>
        
           | <a href="/blog/memoirs-on-my-postgraduate-life/#disqus_thread"
             data-disqus-identifier="http://lucida.github.io/blog/memoirs-on-my-postgraduate-life/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>2010年9月 &ndash; 2010年12月</h2>

<h3>主要事项</h3>

<ul>
<li>09月：研究生入学。。</li>
<li>10月：认真学习计算机专业基础。</li>
<li>11月：认真学习计算机专业基础。</li>
<li>12月：认真学习计算机专业基础。</li>
</ul>


<h3>收入来源</h3>

<ul>
<li>二等奖学金（￥270/月 * 3）</li>
<li>学校研究生补贴（￥200/月 * 3）</li>
</ul>


<p>总计收入：￥1,410</p>

<h2>2011年1月 &ndash; 2011年12月</h2>

<h3>主要事项</h3>

<ul>
<li>01月：玩iPad。</li>
<li>02月：玩iPad。</li>
<li>03月：糊里糊涂参加了某.NET大师的技术演讲并成为现场口译，得到某司的实习机会和某社的译书机会。</li>
<li>04月：听译某印度大师等访谈，痛不欲生。</li>
<li>05月

<ul>
<li>实习（做Code Coverage Analysis）</li>
<li>由于三周完成了原定三个月的项目，mentor表示你可以看看书调调研啥的，别捣乱就成。</li>
<li>实习（看书）。</li>
</ul>
</li>
<li>06月：实习（看书）。</li>
<li>07月

<ul>
<li>实习（看书）。</li>
<li>完成某js书籍的翻译。</li>
</ul>
</li>
<li>08月：实习（看书）。</li>
<li>09月：实习（看书）。</li>
<li>10月

<ul>
<li>退出实习。</li>
<li>玩iPod Touch。</li>
</ul>
</li>
<li>11月：加入某创业团队。</li>
<li>12月

<ul>
<li>开题，被老板黑出翔。</li>
<li>撤出创业团队。</li>
<li>开始自己编写手机应用，发布上线半月内进入市场排行TOP20。</li>
</ul>
</li>
</ul>


<h3>收入来源</h3>

<ul>
<li>二等奖学金（￥270/月 * 10）</li>
<li>学校研究生补贴（￥200/月 * 7 + ￥300/月 * 3）</li>
<li>某司实习工资（￥4000/月 * 6）</li>
<li>某社翻译图书一本（￥4200）</li>
<li>听译文章两篇（￥2000）</li>
<li>某创业公司兼职（￥4000 * 1）</li>
<li>编写手机应用（￥0）</li>
</ul>


<p>总计收入：￥39,200</p>

<h2>2012年11月 &ndash; 2012年12月</h2>

<h3>主要事项</h3>

<ul>
<li>01月：编写手机应用。</li>
<li>02月

<ul>
<li>重回某司继续实习（这次搞手机应用）。</li>
<li>认识了两位天赋异禀的设计师，学到大量设计知识。</li>
</ul>
</li>
<li>03月

<ul>
<li>实习。</li>
<li>做成第一份手机应用私活A。</li>
<li>教训惨痛，价值10k+的工作量只收了对方900，学会如何计价私活。</li>
<li>开始制作自己的手机应用生产线。</li>
</ul>
</li>
<li>04月

<ul>
<li>实习。</li>
<li>制作某色情应用，当日收入￥600，但次日即被下架。</li>
<li>完成手机应用生产线初版，在市场外试投放。</li>
</ul>
</li>
<li>05月

<ul>
<li>实习。</li>
<li>手机应用生产线搞定。

<ul>
<li>意味着我可以不用写代码，直接生成手机应用。</li>
<li>也就是说我可以毫不费力的一天&#8221;写&#8221;50+个应用。</li>
<li>投放应用到市场，利用数量+广告盈利。</li>
</ul>
</li>
</ul>
</li>
<li>06月

<ul>
<li>实习。</li>
<li>手机应用私活B。</li>
<li>准备小论文。</li>
</ul>
</li>
<li>07月

<ul>
<li>实习。</li>
<li>发表小论文。</li>
</ul>
</li>
<li>08月

<ul>
<li>实习（看书）。</li>
<li>手机应用私活C。</li>
<li>开始找工作。</li>
</ul>
</li>
<li>09月

<ul>
<li>实习（看书）。</li>
<li>找工作。</li>
</ul>
</li>
<li>10月

<ul>
<li>实习（看书）。</li>
<li>找工作。</li>
<li>准备毕设。</li>
</ul>
</li>
<li>11月

<ul>
<li>实习（看书）。</li>
<li>找到工作。</li>
<li>编写毕设项目。</li>
</ul>
</li>
<li>12月

<ul>
<li>退出实习。</li>
<li>毕业答辩。</li>
</ul>
</li>
</ul>


<h3>收入来源</h3>

<ul>
<li>二等奖学金（￥270/月 * 10）</li>
<li>学校研究生补贴（￥300/月 * 10）</li>
<li>某司实习工资（￥4000/月 * 10）</li>
<li>手机应用私活A（￥900）</li>
<li>手机应用私活B（￥12000）</li>
<li>手机应用私活C（￥15000）</li>
<li>个人手机应用（￥4500 * 10 + ￥600）</li>
</ul>


<p>总计收入：￥119,200</p>

<h2>2013年1月 &ndash; 2013年10月</h2>

<h3>主要事项</h3>

<ul>
<li>01月

<ul>
<li>毕业典礼。</li>
<li>重回某司继续实习（本屌就是闲不下来-_-）</li>
</ul>
</li>
<li>02月

<ul>
<li>实习（这次搞平板应用）。</li>
<li>手机应用私活D。</li>
</ul>
</li>
<li>03月

<ul>
<li>毕业。</li>
<li>某司实习转兼职。</li>
</ul>
</li>
<li>04月

<ul>
<li>某司兼职。</li>
<li>平板应用私活A。</li>
</ul>
</li>
<li>05月

<ul>
<li>某司兼职。

<ul>
<li>面试若干人。</li>
</ul>
</li>
</ul>
</li>
<li>06月

<ul>
<li>某司兼职。</li>
<li>平板应用私活B。</li>
<li>手机应用私活E。</li>
</ul>
</li>
<li>07月

<ul>
<li>某司兼职。</li>
</ul>
</li>
<li>08月

<ul>
<li>某司兼职。</li>
</ul>
</li>
<li>09月

<ul>
<li>实习（看书）。</li>
<li>平板应用私活C。</li>
<li>开始练习日常英语。</li>
</ul>
</li>
<li>10月

<ul>
<li>实习（看书）。</li>
<li>为某C++大师义务口译。</li>
</ul>
</li>
<li>11月

<ul>
<li>正式入职！</li>
</ul>
</li>
</ul>


<h3>收入来源</h3>

<ul>
<li>某司实习工资（￥4000/月 * 2）</li>
<li>某司兼职工资（￥7700/月 * 8）</li>
<li>手机应用私活D（￥12000）</li>
<li>手机应用私活E（￥15000）</li>
<li>平板应用私活A（￥12000）</li>
<li>平板应用项目B（￥10000）</li>
<li>平板应用项目C（￥7000）</li>
<li>个人手机应用（￥3500 * 10）</li>
</ul>


<p>总计收入：￥160,600</p>

<p>三年总收入：￥320,410</p>

<h2>消费的东东</h2>

<p>大多都是屌丝货 &ndash;_&ndash; 可以看到电脑，书籍和耳机占据了非常大的比例。</p>

<p>此外还有电影饭局等若干，不过这些不比实物，实在记不清。</p>

<p>至于衣服本屌一直优衣库，因为只有优衣库有价格标签 &ndash;_&ndash;</p>

<p>AKG</p>

<ul>
<li>K26P ￥200</li>
<li>K324P ￥320</li>
<li>K450 ￥550</li>
<li>K518DJ ￥450</li>
<li>K518LE ￥420</li>
</ul>


<p>LENOVO</p>

<ul>
<li>X200 RY7 ￥7200</li>
<li>YOGA i5 3300 ￥6300</li>
</ul>


<p>SONY</p>

<ul>
<li>A806 ￥900</li>
<li>S739F ￥1300</li>
<li>EX310 * 2 ￥200</li>
<li>A866 ￥1100</li>
<li>S755 ￥550</li>
<li>XB910 ￥650</li>
<li>X10 ￥800</li>
</ul>


<p>JVC</p>

<ul>
<li>M55X ￥400</li>
</ul>


<p>僵尸</p>

<ul>
<li>PR2+阻线 ￥500</li>
<li>PR401 ￥400</li>
<li>PR200 ￥220</li>
<li>PR300MKII ￥320</li>
</ul>


<p>Apple</p>

<ul>
<li>Macbook AIR 11 ￥7200</li>
<li>iPod Touch 4 ￥900</li>
<li>iPod Touch 5 ￥2200</li>
<li>iPhone 5 ￥3700</li>
<li>iPhone 5s ￥5100（送女神）</li>
<li>iPad 1 ￥2500</li>
<li>iPad 4 ￥3000</li>
<li>iPad MINI ￥2500</li>
<li>iPad Air ￥4300</li>
<li>Ear Pod * 2 ￥400</li>
</ul>


<p>NOKIA</p>

<ul>
<li>E70 ￥2550</li>
<li>E51 ￥800</li>
<li>E72i ￥1200</li>
<li>Asha 210 ￥520</li>
<li>Lumia 710 ￥0（活动奖品）</li>
<li>Lumia 1520 ￥4100（送老妈）</li>
</ul>


<p>Logitech</p>

<ul>
<li>TF10 ￥1200</li>
<li>UE BOOM ￥1500</li>
</ul>


<p>Monster Beats</p>

<ul>
<li>Studio ￥1800</li>
</ul>


<p>SOL REPUBLIC</p>

<ul>
<li>V8 黑 ￥900</li>
<li>V10 红 ￥1200</li>
</ul>


<p>漫步者</p>

<ul>
<li>M5 * 2 ￥1100</li>
</ul>


<p>Samsung</p>

<ul>
<li>iGH 907 ￥900</li>
</ul>


<p>购买书籍</p>

<ul>
<li>技术书籍 350余本 约￥28,000</li>
<li>非技术书籍 150余本 约￥6,000</li>
</ul>


<p>总计支出：￥106,350</p>

<h2>小结</h2>

<ul>
<li>三年大约收入：￥320,410</li>
<li>三年消费的电子东东及书籍：￥106,350</li>
<li>剩下的基本都花在吃喝玩。</li>
</ul>


<p>感觉这个数字还不错，应该能到中上水平吧。</p>

<p>最后</p>

<h3>一点经验</h3>

<ul>
<li>网上兼职大多是骗子，尤其是遮遮掩掩不肯说自己到底是干啥的。</li>
<li>兼职要和自己专业相关

<ul>
<li>比如，除非你学的教育专业，否则家教就是一个糟糕透顶的选择。</li>
<li>更不用说学计算机的去兼职卖衣服了，尼玛放着月入上万的活不干尼玛是闹哪样！</li>
</ul>
</li>
<li>码农干私活的建议

<ul>
<li>打听好行情，先定好价格，不要因为自己是学生就不好意思加价。</li>
<li>对对方做充分的信用调研。</li>
<li>事前三成，半成品再三成，最后成品再四成，不到最后时刻，不要交代码。</li>
<li>做的东西要超出对方的期望，这样有助于长期合作。</li>
</ul>
</li>
<li>最后，除非你是高富帅，否则追女神既耗精力又耗钱财，有这个时间不如干点实在的，等自己牛逼了再追女神也不迟。</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/new-toys-in-london/">London的新玩具</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-15T21:16:16+00:00" pubdate data-updated="true">Feb 15<span>th</span>, 2014</time>
        
           | <a href="/blog/new-toys-in-london/#disqus_thread"
             data-disqus-identifier="http://lucida.github.io/blog/new-toys-in-london/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Bose Companion 20</h2>

<p>之前一直用<a href="http://www.amazon.com/Ultimate-Ears-Wireless-Bluetooth-Speaker/dp/B00CM0XHNS/">UE Boom</a>，但用久了就感觉声音有些憋屈，考虑到每天至少有一个小时在听音乐，所以搞个不错的印象很有必要。</p>

<p>要求如下：</p>

<ol>
<li>低音带感。</li>
<li>体积小。</li>
<li>外观拉风。</li>
</ol>


<p>Google了几篇Speaker的Review，初步锁定<a href="http://www.amazon.co.uk/Bose-Companion-Series-Multimedia-Speaker/dp/B00CL83JVQ/">Bose Companion2</a>和<a href="http://www.amazon.co.uk/Logitech-980-000659-Z600-Bluetooth-Speakers/dp/B00DUBIZ7G/">Logitech Z600</a>。</p>

<p>不过观察实物时才发现，C2虽然体积合适，但非常丑；Z600虽然外观不错，但比想象的大了一圈。失望之余，意外发现了<a href="http://www.amazon.co.uk/Bose-Companion-Multimedia-Speaker-System/dp/B005EPOFTI/">Bose Companion20</a>。</p>

<p><img src="http://ecx.images-amazon.com/images/I/71RYZKiBvCL._SL1500_.jpg" alt="Bose Companion20" /></p>

<p>金属银的外观和声音都不错，就是价格比预计的多了一倍——199磅，不过还是买了下来，这种天天用的东西有必要好一点。</p>

<h2>IRON GYM+</h2>

<p>为了能够在家做引体向上，所以在Google了一圈Pull up bar，发现最快最稳的方法还是去Decathlon买，于是就从Islington坐Overground去，之后就找到这个<a href="http://www.decathlon.co.uk/iron-gym-chin-up-bar-id_8194140.html">IRON GYM+</a>，正好他们在做活动，20磅买下。</p>

<p><img src="http://www.decathlon.co.uk/media/819/8194140/big_800PX_65269548.jpg" alt="Decathlon IRON GYM+" /></p>

<p>试用了下，还是很结实的，不过现在一个引体向上也做不起来-_&ndash; 不过还好有凳子的辅助。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/about-movie-chinese-dream/">关于中国合伙人</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-11T12:06:29+00:00" pubdate data-updated="true">Jan 11<span>th</span>, 2014</time>
        
           | <a href="/blog/about-movie-chinese-dream/#disqus_thread"
             data-disqus-identifier="http://lucida.github.io/blog/about-movie-chinese-dream/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>About</h2>

<p>之前就想写一篇关于中国合伙人的评论了，为此重新看了一遍，小结下细节和感受。</p>

<h3>色情杂志</h3>

<p>成东青收到孟晓骏寄来的色情杂志仔细研读，如果观察仔细的话会发现成的裤腰带解开，下身膨胀——以至于苏梅回来时惊慌的拿了一本杂志盖在下体上面。</p>

<p><img src="http://imgur.com/nOTfcbu.jpg" title="看黄色杂志被发现" alt="看黄色杂志被发现" /></p>

<h3>转变</h3>

<p>成东青的教学风格从照本宣科昏昏欲睡到妙趣横生引人入胜，发生在他得知自己被学校开除的那一刻，他失去了学校的工作，但得到了学生的尊敬。</p>

<p>之前我认为这一段是影片的一个败笔——一个人怎么可能如此快的从这一个极端走到另一个极端，在这一遍观看时我明白了——成失去学校的铁饭碗，但也卸下了学校的铁担子，成作为大学教师有太多的taboo，以至于只能通过照本宣科的方式教学；而作为私人教师则不需要顾忌那么多传统，可以用自己的方式，提高学生学习的兴趣，<strong>缓解</strong>学生学习的不适。</p>

<p>这也是&#8221;新梦想&#8221;能够在某些方面胜出传统教育的原因——&#8221;新梦想&#8221;通过幽默的语言和夸张的肢体动作缓解学习时的痛苦，使得一些忍耐力低的学生可以持续的学习，所&#8221;新梦想&#8221;可以提高平庸学生的成绩。但&#8221;新梦想&#8221;无法培养出卓越的学生——there is only a hard way to excellence。</p>

<p>任何教育就其本质而言都是填鸭式教育，&#8221;新梦想&#8221;在做的不过是在填鸭时加一点料让这件事不那么痛苦而已，这种事周星星在<strong>国产凌凌漆</strong>早就玩过：</p>

<blockquote><p>&ldquo;古時有關雲長全神貫注捉象棋刮骨療毒，今日有我凌凌漆聚精會神睇鹹帶鑿骨攞彈頭&rdquo;</p></blockquote>

<p><img src="http://i.imgur.com/9ga1qcg.jpg" alt="挖骨取弹头" /></p>

<h3>国营工厂</h3>

<p>将一个新兴的教育企业建立在破败的国营工厂里，这正是90年代的写照——国营工厂的破败，私人企业的兴起，而且有相当的私人企业是发源自破败的国营企业的，比如<a href="http://zh.wikipedia.org/wiki/%E6%B5%B7%E5%B0%94">海尔</a>。</p>

<h3>办公楼与北大</h3>

<p>电影开头王阳在两座未建成的&#8221;新梦想&#8221;办公楼面前讲课，这两座楼其实就是新东方在中关村的两座办公楼，这两座楼屹立在中关村，也就是北大的北面，骄傲的俯视着曾经把自己逐出校园的对方。</p>

<p><img src="http://i.imgur.com/mbsCVVd.jpg" title="新梦想" alt="新梦想" /></p>

<h3>Lucy的离开</h3>

<p>这个细节十分隐晦，Lucy的离开正处在1988年到1993年中间——也就是敏感的<strong>1989</strong>，这一年发生的八八事件使得中国政府在国际社会上的声望一落千丈，将中国与西方国家的关系降到了最低点，一些国内的外国人也由于此次事件离开。</p>

<p>八八事件戳破了国内充满理想的年轻人——尤其是大学生的理想，用残酷的事实告诉他们中国的现状，王阳在Lucy离开剪发剃须痛哭青春破灭不只是因为Lucy，而是因为时代。</p>

<p><img src="http://imgur.com/akYME1S.jpg" title="梦想破灭" alt="梦想破灭" /></p>

<h3>苏梅</h3>

<p>国内上映的中国合伙人有一段被剪辑了——苏梅在对成东青说分手之前是一段和外国人在草地上打炮的戏。</p>

<h3>Bug</h3>

<p>成东青为了反对公司上市将公司股权稀释到每个人身上，孟晓骏愤怒的说</p>

<blockquote><p>资治通鉴，釜底抽薪，绝对的明朝万历年间的事。</p></blockquote>

<p>不过资治通鉴里面哪来的明朝 &ndash;_&ndash;</p>

<h3>小结</h3>

<p>导演很牛逼，可以在不触犯政府敏感地带的前提下将一个跨越80年到05年的影片拍出如此的真实感，而且在商业和声誉上取得双赢，国内恐怕没有几个导演可以做到。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/my-first-article/">第一篇博文</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-05T17:03:00+00:00" pubdate data-updated="true">Jan 5<span>th</span>, 2014</time>
        
           | <a href="/blog/my-first-article/#disqus_thread"
             data-disqus-identifier="http://lucida.github.io/blog/my-first-article/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>为什么要使用Octopress</h2>

<p>之前用过不少博客，其中最长的一个<a href="http://www.cnblogs.com/figure9/">博客园博客</a>用了五年，写了不少文章，也不乏不少关注者，但我始终觉得不太爽：</p>

<ul>
<li>博客园上的文章水平太低：

<ul>
<li>倒不是装x，我并不否认博客园在国内的程序社区的地位，但这仅限于国内，一个首页上充满python入门教程或是常用排序算法的站点更适合初学者。</li>
<li>所以可以理解一些用户在&#8221;成名&#8221;之后反而选择离开。</li>
</ul>
</li>
<li>提供的编辑器不好用，尤其是代码样式难看的一B。</li>
<li>缺乏对站点的控制，尽管有一些主题但可塑性不强，自己想放一些脚本进去也不方便。</li>
<li>缺乏Mobile Readability，无论在我的iPhone 5还是Nexus 5上，精心设计的文章排版都会变成翔。</li>
</ul>


<p>直到前天和<a href="http://contributors.rubyonrails.org/contributors/oscar-del-ben/commits">Oscar</a>打桌球，我提到一直打算做一个独立博客，但由于不清楚uk这边申请域名和空间的流程而一直拖到现在，Oscar很疑惑的说如果只是一个静态博客那么用Github做host不就成了么。</p>

<p>于是这个周末做了下调研，最后目标锁定在<a href="http://octopress.org/">Octopress</a>。</p>

<h3>免费的空间</h3>

<p>Octopress是一个静态博客生成系统，使用<a href="http://jekyllrb.com/">Jekyll</a>生成静态站点，而Jekyll是Github默认的<a href="http://pages.github.com">pages</a>生成系统，因此Octopress生成的静态站点可以很方便的部署到Github Pages上。而Github提供了免费的空间，因此申请空间这步就轻松的跳过了。</p>

<h3>接近完美的样式</h3>

<p>Octopress默认的样式已经很不错，尤其是在<code>code</code>的展现和对<strong>Markdown</strong>的支持上，除此之外对<code>Markdown</code>做了一系列扩展，使得排版更加精致。
下面的代码效果令我十分满意：</p>

<figure class='code'><figcaption><span>Hello world in java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">java</span><span class="o">.</span><span class="na">fun</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Sample</span><span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Hello world!&quot;</span><span class="o">);</span>   
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Mobile Readablity</h3>

<p>无论是在iPad Air，还是在iPhone 5和NEXUS 5上面，Octopress的表现都堪称完美。</p>

<h3>新技术的训练</h3>

<p>很惭愧的承认自己并没有用过git，也没有用过Markdown。以至于Basia在得知我没用过git时十分惊讶</p>

<blockquote><p>How could a programmer never use git before?</p></blockquote>

<p>使用Octopress写博客可以强制自己使用git，此外如果想要对站点做一点tweak，还需要html5+css3+js+ror这一系列web开发前后端的知识，考虑到自己有做full stack developer的打算，用这个博客练手不失为一个好办法。</p>

<h2>接下来会写些什么</h2>

<ul>
<li>读过的书</li>
<li>写的代码</li>
<li>以及在london的生活感受</li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <img src="http://imgur.com/nZXZVhG.png" width="128px" height="128px">
  <p>学生生涯在<a href="http://www.dlut.edu.cn" target="_blank">大工</a>和<a href="http://www.buaa.edu.cn" target="_blank">北航</a>度过；</p>
  <p><a href="http://www.windowsphone.com/zh-cn/store/publishers?publisherId=LucSoft&amp;appId=3e4f73b2-c70e-40dd-b3b8-1d2135e9af56" target="_blank">LucSoft</a>和<a href="http://www.windowsphone.com/zh-cn/store/publishers?publisherId=IdaSoft&amp;appId=7f06890c-60d6-4ec7-880d-24a9dd24a283" target="_blank">IdaSoft</a>的创建者，其下包含<a href="http://www.windowsphone.com/zh-cn/store/app/%E4%B8%AD%E6%96%87%E6%8B%A8%E5%8F%B7%E5%8A%A9%E6%89%8B/3e4f73b2-c70e-40dd-b3b8-1d2135e9af56" target="_blank">拨号助手</a>和<a href="http://www.windowsphone.com/zh-cn/store/app/%E9%87%91%E5%BA%B8%E5%85%A8%E9%9B%86/7f06890c-60d6-4ec7-880d-24a9dd24a283" target="_blank">金庸全集</a>等热门应用；</p>
  <p><a href="http://book.douban.com/people/figure9/" target="_blank">读过的书</a>和<a href="http://book.douban.com/people/figure9/reviews" target="_blank">书评</a>；</p>
  <p>现在就职于<a href="http://www.google.co.uk/about/jobs/locations/london/" target="_blank">Google London</a>；</p>
  <p>本站所有内容均属个人观点，和本人雇主及其他团体无关。</p>
</section><section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/how-to-implement-an-interpreter-in-csharp/">90分钟实现一门编程语言——极简解释器教程</a>
      </li>
    
      <li class="post">
        <a href="/blog/on-reading-books/">如何阅读书籍</a>
      </li>
    
      <li class="post">
        <a href="/blog/on-suppressing-the-internet-addiction/">网络上瘾及其解决方法</a>
      </li>
    
      <li class="post">
        <a href="/blog/tarqie-a-quantized-continous-growing-approach/">TARQIE——一种量化成长的方法（上）</a>
      </li>
    
      <li class="post">
        <a href="/blog/memoirs-on-my-postgraduate-life/">从挣钱的角度回忆下自己的研究生三年</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/学习'>学习 (3)</a></li><li><a href='/blog/categories/影评'>影评 (1)</a></li><li><a href='/blog/categories/技术'>技术 (2)</a></li><li><a href='/blog/categories/程序设计'>程序设计 (1)</a></li><li><a href='/blog/categories/阅读'>阅读 (1)</a></li><li><a href='/blog/categories/随笔'>随笔 (7)</a></li></ul>
</section>
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Lucida -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'lucida';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
