<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Lucida]]></title>
  <link href="http://lucida.github.io/atom.xml" rel="self"/>
  <link href="http://lucida.github.io/"/>
  <updated>2014-05-04T22:02:00+01:00</updated>
  <id>http://lucida.github.io/</id>
  <author>
    <name><![CDATA[Lucida]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[我的算法学习之路]]></title>
    <link href="http://lucida.github.io/blog/on-learning-algorithms/"/>
    <updated>2014-05-04T21:43:42+01:00</updated>
    <id>http://lucida.github.io/blog/on-learning-algorithms</id>
    <content type="html"><![CDATA[<h1>我的算法学习之路</h1>

<h2>关于</h2>

<p>严格来说，本文题目应该是<strong>我的数据结构和算法学习之路</strong>，但这个写法实在太绕口——况且CS中的算法往往暗指数据结构和算法（例如<strong>算法导论</strong>指的实际上是<strong>数据结构和算法导论</strong>），所以我认为本文题目是合理的。</p>

<p>原文链接：<a href="http://zh.lucida.me/blog/on-learning-algorithms/">http://zh.lucida.me/blog/on-learning-algorithms/</a></p>

<p>原文作者：<a href="http://zh.lucida.me/">Lucida</a></p>

<h3>这篇文章讲了什么？</h3>

<ul>
<li>我这些年学习数据结构和算法的总结。</li>
<li>一些不错的算法书籍和教程。</li>
<li>算法的重要性。</li>
</ul>


<h2>初学</h2>

<p>第一次接触数据结构是在大二下学期的数据结构课程。然而这门课程并没有让我入门——当时自己正忙于倒卖各种MP3和耳机，对于这些课程根本就不屑一顾——反正最后考试划个重点也能过，于是这门整个计算机专业本科最重要的课程就被傻逼的我直接忽略过去了。</p>

<p>直到大三我才反应过来以后还要找工作——而且大二的折腾证明了我并没有什么商业才能，以后还是得靠码代码混饭吃，我当时惊恐的发现自己对编程序几乎一无所知，于是我给自己制订了一个类似于建国初期五年计划的读书成长计划，其中包括C语言基础、数据结构以及计算机网络等方面的书籍。</p>

<p>读书计划的第一步是选择书籍，我曾向当时我觉得很牛的&#8221;学长&#8221;和&#8221;大神&#8221;请教应该读哪些算法书籍，&#8221;学长&#8221;们均推荐算法导论，还有几个&#8221;大神&#8221;推荐计算机程序设计艺术（现在我疑心他们是否翻过这些书），草草的翻了下这两本书发现实在看不懂，但幸运的是我在无意中发现了<a href="http://www.douban.com/">豆瓣</a>这个神奇的网站，里面有很多质量不错的书评，于是我就把评价很高而且看上去不那么吓人的计算机书籍都买了下来——事实证明豆瓣要比这些&#8221;学长&#8221;或是&#8221;大神&#8221;靠谱的多得多。</p>

<h3>数据结构与算法分析——C语言描述</h3>

<p><img src="http://img3.douban.com/lpic/s1106991.jpg" alt="数据结构与算法分析——C语言描述" /></p>

<p><a href="http://book.douban.com/subject/1139426/">数据结构与算法分析——C语言描述</a>是我学习数据结构的第一本书：当时有很多地方看不懂，于是做记号反复看；代码看不明白，于是抄到本子上反复研读；一些算法想不通，就把它所有的中间状态全画出来然后反复推演。事实证明尽管这种学习方法看起来傻逼而且效率很低，但对于当时同样傻逼的我却效果不错——傻人用傻办法嘛，而且这本书的课后题大多都是经典的面试题目，以至于日后我看到<a href="http://book.douban.com/subject/3004255/">编程之美</a>的第一反应就是这货的题目不全是抄别人的么。</p>

<p>至今记得，这本书为了说明算法是多么重要，在开篇就拿最大子序列和作为例子，一路把复杂度从O(N<sup>3</sup>)杀到O(N<sup>2</sup>)再到O(NlgN)最后到O(N)，当时内心真的是景仰之情=如滔滔江水连绵不绝，尼玛为何可以这么屌，</p>

<p>此外，我当时还把这本书里图算法之前的数据结构全手打了一遍，后来找实习还颇为自得的把这件事放到简历里，现在想想真是傻逼无极限。</p>

<p>凭借这个读书成长计划中学到的知识，我总算比较顺利的找到了一份实习工作，这是后话。</p>

<h2>入门</h2>

<p>我的实习并没有用到什么算法（现在看来就是不停的堆砌已有的API，编写一堆自己都不知道对不对的代码而已），在发现身边的人工作了几年却还在和我做同样的事情之后，我开始越来越不安。尽管当时我对自己没什么规划，但我清楚这绝壁不是我想做的工作。</p>

<h3>微软的梦工厂</h3>

<p><img src="http://img3.douban.com/lpic/s3322643.jpg" alt="微软的梦工厂" /></p>

<p>在这个摇摆不定的时刻，<a href="http://book.douban.com/subject/3238803/">微软的梦工场</a>成了压倒骆驼的最后一支稻草，这本书对微软亚洲研究院的描写让我下定了&#8221;找工作就要这样的公司&#8221;的决心，然而我又悲观的发现无论是以我当时的能力还是文凭，都无法达到微软亚研院的要求，矛盾之下，我彻底推翻了自己&#8221;毕业就工作&#8221;的想法，辞掉实习，准备考研。</p>

<p>考研的细节无需赘述，但至今仍清楚的记得自己在复试时惊奇且激动的发现北航宿舍对面就是微软西格玛大厦，那种离理想又进了一步的感觉简直爽到爆。</p>

<h3>算法设计与分析</h3>

<p>我的研究生生涯绝对是一个反面典型——翘课，实习，写水论文，做水研究，但有一点我颇为自得——从头到尾认真听了韩军教授的算法设计与分析课程。</p>

<p>韩军给我印象最深的有两点：课堂休息时跑到外面和几个学生借火抽烟；讲解算法时的犀利和毫不含糊。</p>

<p><img src="http://img3.douban.com/lpic/s2019521.jpg" alt="算法设计与分析基础" /></p>

<p>尽管韩军从来没有主动提及，但我敢肯定<a href="http://book.douban.com/subject/1968704/">算法设计与分析基础</a>就是他算法课程事实上的（de-facto）教材，因为他的课程结构几乎和这本书的组织结构一模一样。</p>

<p>如果<a href="http://book.douban.com/subject/1139426/">数据结构与算法分析——C语言描述</a>是我的数据结构启蒙，那么韩军的课程和<a href="http://book.douban.com/subject/1968704/">算法设计与分析基础</a>就是我的算法启蒙，结合课程和书籍，我一一理解并掌握了复杂度分析、分治、减治、变治、动态规划和回溯这些简单但强大的算法工具。</p>

<h3>算法引论</h3>

<p><img src="http://img5.douban.com/lpic/s4230097.jpg" alt="算法引论" /></p>

<p><a href="http://book.douban.com/subject/4178907/">算法引论</a>是我这时无意中读到的另一本算法书，和普通的算法书不同，这本书从创造性的角度出发——如果说算法导论讲的是有哪些算法，那么算法引论讲的就是如何创造算法。结合前面的<a href="http://img3.douban.com/lpic/s2019521.jpg">算法设计与分析基础</a>，这本书把我能解决的算法问题数量扩大了一个数量级。</p>

<p>之后，在机缘巧合下，我进入微软亚洲工程院实习，离理想又近了一步，自我感觉无限牛逼。</p>

<h2>巩固</h2>

<p>在微软工程院的实习是我研究生阶段的一个非常非常非常重要的转折点：</p>

<ol>
<li>做出了一个还说的过去的小项目。</li>
<li>期间百度实习面试受挫，痛定思痛之下阅读了大量的程序设计书。</li>
<li>微软的实习经历成为了我之后简历上为数不多的亮点之一（本屌一没成绩，二没论文，三没ACM）。</li>
</ol>


<p>这里就不说1和3了（和本文题目不搭边），重点说说2。</p>

<p>由于当时组内没有特别多的项目，我负责的那一小块又提前搞定了，mentor便很慷慨的扔给我一个Kinect和一部Windows Phone让我研究，研究嘛，自然就没有什么deadline，于是我就很鸡贼的把时间三七开：七分倒腾Windows Phone，三分看书&amp;经典论文。</p>

<p>然而一件事打断了这段安逸的生活——</p>

<h3>百度实习面试</h3>

<p>基友在人人发百度实习内推贴，当时自我感觉牛逼闪闪放光芒，于是就抱着看看国内IT环境+虐虐面试官的变态心理投了简历，结果在第一面就自己的师兄爆出翔：他让我写一个<code>stof</code>（字符串转浮点数），我磨磨唧唧半天也没写出完整实现，之后回到宿舍赶快写了一个版本发到师兄的邮箱，结果对方压根没鸟我。</p>

<p>这件事对我产生了很大的震动——</p>

<ul>
<li>原来自己连百度实习面试都过不去。</li>
<li>原来自己还是一个编程弱逼。</li>
<li>原来自己还是一个算法菜逼。</li>
</ul>


<p>痛定思痛，我开始了第二个&#8221;五年计划&#8221;，三七开的时间分配变成了七三开：七分看书，三分WP。而这一阶段的重点从原理（Principle）变成了实现（Implementation）——Talk is cheap, show me the code.</p>

<h3>Elements of Programming</h3>

<p><img src="http://img5.douban.com/lpic/s4243636.jpg" alt="Elements of Programming" /></p>

<p>由于一直觉得名字里带&#8221;Elements of&#8221;的都是酷炫叼炸天的书，所以我几乎是毫不犹豫的买了这本<a href="http://book.douban.com/subject/3802826/">Elements of Programming</a>，事实上这本书里的代码（或者说STL的代码）确实是：快，狠，准，古龙高手三要素全齐。</p>

<h3>C Interfaces and Implementation</h3>

<p><img src="http://img5.douban.com/lpic/s1686769.jpg" alt="C Interfaces and Implementation" /></p>

<p>百度面试被爆出翔的经历让我意识到另一个问题，绝大多数公司面试时都需要在纸上写C代码，而我自己却很少用C（多数情况用C#），考虑到自己还没牛逼到能让公司改变面试流程的地步，我需要提升自己编写C代码的能力（哪怕只是为了面试）。一顿Google之后，我锁定了<a href="http://book.douban.com/subject/1826292/">C Interfaces and Implementation</a>——另一本关于如何写出狂炫酷帅叼炸天的C代码的奇书，这里套用下Amazon的<a href="http://www.amazon.com/review/RMXKDJNH8UOPU/">评论</a>：Probably the best advanced C book in existance。</p>

<p>严格来说上面两本书都不是传统的算法书，因为它们侧重的都不是算法，而是经典算法的具体实现（Implementation），然而这正是我所需要的：因为算法的原理我能说明白，但要给出优雅正确简练的实现我就傻逼了，哪怕是<code>stof</code>这种简单到爆的&#8221;算法&#8221;。</p>

<p>依然是以前的傻逼学习方法：反复研读+一遍又一遍的把代码抄写到本子上，艰难的完成了这两本书后，又读了相当数量的编程实践（Programming Practice）书籍，自我感觉编程能力又大幅提升，此外获得新技能——<strong>纸上编码</strong>。这也成为了我之后找工作面试的三板斧之一。</p>

<h2>应用</h2>

<p>说老实话，自从本科实习之后，我就一直觉得算法除了面试时能用用，其它基本用不上，甚至还写了一篇当时颇为自得现在读起来极为傻逼的<a href="http://book.douban.com/review/3733680/">文章</a>来黑那些动不动就&#8221;基础&#8221;或&#8221;内功&#8221;的所谓&#8221;大牛&#8221;们，这里摘取一段现在看起来很傻逼但当时却觉得是真理的文字：</p>

<blockquote><p>所以那些动则就扯什么算法啊基础啊内功啊所谓的大牛们，请闭上你的嘴，条条大道通罗马。算法并不是编程的前提条件，数学也不会阻碍一个人成为优秀的程序员。至少在我看来，什么算法基础内功都是唬人的玩意，多编点能用的实用的程序才是王道，当然如果你是一个pure theorist的话就当我什么都没说好了。</p></blockquote>

<p>然而有意思的是，写了这篇<a href="http://book.douban.com/review/3733680/">文章</a>没多久，鼓吹算法无用论的我自己做的几个大大小小的项目全部用到了算法——我疑心是上天在有意抽我的脸。</p>

<h3>LL(k)</h3>

<p>我在微软实习的第一个项目做的是<a href="http://zh.wikipedia.org/wiki/%E4%BB%A3%E7%A2%BC%E8%A6%86%E8%93%8B">代码覆盖率</a>分析——计算T-SQL存储过程的代码覆盖率。</p>

<p>简单的看了下SQL Server相关的文档，我很快发现SQL Reporting Service可以记录T-SQL的执行语句及行号，于是行覆盖（line coverage）搞定，但老大说行覆盖太naive，我们需要更实际的块覆盖（block coverage）。</p>

<p>阅读了块覆盖的定义后，我发现我需要对T-SQL进行语法分析，在没有找到一个好用的T-SQL Parser的情况下，只能自己动手搞一个：</p>

<p><img src="http://img5.douban.com/lpic/s24921197.jpg" alt="Language Implementation Patterns" /></p>

<p>比较奇诡的是，做这个项目时当时我刚好把<a href="http://www.antlr.org/">ANTLR</a>作者的<a href="http://book.douban.com/subject/4030327/">Language Implementation Patterns</a>看了一半，什么LL(k)啊Packrat啊AST Walker的概念啊正热乎着呢。</p>

<p>于是，自己自己就照着T-SQL的官方EBNF，三下五除二撸了一个T-SQL存储过程的LL(k) Parser，把代码转换成AST，然后用一个External AST Walker生成代码块覆盖的HTML报表，全部过程一周不到。</p>

<p>老大自然是很满意——我疑心他的原计划是花两三个月来完成这个项目，因为这个项目之后的两个月我都没什么活干，天天悠哉游哉。</p>

<h3>拼音索引</h3>

<p>拼音索引是我接的一个手机应用私活里的小模块，用户期待在手机文本框可以根据输入给出智能提示：</p>

<p>比如说输入中国：</p>

<p><img src="http://i.imgur.com/tjKjyzN.png" alt="智能提示" /></p>

<p>同样，输入拼音也应给出提示：</p>

<p><img src="http://i.imgur.com/zTjEBik.png" alt="智能提示" /></p>

<p>中文匹配这个简单，但拼音匹配就得花时间想想了——懒得造轮子的我第一时间找到了微软的拼音库，但接下来我就发现微软这个鸟库在手机上跑不动，研究了下发现WP7对Dictionary的items数量有限制，貌似是7000还是8000个item就会崩盘，而标准汉字则有两万多个，尼玛。</p>

<p>痛骂MS坑爹+汉字坑爹之余，还是得自己撸一个库出来：</p>

<ol>
<li>首先把那两万个汉字搞了出来，排序，然后弄成一个超长的字符串。</li>
<li>接下来用<code>Int16</code>索引了汉字所有的拼音（貌似500多个）。</li>
<li>再接下来用<code>Int64</code>建立汉字和拼音的关联——汉字有多音字，所以需要把多个拼音pack到一个<code>Int64</code>里，这个简单，位操作就搞定。</li>
<li>最后用二分+位移Unpack，直接做到从汉字到拼音的检索。</li>
<li>后来小测了下性能，速度是MS原来那个库的五十倍有余，而代码量只有336行。</li>
</ol>


<p>用户很happy——因为我捎带把他没想到的多音字都搞定了，而且流畅的一逼。</p>

<p>我也很happy，因为没想到自己写的库居然比MS的还要快几十倍，同时小十几倍。</p>

<p>从这个事情之后我变得特别理解那些造轮子的人——你要想想，<strong>如果你需要一个飞机轮子但市场上只有自行车轮子而且老板还催着你交工，你能怎么搞</strong>。</p>

<h3>快速字符串匹配</h3>

<p>前面提到在微软实习时老大扔给我一个Windows Phone让我研究下，我当时玩了玩就觉着不太对劲，找联系人太麻烦。</p>

<p>比如说找&#8221;张晓明&#8221;，WP只支持定位到Z分类下——这意味着我需要在Z分类下的七十多个联系人（姓张的姓赵的姓钟的等等）里面线性寻找，每次我都需要滑动四五秒才能找到这个张姓少年。</p>

<p><img src="http://i.imgur.com/R3JalOH.jpg" alt="E51" /></p>

<p>这TMD也太傻逼了，本屌三年前的老破NOKIA都支持首字母定位，996->ZXM->张晓明，直接搞定，尼玛一个新时代Windows Phone居然会弱到这个程度。</p>

<p>搜了一下发现没有好用的拨号程序，于是本屌就直接撸了一个支持首字母匹配的拨号程序出来扔到WP论坛里。</p>

<p>结果马上就有各种问题出现——最主要的反映是速度太慢，一些用户甚至反馈按键有时要半秒才有反应。本屌问了下他的通讯录大小：大概3000多人。</p>

<p><img src="http://i.imgur.com/Pfff0e9.jpg" alt="Cry" /></p>

<p>吐槽怎么会有这么奇葩的通讯录之余，我意识到自己的字符串匹配算法存在严重的性能问题：读取所有人的姓名计算出拼音，然后一个个的匹配——结果如果联系人数量太多的话，速度必然拙计。</p>

<p>于是我就开始苦思冥想有没有一个能够同时搜索多个字符串的高端算法，以至于那两天坐地铁都在嘟囔怎么才能把这个应用搞的快一些。</p>

<p><img src="http://img3.douban.com/lpic/s8978030.jpg" alt="Algorithms on Strings, Trees and Sequences" /></p>

<p>最终还是在<a href="http://book.douban.com/subject/1765938/">Algorithms on Strings, Trees and Sequences</a>里找到了答案——确实有能够同时搜索多个字符串的方法：Tries，而且这本书还用足足一章来讲怎么弄Multiple string comparison，看得我当时高潮迭起，直呼过瘾。</p>

<p>具体细节不多说，总之换了算法之后，匹配速度快了大约九十多倍，而且代码还短了几十行。哪怕是有10000个联系人，也能在0.1秒内搞定，速度瓶颈就这样愉快的被算法搞定。</p>

<h3>Writing Efficient Programs</h3>

<p>之后又做了若干个项目，多多少少都用到了&#8221;自制&#8221;的算法或数据结构，最奇诡的一次是写一个电子书阅读器里的分页，我照着模拟退火（Simulated Annealing）的原理写了一个快速分页算法，事实上这个算法确实很快——但问题是我都不知道为啥它会这么快。</p>

<p>总之，算法是一种<strong>将有限计算资源发挥到极致</strong>的武器，当计算资源很富余时算法确实没大用，但一旦到了效率瓶颈算法绝壁是开山第一刀（因为算法不要钱嘛！要不还得换CPU买SSD升级RAM，肉疼啊！！）。一些人会认为这种说法是有问题，因为编写新算法的人力成本有时比增加硬件的成本还要高——但别忘了增加硬件提升效率也是建立在算法是Scalable的基础上——说白了还是得撸算法。</p>

<p><img src="http://img3.douban.com/lpic/s3780111.jpg" alt="Writing Efficient Programs" /></p>

<p>说到优化这里顺带提一下<a href="http://book.douban.com/subject/1768600/">Writing Efficient Programs</a>——很难找到一本讲代码优化的书（我疑心是自从Knuth说了<strong>过早优化是万恶之源</strong>之后没人敢写，万恶之源嘛，写它干毛），注意这本书讲的是代码优化——在不改变架构、算法以及硬件的前提之下进行的优化。尽管书中的一些诸如变量复用或是循环展开的trick已经过时，但总体仍不失为一本好书。</p>

<h2>提高</h2>

<p>实习实习着就到了研二暑假，接下来就是求职季。</p>

<p>求职季时我有一种莫名的复仇感——尼玛之前百度实习面试老子被你们黑的漫天飞翔，这回求职老子要把你们一个个黑回来，尼玛。</p>

<p>现在回想当时的心理实属傻逼+幼稚，但这种黑暗心理也起了一定的积极作用：我丝毫不敢有任何怠慢，以至于在5月份底我就开始准备求职笔试面试，比身边的同学早了两个月不止。</p>

<p>我没有像身边的同学那般刷题——而是继续看书抄代码学算法，因为我认为那些难得离谱的题面试官也不会问——事实上也是如此。</p>

<h3>Algorithm Design Manual</h3>

<p><img src="http://img3.douban.com/lpic/s10347625.jpg" alt="Algorithm Design Manual" /></p>

<p>因为很多Coding Interview的论坛都提到这本<a href="http://book.douban.com/subject/3072383/">红皮书</a>，我也跟风搞了一本。事实证明，仅仅是关于Backtrack Template那部分的描述就足以值回书价，更不用说它的Heuristics和课后题。</p>

<h3>编程珠玑&amp;更多的编程珠玑</h3>

<p><img src="http://img3.douban.com/lpic/s2712842.jpg" alt="Programming Pearls" /></p>

<p><img src="http://img3.douban.com/lpic/s7073511.jpg" alt="More Programming Pearls" /></p>

<p>这两本书就不用多介绍，<a href="http://book.douban.com/subject/1484451/">编程珠玑</a>和<a href="http://book.douban.com/subject/1944826/">更多的编程珠玑</a>，没听说过这两本书请自行面壁。前者偏算法理论，后者偏算法轶事，前者提升能力，后者增长谈资，都值得一读。</p>

<h3>The Science of Programming</h3>

<p><img src="http://img5.douban.com/lpic/s2812798.jpg" alt="The Science of Programming" /></p>

<p>读到<a href="http://book.douban.com/subject/1484451/">编程珠玑</a>里面关于Binary Search的正确性证明时我大呼过瘾，原来程序的正确性也是可以推导的，然后我就在那一章的引用里发现David Gries的<a href="http://book.douban.com/subject/2350559/">The Science of Programming</a>。看名字就觉得很厉害，直接搞了一本开撸。</p>

<p>不愧为<a href="http://book.douban.com/subject/1484451/">编程珠玑</a>引用的书籍，撸完<a href="http://book.douban.com/subject/2350559/">The Science of Programming</a>之后，本屌获得了<strong>证明简单代码段的正确性</strong>这个技能——求职面试三板斧之二。</p>

<p><strong>证明简单代码段的正确性</strong>是一个很神奇的技能——因为面试时大多数公司都会要求在纸上写一段代码，然后面试官检查这段代码，如果你能够自己证明自己写的代码是正确的，面试官还能挑剔什么呢？</p>

<p>之后就是各种面试，详情见之前的<a href="http://www.cnblogs.com/figure9/archive/2013/01/09/2853649.html">博客</a>，总之就是<strong>项目经历</strong>、<strong>纸上代码</strong>加<strong>正确性证明</strong>这三板斧，摧枯拉朽。</p>

<h2>进化</h2>

<p>求职毕业季之后就是各种Happy，Happy过后本屌发现即将面临另一个问题：算法能力不足。</p>

<p>因为据说以后的同事大多是ACM选手，而本屌从来没搞过算法竞赛，而且知道的算法和数据结构都极为基础：像那些元胞自动机、斐波那契堆或是线段树这些高端数据结构压根只是能把它们的英文名称<strong>拼写</strong>出来，连用都没用过，所以心理忐忑的一逼。</p>

<p>为了不至于到时入职被鄙视的太惨烈，加上自己一贯的算法自卑症，本屌强制自己再次学习算法：</p>

<h3>Algorithms 4th</h3>

<p><img src="http://img5.douban.com/lpic/s8938479.jpg" alt="Algorithms" /></p>

<p><a href="http://book.douban.com/subject/10432347/">Algorithms</a>是我重温算法的第一本书，尽管它实际就是一本<a href="http://book.douban.com/review/5348372/">数据结构的入门书</a>，但它确实适合当时已经快把算法忘光的本屌——不为学习，只为重温。</p>

<p>这本书最大的亮点在于它把Visualization和Formatting做到了极致——也许它不是最好的数据结构入门书，但它绝壁是我读过的排版最好的书，阅读体验爽的一逼；当然这本书的内容也不错，尤其是红黑树那一部分，我想不会有什么书会比此书讲的更明白。</p>

<h3>6.851 Advanced Data Structures</h3>

<p><img src="http://courses.csail.mit.edu/6.851/spring12/illus.png" alt="Advanced Data Structures" /></p>

<p><a href="http://courses.csail.mit.edu/6.851/">Advanced Data Structures</a>是MIT的高级数据结构教程，为什么会找到这个教程呢？因为Google <strong>Advanced Data Structures</strong>第一个出来的就是这货。</p>

<p>这门课包含各种让本屌世界观崩坏的奇诡数据结构和算法，它们包括但不限于：</p>

<ul>
<li>带&#8221;记忆&#8221;的数据结构（Data Structure with Persistence）。</li>
<li>van Mode Boas（逆天的插入，删除，前驱和后继时间复杂度）。</li>
<li>o(1)时间复杂度的的LCA、RMQ和LA解法。</li>
<li>奇幻的o(n)时间复杂度的Suffix Tree构建方法。</li>
<li>o(lglgn)的BST。</li>
<li>&hellip;</li>
</ul>


<p>总之高潮迭起，分分高能，唯一的不足就是没有把它们实现一圈。以后本屌一定找时间把它们一个个撸一遍。</p>

<h2>总结</h2>

<p>从接触算法到现在，大概七年：初学时推崇算法牛逼论，实习后鼓吹算法无用论，读研后再被现实打回算法牛逼论。</p>

<p>怎么这么像辩证法里的肯定到否定再到否定之否定。</p>

<p>现在来看，相当数量的鼓吹算法牛逼论的人其实不懂算法的重要性——如果你连用算法解决<strong>实际</strong>问题的经历都没有，那你如何可以证明算法很有用？而绝大多数鼓吹算法无用论的人不过是低水平码农的无病呻吟——他们从未碰到过需要用算法解决的难题，自然不知道算法有多重要。</p>

<p><a href="http://norvig.com/">Peter Norvig</a>曾经写过一篇非常精彩的<a href="http://www.amazon.com/review/R403HR4VL71K8/">SICP书评</a>，我认为这里把SICP换成算法依然适用：</p>

<blockquote><p>To use an analogy, if algorithms were about automobiles, it would be for the person who wants to know how cars work, how they are built, and how one might design fuel-efficient, safe, reliable vehicles for the 21st century. The people who hate algorithms are the ones who just want to know how to drive their car on the highway, just like everyone else.</p></blockquote>

<p>MIT教授<a href="http://erikdemaine.org/">Erik Demaine</a>则更为直接：</p>

<blockquote><p>If you want to become a good programmer, you can spend 10 years programming, or spend 2 years programming and learning algorithms.</p></blockquote>

<p>总而言之，如果你想成为一个码农或是熟练工（Code Monkey），你大可以不学算法，因为算法对你确实没有用；但如果你想成为一个优秀的开发者（Developer），扎实的算法必不可少，因为你会不断的掉进一些只能借助算法才能爬出去的坑里。</p>

<p>以上。</p>

<p>By <a href="http://zh.lucida.me">Lucida</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[学习&使用技术的四种层次]]></title>
    <link href="http://lucida.github.io/blog/levels-on-learning-and-using-technologies/"/>
    <updated>2014-04-13T01:53:21+01:00</updated>
    <id>http://lucida.github.io/blog/levels-on-learning-and-using-technologies</id>
    <content type="html"><![CDATA[<h1>学习&amp;使用技术的四种层次</h1>

<h2>关键字</h2>

<p>技术，生活，反思。</p>

<p>本文链接：<a href="http://zh.lucida.me/blog/levels-on-learning-and-using-technologies/">http://zh.lucida.me/blog/levels-on-learning-and-using-technologies/</a></p>

<h2>关于</h2>

<p>Bjarne Stroustrup在他的新书《<a href="http://www.amazon.co.uk/Tour-C--Depth/dp/0321958314/">A tour of C++</a>》</p>

<p><img src="http://i.imgur.com/VlQ7ROA.jpg" alt="A tour of C++" style="max-height: 370px;"/></p>

<p>里面举了一个旅行的例子来比喻初学编程语言：</p>

<blockquote><p>&hellip;as an analogy, think of a short sightseeing tour of a city, such as Copenhagen or New York. In just a few hours, you are given a quick peek at the major attractions, told a few background stories, and usually given some suggestions what to see next&hellip;</p>

<p>&hellip;you do not know the city after such a tour. You do not understand all you have seen and heard. You do not know how to navigate the formal and informal rules that govern life in the city&hellip;</p>

<p>&hellip;to really know a city, you have to live in it, often for years.</p></blockquote>

<p>简而言之，编程语言是City，而开发者则是Traveller——这是一个很有意思的比喻，在这篇文章里，我试图<strong>延续</strong>这个类比（Analogy）——把这个类比放大到初学，掌握，了解以至精通一门技术的层面。</p>

<p>不过需要注意：我自己并没有精通哪一门技术——所以这篇文章的内容是值得怀疑（susceptible）的，但它可以作为一个不错的参考。</p>

<h2>0. Stranger（陌生人）</h2>

<p>使用一项技术最初的层次就是听说过没用过——就像我们之中的大多数人都听过南极，听过北极，知道南极有企鹅，北极有北极熊，但是却从来没有去过南极或北极。</p>

<p>Stranger具有以下的特征：</p>

<ul>
<li>知道这项技术的名字。</li>
<li>知道这项技术的一些术语。</li>
<li>知道这项技术的一些关键人物的名字。</li>
<li>了解少量技术的细节，但没有使用这项技术的实际经验。</li>
</ul>


<p>以我本人和RoR来打个比方：</p>

<ul>
<li>知道RoR是Ruby on Rails。</li>
<li>知道Rails，Gem和Rake的存在。</li>
<li>知道DHH也知道松本行弘。</li>
<li>看过<a href="http://www.amazon.co.uk/Ruby-Programming-Language-David-Flanagan/dp/0596516177/">The Ruby Programming Language</a>，还使用一个基于RoR的博客框架<a href="http://octopress.org/">Octopress</a>写博客。</li>
<li>但从来没有使用RoR去搭建网站。</li>
</ul>


<p>所以我是一个RoR的Stranger。</p>

<p>对于新技术，绝大多数人都是Stranger——但是就我对国内技术社区的观察，相当数量的Stranger意识不到自己还是Stranger——认为知道一点术语一些人名就算了解一门技术，甚至把它写在简历上（Familiar with XXX）或是开始与别人进行讨论（当然都是毫无意义的讨论）。</p>

<h2>1. Tourist（旅行者）</h2>

<p>当开发者真正开始用一项技术作出了可以用的东西：</p>

<ul>
<li>面向用户的产品（End-User-Oriented Product），比如一个手机应用，或是一个浏览器插件。</li>
<li>或是面向程序员的工具（Programmer-Oriented Tools），比如一个页面抓取框架，或一个简单的Parser Generator。</li>
<li>注意教科书范例（Textbook examples）和Hello world不属于可以用的东西——这些只是Dead Code——被执行一两次，然后被遗忘。</li>
</ul>


<p>这时这个开发者就进入到了Tourist阶段：</p>

<ul>
<li>了解这项技术的基本元素。</li>
<li>使用这项技术做出了实用的产品或工具。</li>
<li>了解对这项技术的部分细节。</li>
</ul>


<p>根据的学习目的的不同，Tourist又可以分为Salesman和Sightseer。</p>

<h3>1.1. Salesman（旅行商）</h3>

<p><img src="http://i.imgur.com/k5oucJ5.jpg" alt="Salesman" style="max-height: 370px;"/></p>

<p>Salesman是具有明确目的的Tourist——他们学习技术的目标是为了完成某一项业务，就像旅行商去某地出差是为了卖商品而非观光一样。</p>

<p>绝大多数职业开发者在开发生涯中都会扮演Salesman这个角色——接到一个任务，涉及到某项不熟悉的技术，需要在限定时间内完成。</p>

<h3>1.2. Sightseer（观光者）</h3>

<p><img src="http://i.imgur.com/RpYoDXc.gif" alt="Sightseer" style="max-height: 370px;"/></p>

<p>和Salesman相反，Sightseer学习技术的目标是为了拓展视野，增加见识，而非完成某项特定业务。</p>

<p>具有主动学习精神的开发者在业余时会时常扮演Sightseer角色——找到自己认为有价值的新技术或是基础知识进行系统学习，从而拓宽视野，提高水平。</p>

<h2>2. Resident（居住者）</h2>

<p>如果一个旅行者在一个地方待了半年以上，那么他/她就会变得原来越像当地人。随着Tourist对某项技术的日益精进，他/她会逐渐演变成这项技术的Resident：</p>

<ul>
<li>熟悉这项技术的基本元素。</li>
<li>熟悉这项技术的生态系统（Ecology）：既包括开发工具（编辑器，命令行工具，集成开发环境等），也包括开发社区（讨论组，邮件列表等）。</li>
<li>了解这项技术能做什么，不能做什么。</li>
<li>了解这项技术有那些坑，如何绕过这些坑，以及识别这些坑带来的问题。</li>
<li>对某些领域有深入的研究——但并不受限于特定领域。</li>
<li>使用这项技术做出了有相当价值的产品或工具。</li>
</ul>


<p>同Tourist一样，根据使用技术的目标不同，Resident可以分为Worker和Craftsman：</p>

<h2>2.1. Worker（工人）</h2>

<p><img src="http://i.imgur.com/jGNNrQp.jpg" alt="Worker" style="max-height: 370px;"/></p>

<p>技术是Worker的谋生手段，一个优秀的Worker应具备以下特征：</p>

<ul>
<li>对于给定问题，知道如何给出经济有效的解决方案。</li>
<li>以团队合作为主，了解团队合作的价值，能够推动团队项目健康前进。</li>
<li>追求按时交付。</li>
</ul>


<h3>2.2. Craftsman（工匠）</h3>

<p><img src="http://i.imgur.com/9RRUjmb.jpg" alt="Craftsman" style="max-height: 370px;"/></p>

<p>同Worker不同，技术并非Craftsman的谋生手段，而是某种“副业”——用来提升声望，修炼开发水平。</p>

<p>一个优秀的Craftman往往具备以下特点：</p>

<ul>
<li>对于给定问题，知道如何给出优雅的解决方案。</li>
<li>以单兵作战为主，主要靠个人推进项目，但也能进行一定程度的团队合作。</li>
<li>追求极致美感。</li>
</ul>


<h2>3. Architect（架构者）</h2>

<p>有想法且有能力的人在一个地方待久了都会有将这个地方变的更好的冲动——一种方式是从源头出发，推翻旧制度建立新社会，也就是革命；另一种方式则是保留现有的制度，对其进行温和但持续的改进，也就是改良。</p>

<p>技术也是如此，任何技术都跟不上开发者成长的脚步，当这种差距到达一定程度时，就会有卓越的开发者站出来，创造出新的技术，他们就是Architect：</p>

<ul>
<li>熟悉多项互相关联的技术，并了解他们的优势和不足。</li>
<li>具备强大的领导能力，深厚的基础和大量实际开发经验。</li>
<li>能够带动整个技术的生态系统发展。</li>
<li>好吧，我编不下去了（尼玛我要都知道我还至于是IT苦屌么 &ndash;_-）</li>
</ul>


<p>如果你看过<a href="http://movie.douban.com/subject/1304141/">Matrix 2: Reloaded</a></p>

<p><img src="http://i.imgur.com/EDyNv4F.jpg" alt="Matrix 2: Reloaded" style="max-height: 370px;"/></p>

<p>就会知道Architect这个词放在这里再好不过。</p>

<p>根据目标不同，Architect分为Reformist和Revolutionist。</p>

<h3>3.1. Reformist（改良者）</h3>

<p><img src="http://i.imgur.com/xp2SzWu.jpg" alt="Reformist" style="max-height: 370px;"/></p>

<p>改良者的目标：<strong>把现有技术变的更好</strong>。（<strong>Makes</strong> existing technology better）</p>

<p>例如：</p>

<ul>
<li>GoF总结<a href="http://en.wikipedia.org/wiki/Design_Patterns">Design Pattern</a>。</li>
<li><a href="http://en.wikipedia.org/wiki/John_Resig">John Resig</a>创造<a href="http://en.wikipedia.org/wiki/Jquery">jQuery</a>。</li>
<li><a href="http://en.wikipedia.org/wiki/Anders_Hejlsberg">Anders Hejlsberg</a>为C#引入<a href="http://en.wikipedia.org/wiki/LINQ">LINQ</a>。</li>
</ul>


<h3>3.2. Revolutionist（革命者）</h3>

<p><img src="http://i.imgur.com/cpmjDCC.jpg" alt="Revolutionist" style="max-height: 370px;"/></p>

<p>革命者的目标：<strong>用更好的技术取代现有技术</strong>。（<strong>Replaces</strong> existing technology with better one）</p>

<p>例如：</p>

<ul>
<li><a href="http://en.wikipedia.org/wiki/Alan_kay">Alan Kay</a>把细胞的概念引入软件开发]进而创造出<a href="http://en.wikipedia.org/wiki/Object-oriented_programming">OOP</a>的核心概念。</li>
<li><a href="http://en.wikipedia.org/wiki/Donald_Knuth">Don Knuth</a>对计算机算法（<a href="http://en.wikipedia.org/wiki/The_Art_of_Computer_Programming">TAOCP</a>）以及计算机排版（TEX）的贡献。</li>
<li>iPhone于2010年之前的任何手机（iPhone4除外）。</li>
</ul>


<h2>小结</h2>

<p>这篇文章利用<a href="http://www.amazon.co.uk/Tour-C--Depth/dp/0321958314/">A Tour of C++</a>里的隐喻，把学习/使用技术分成了四个层次七个头衔：Stranger，Tourist（Salesman，Sightseer），Resident（Worker，Craftsman），Architect（Reformist，Revolutionist），然后给出了各个头衔所应具备的特征和能力。</p>

<h3>关于同类文章</h3>

<p>之前也有类似的文章，例如<a href="http://blog.itpub.net/6517/viewspace-611506/">程序员的十层境界</a>和<a href="http://blog.csdn.net/happydeer/article/details/8107560">开发者的八种境界</a></p>

<p>这些文章的共同点：</p>

<ol>
<li>看似很牛逼但回想一下啥都没说。</li>
<li>不会给人带来什么价值。</li>
<li>没有一个鉴别的标准。</li>
<li>没有指导性，也没有使用价值。</li>
</ol>


<h3>本文的应用场景</h3>

<h4>考察状态</h4>

<p>以我自己对编程语言的掌握为例：</p>

<ul>
<li>C/C++: Stranger.</li>
<li>Python: Craftsman.</li>
<li>Java: Worker.</li>
<li>C#: Craftsman.</li>
<li>JavaScript: Sightseer.</li>
<li>Scheme: Sightseer</li>
</ul>


<p>将上面的列表转置：</p>

<ul>
<li>Stranger: C/C++</li>
<li>Sightseer: JavaScript, Scheme</li>
<li>Worker: Java</li>
<li>Craftsman: C#, Python</li>
</ul>


<p>结合这些头衔的定义，一目了然。</p>

<h4>制定计划</h4>

<p>运用本文的词汇，可以进行非常精炼的计划制定：</p>

<ul>
<li>例如 Make a thoroughly <strong>sightseeing</strong> of <strong>C++</strong>；</li>
<li>或是 Become a proficient <strong>worker</strong> on <strong>IntelliJ</strong>；</li>
<li>抑或 Take a short <strong>tour</strong> of <strong>Sublime Text</strong>。</li>
</ul>


<p>以上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[三月小结（暨TARQIE——一种量化成长的方法（下））]]></title>
    <link href="http://lucida.github.io/blog/summary-of-march-2014/"/>
    <updated>2014-04-06T23:24:33+01:00</updated>
    <id>http://lucida.github.io/blog/summary-of-march-2014</id>
    <content type="html"><![CDATA[<h1>三月小结（暨TARQIE——一种量化成长的方法（下））</h1>

<h2>目标实际完成情况</h2>

<h3>Tarqie-J</h3>

<ol>
<li>目标

<ul>
<li>高效完成Q1 OKR。 &ndash;> 1.0

<ul>
<li>搞定，超出Manager和Mentor的预期。</li>
</ul>
</li>
</ul>
</li>
<li>量化

<ul>
<li>成功迁移124个Test。 &ndash;> 1.0

<ul>
<li>搞定，并且构建了持续测试环境。</li>
</ul>
</li>
<li>为这些Test配置一个可稳定运行的环境。 &ndash;> 0.8

<ul>
<li>基本搞定，但仍存在少量（每天1~2次）的不稳定状况。</li>
</ul>
</li>
</ul>
</li>
<li>改进

<ul>
<li>恬着脸皮向不同的同事请教。 &ndash;> 1.0

<ul>
<li>达成——基本每个同事都被我骚扰了一遍 &ndash;_&ndash;</li>
</ul>
</li>
<li>理解当前Test的架构和流程。 &ndash;> 1.0

<ul>
<li>重建测试框架的过程中了解</li>
</ul>
</li>
<li>阅读The Art Of Unit Test，Guice Book和GuiceBerry Manual，了解如何用Guice写良好的Test。 &ndash;> 0.7

<ul>
<li>部分完成，阅读Google Guice Book，了解了Guice运作机制。</li>
</ul>
</li>
<li>阅读Java Best Practices和Effective Java。 &ndash;> 0.8

<ul>
<li>部分完成，重新阅读了JBP，但Effective Java只看了一多半。</li>
</ul>
</li>
<li>阅读Java Performance，了解JVM。 &ndash;> 0.7

<ul>
<li>部分完成，阅读了国产的<a href="http://book.douban.com/subject/24722612/">《深入理解Java虚拟机》</a>，了解Java内存管理/回收，字节码生成等内容。</li>
</ul>
</li>
</ul>
</li>
<li>验证

<ul>
<li>每周与mentor交流，进行进度控制/难点求助。 &ndash;> 0.6

<ul>
<li>由于mentor结婚度蜜月所以没有达成。</li>
</ul>
</li>
<li>Test的数量不断增加。 &ndash;> 1.0

<ul>
<li>达成——事实上全部搞定。</li>
</ul>
</li>
<li>CL中review的数量持续降低。 &ndash;> 1.0

<ul>
<li>搞定，成功的从每次提交代码20余个review降至小于6个。</li>
</ul>
</li>
<li>逐步理解项目代码背后的机理。 &ndash;> 0.6

<ul>
<li>部分搞定，对项目测试框架已经相当了解了（毕竟自己重新搭建了整个框架），但对整个项目的各个模块，交互流程还是一头雾水。</li>
</ul>
</li>
</ul>
</li>
</ol>


<p>综上所述，得分 0.85</p>

<h3>Tarqie-L</h3>

<ol>
<li>目标

<ul>
<li>提高精力，理解Python。 &ndash;> 0.8

<ul>
<li>精力小有提高，至于Python——实现机制不太了解，但Python语法和编程风格我现在有足够自信——毕竟写了一个程序解析合法的Python然后生成同等语义的Google风格的Python，再加上身边有一个Python Readability Reviewer，说自己现在达到中级Python开发者的水准应该不为过。</li>
</ul>
</li>
</ul>
</li>
<li>量化

<ul>
<li>精力提高（自然醒，不赖床）。 &ndash;> 0.6

<ul>
<li>自然醒但依然赖床——-_&ndash;</li>
</ul>
</li>
<li>熟悉Python及其实现。 &ndash;> 0.8

<ul>
<li>部分搞定，见上文。</li>
</ul>
</li>
<li>理解4个开源项目的架构。 &ndash;> 1.0

<ul>
<li>搞定，见下文。</li>
</ul>
</li>
</ul>
</li>
<li>改进

<ul>
<li>早睡早起（11:30 PM ~ 8:30 AM）+每天运动20分钟。 &ndash;> 0.7

<ul>
<li>早睡早起没做到，运动的频率两周一次。</li>
</ul>
</li>
<li>阅读相关技术书籍（Python源码剖析，开源项目架构等）。 &ndash;> 0.6

<ul>
<li>部分完成，Python源码剖析只读了第一章，但开源项目架构每周一篇。</li>
</ul>
</li>
<li>增强学习能力（阅读《Study Less, Learn More》） &ndash;> 1.0

<ul>
<li>完成。</li>
</ul>
</li>
<li>控制手淫频率至两周一次。 &ndash;> 1.0 &ndash;_&ndash;

<ul>
<li>完成。</li>
</ul>
</li>
</ul>
</li>
<li>验证

<ul>
<li>早睡早起+运动不间断。 &ndash;> 0.5

<ul>
<li>搞定一半。两天运动一次。</li>
</ul>
</li>
<li>学习能力增强（+系统学习能力）。 &ndash;> 1.0

<ul>
<li>部分做到，但很难验证——不过用十天搞出了另外一个家伙搞了5个月的东西应该能说明部分问题。</li>
</ul>
</li>
<li>逐步理解Python各个部分的实现（对象，语句，元组，列表，字典，控制流，异常，自定义类型，列表理解，生成器，模块，从源码了解其机制）。 &ndash;> 1.0

<ul>
<li>没有阅读代码，但完成了一个Python Formatter——把Python代码转换成AST再转换回等语义的<a href="http://google-styleguide.googlecode.com/svn/trunk/pyguide.html">Google Python Style</a>代码。</li>
</ul>
</li>
<li>每周理解1个开源项目的架构。 &ndash;> 1.0

<ul>
<li>完成——阅读了<a href="http://aosabook.org/en/bash.html">Bash</a>, <a href="http://aosabook.org/en/selenium.html">Selenium WebDriver</a>, <a href="http://aosabook.org/en/posa/high-performance-networking-in-chrome.html">Chrome</a>和<a href="http://aosabook.org/en/posa/parsing-xml-at-the-speed-of-light.html">puginxml</a>。</li>
</ul>
</li>
</ul>
</li>
</ol>


<p>综上所述，得分 0.8</p>

<h3>成就</h3>

<h4>工作</h4>

<ol>
<li>构建新的测试环境并迁移原有的测试用例。

<ul>
<li>各种神坑，Team/MailList/Group/ReadTheFuckingSource。</li>
<li>manager一度问我是否需要support——想了想还是撑下来了，还好搞定了。</li>
<li>神奇的发现自己第一次实习时做的也是migration，尼玛难道是轮回？</li>
</ul>
</li>
<li>利用业余时间构建了pyfmt——基于AST的代码格式化工具，生成符合<a href="http://google-styleguide.googlecode.com/svn/trunk/pyguide.html">Google Python Style</a>的等语义代码。

<ul>
<li>速度是公司工具的6倍到50倍不等（已验证）。</li>
<li>速度是<a href="https://github.com/hhatto/autopep8">autopep8</a>的3倍到30倍（已验证）。</li>
<li>生成的代码质量基本等同（待验证）。</li>
<li>代码量是<a href="https://github.com/hhatto/autopep8">autopep8</a>的二分之一。</li>
<li>不依赖任何第三方库。</li>
<li>不使用任何正则表达式——Never send a regex to do a parser&rsquo;s job.</li>
</ul>
</li>
</ol>


<h4>生活</h4>

<ol>
<li>重新实现了自己两年前写的Lucida。

<ul>
<li>重新设计类型系统，进行尾递归优化。然后完成<a href="http://zh.lucida.me/blog/how-to-implement-an-interpreter-in-csharp/">《90分钟实现一门编程语言——极简解释器教程》</a>，写作之余想通了之前很多迷惑的地方。</li>
<li>功能基本等同，代码量是前一版的八分之一，运行速度是前一版的270倍（倒不是这一版效率有多高，主要是前一版写的太挫了）</li>
</ul>
</li>
<li><a href="http://zh.lucida.me/blog/on-reading-books/">《如何阅读书籍》</a>和<a href="http://zh.lucida.me/blog/on-suppressing-the-internet-addiction/">《网络上瘾及其解决方法》</a>两篇议论型博客。</li>
<li>完整的完成一个引体向上。</li>
</ol>


<h3>阅读列表</h3>

<ul>
<li><a href="http://book.douban.com/subject/3814402/">The Quick Python Book</a></li>
<li><a href="http://book.douban.com/subject/25710862/">Getting Started with Google Guava</a></li>
<li><a href="http://book.douban.com/subject/24722612/">深入理解Java虚拟机：JVM高级特性与最佳实践</a></li>
<li><a href="http://book.douban.com/subject/24383461/">网络素养</a></li>
<li><a href="http://book.douban.com/subject/25783654/">如何高效学习</a></li>
<li><a href="http://book.douban.com/subject/3009235/">Google Guice</a></li>
<li><a href="http://aosabook.org/en/index.html">The Architecture of Open Source Applications</a></li>
</ul>


<h3>一些体会</h3>

<ol>
<li>慢读慎写——读书不是靠页数，代码不是拼行数。</li>
<li>精益求精——严肃认真对待自己的任何一个项目/作品，每一行代码，每一个细节都应有其意义。</li>
<li>Don&rsquo;t <a href="http://en.wikipedia.org/wiki/Satisfice">satisfice</a>—— 在时间充裕的情况下，尽力寻找最优解，而不是找到一个答案就满足。</li>
<li>Have a mentor/coach——无论学习什么，身边要有一个大师级人物，不要盲目相信自学能力——坑大多都是自己挖出来的。</li>
<li>在合适的抽象层工作（Working at a proper abstraction layer），包括下面几点：

<ul>
<li>找到与目标最契合的层次：

<ul>
<li>如果层级过高就会造成性能损失和功能缺失。</li>
<li>如果层次过低就会变成重造轮子。</li>
</ul>
</li>
<li>总是在同一个层次工作——以避免上下文切换。</li>
<li>将复杂度封装到各自对应的层次——以避免进行交互——<a href="http://en.wikipedia.org/wiki/Law_of_Demeter">Law of Demeter</a></li>
</ul>
</li>
</ol>


<h3>发现的问题</h3>

<ol>
<li>3月目标制定的过于宏大——尽管完成度不错，但代价也很大——工作时间从每天8小时增加到10小时，到了后期的阅读时间几乎被缩减到零，接下来会相应的缩小计划目标。</li>
<li>除了工作就是学习，导致略抑郁——尽管做出的东西带来了一点成就感。总之接下来需要更多的娱乐。</li>
<li>猛然反应过来所谓的TARQIE其实就是OKR（<a href="http://en.wikipedia.org/wiki/OKR">Objective-Key-Results</a>）——所以接下来直接使用<a href="http://en.wikipedia.org/wiki/OKR">OKR</a>制定计划，更加简洁。</li>
</ol>


<h3>4月计划</h3>

<h3>OKR-J</h3>

<ul>
<li>目标

<ol>
<li>完整迁移测试到原项目中。</li>
<li>稳定+推广pyfmt。</li>
</ol>
</li>
<li>关键结果

<ol>
<li>成功迁移124个Test到原项目。</li>
<li>将测试的不稳定性控制在每天3次以下。</li>
<li>pyfmt通过Python Readability。</li>
<li>pyfmt有10个以上的用户。</li>
<li>pyfmt从experimental进入devtools（略激进，但值得一试）。</li>
</ol>
</li>
</ul>


<h3>OKR-L</h3>

<ul>
<li>目标

<ol>
<li>正常作息，提高精力。</li>
<li>结合pyfmt，深度理解Python。</li>
<li>加深对Java &amp; JVM的理解。</li>
</ol>
</li>
<li>关键结果

<ol>
<li>理解Python各个部分的实现，从源码了解其机制。</li>
<li>阅读并理解两个以上的开源项目架构。</li>
<li>完成<a href="http://book.douban.com/subject/24722612/">深入理解Java虚拟机：JVM高级特性与最佳实践</a>，阅读<a href="http://www.amazon.co.uk/Java-Performance-Addison-Wesley-Charlie-Hunt/dp/0137142528/">《Java Performance》</a>至50%。</li>
<li>迁移测试的同时完成<a href="http://www.amazon.co.uk/Effective-Unit-Testing-guide-developers/dp/1935182579/">Effective Unit Testing: A guide for Java developers</a>的阅读。</li>
<li>早睡<em>晚</em>起（8:40 ~ 23:50）</li>
<li>控制手淫频率至两周一次。</li>
<li>至少两天一次20分钟的运动。</li>
</ol>
</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[90分钟实现一门编程语言——极简解释器教程]]></title>
    <link href="http://lucida.github.io/blog/how-to-implement-an-interpreter-in-csharp/"/>
    <updated>2014-03-23T19:08:35+00:00</updated>
    <id>http://lucida.github.io/blog/how-to-implement-an-interpreter-in-csharp</id>
    <content type="html"><![CDATA[<h1>90分钟实现一门编程语言——极简解释器教程</h1>

<h2>关键字</h2>

<p>解释器, C#, Scheme, 函数式编程</p>

<p>本文链接：<a href="http://zh.lucida.me/blog/how-to-implement-an-interpreter-in-csharp/">http://zh.lucida.me/blog/how-to-implement-an-interpreter-in-csharp/</a></p>

<h2>关于</h2>

<p>本文介绍了如何使用C#实现一个简化Scheme——iScheme及其解释器。</p>

<p>如果你对下面的内容感兴趣：</p>

<ul>
<li>实现基本的词法分析，语法分析并生成抽象语法树。</li>
<li>实现嵌套作用域和函数调用。</li>
<li>解释器的基本原理。</li>
<li>以及一些C#编程技巧。</li>
</ul>


<p>那么请继续阅读。</p>

<p>如果你对以下内容感兴趣：</p>

<ul>
<li>高级的词法/语法分析技术。</li>
<li>类型推导/分析。</li>
<li>目标代码优化。</li>
</ul>


<p>本文则过于初级，你可以跳过本文，但欢迎指出本文的错误 :&ndash;)</p>

<h2>代码样例</h2>

<figure class='code'><figcaption><span>代码示例</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">a</span> <span class="p">+</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="n">Add</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">)</span>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="m">7</span>
</span><span class='line'>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="n">Add</span><span class="p">(</span><span class="m">5</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="m">10</span>
</span></code></pre></td></tr></table></div></figure>


<p>这段代码定义了<code>Add</code>函数，接下来的<code>&gt;&gt;</code>符号表示对<code>Add(3, 4)</code>进行求值，再下一行的<code>&gt;&gt; 7</code>表示上一行的求值结果，不同的求值用换行分开。可以把这里的<code>&gt;&gt;</code>理解成控制台提示符（即Terminal中的PS）。</p>

<h2>什么是解释器</h2>

<p><img src="http://i.imgur.com/C8lxHfr.jpg" alt="解释器图示" /></p>

<p><a href="http://zh.wikipedia.org/wiki/%E8%A7%A3%E9%87%8A%E5%99%A8">解释器</a>（Interpreter）是一种程序，能够读入程序并直接输出结果，如上图。相对于<a href="http://zh.wikipedia.org/wiki/%E7%BC%96%E8%AF%91%E5%99%A8">编译器</a>（Compiler），<a href="http://zh.wikipedia.org/wiki/%E8%A7%A3%E9%87%8A%E5%99%A8">解释器</a>并不会生成目标机器代码，而是直接运行源程序，简单来说：</p>

<blockquote><p><a href="http://zh.wikipedia.org/wiki/%E8%A7%A3%E9%87%8A%E5%99%A8">解释器</a>是运行程序的程序。</p></blockquote>

<p>计算器就是一个典型的解释器，我们把数学公式（源程序）给它，它通过运行它内部的&#8221;解释器&#8221;给我们答案。</p>

<p><img src="http://i.imgur.com/FC1nqko.jpg" alt="CASIO 计算器" /></p>

<h2>iScheme编程语言</h2>

<p>iScheme是什么？</p>

<ul>
<li>Scheme语言的一个极简子集。</li>
<li>虽然小，但变量，算术|比较|逻辑运算，列表，函数和递归这些编程语言元素一应俱全。</li>
<li>非常非常慢——可以说它只是为演示本文的概念而存在。</li>
</ul>


<p>OK，那么Scheme是什么？</p>

<ul>
<li>一种函数式程序设计语言。</li>
<li>一种Lisp方言。</li>
<li>麻省理工学院程序设计入门课程使用的语言（参见<a href="http://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-001-structure-and-interpretation-of-computer-programs-spring-2005/">MIT 6.001</a>和《<a href="http://book.douban.com/subject/1148282/">计算机程序的构造与解释</a>》）。</li>
</ul>


<p><img src="http://i.imgur.com/66TdRMD.jpg" alt="计算机程序的构造与解释" /></p>

<ul>
<li>使用<a href="http://zh.wikipedia.org/wiki/%E6%B3%A2%E5%85%B0%E8%A1%A8%E7%A4%BA%E6%B3%95">波兰表达式</a>（Polish Notation）。</li>
<li>更多的介绍参见<a href="http://zh.wikipedia.org/wiki/Scheme">Scheme编程语言</a>。</li>
</ul>


<p>以计算阶乘为例：</p>

<figure class='code'><figcaption><span>C#版阶乘</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">Factorial</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="m">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">n</span> <span class="p">*</span> <span class="n">Factorial</span><span class="p">(</span><span class="n">n</span> <span class="p">-</span> <span class="m">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>iScheme版阶乘</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">factorial</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">n</span><span class="p">)</span> <span class="p">(</span>
</span><span class='line'>    <span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">n</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>       <span class="mi">1</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">* </span><span class="nv">n</span> <span class="p">(</span><span class="nf">factorial</span> <span class="p">(</span><span class="nb">- </span><span class="nv">n</span> <span class="mi">1</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>


<h3>数值类型</h3>

<p>由于iScheme只是一个用于演示的语言，所以目前只提供对整数的支持。iScheme使用C#的<code>Int64</code>类型作为其内部的数值表示方法。</p>

<h3>定义变量</h3>

<figure class='code'><figcaption><span>iScheme使用`def`关键字定义变量</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">def</span> <span class="nv">a</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">3</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="nv">a</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">3</span>
</span></code></pre></td></tr></table></div></figure>


<h3>算术|逻辑|比较操作</h3>

<p>与常见的编程语言（C#, Java, C++, C）不同，Scheme使用<a href="http://zh.wikipedia.org/wiki/%E6%B3%A2%E5%85%B0%E8%A1%A8%E7%A4%BA%E6%B3%95">波兰表达式</a>，即前缀表示法。例如：</p>

<figure class='code'><figcaption><span>C#中的算术|逻辑|比较操作</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// Arithmetic ops</span>
</span><span class='line'><span class="n">a</span> <span class="p">+</span> <span class="n">b</span> <span class="p">*</span> <span class="n">c</span>
</span><span class='line'><span class="n">a</span> <span class="p">/</span> <span class="p">(</span><span class="n">b</span> <span class="p">+</span> <span class="n">c</span> <span class="p">+</span> <span class="n">d</span><span class="p">)</span>
</span><span class='line'><span class="c1">// Logical ops</span>
</span><span class='line'><span class="p">(</span><span class="n">cond1</span> <span class="p">&amp;&amp;</span> <span class="n">cond2</span><span class="p">)</span> <span class="p">||</span> <span class="n">cond3</span>
</span><span class='line'><span class="c1">// Comparing ops</span>
</span><span class='line'><span class="n">a</span> <span class="p">==</span> <span class="n">b</span>
</span><span class='line'><span class="m">1</span> <span class="p">&lt;</span> <span class="n">a</span> <span class="p">&amp;&amp;</span> <span class="n">a</span> <span class="p">&lt;</span> <span class="m">3</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>对应的iScheme代码</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="c1">; Arithmetic ops</span>
</span><span class='line'><span class="p">(</span><span class="nb">+ </span><span class="nv">a</span> <span class="p">(</span><span class="nb">* </span><span class="nv">b</span> <span class="nv">c</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="nb">/ </span><span class="nv">a</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">b</span> <span class="nv">c</span> <span class="nv">d</span><span class="p">))</span>
</span><span class='line'><span class="c1">; Logical ops</span>
</span><span class='line'><span class="p">(</span><span class="k">or </span><span class="p">(</span><span class="k">and </span><span class="nv">cond1</span> <span class="nv">cond2</span><span class="p">)</span> <span class="nv">cond3</span><span class="p">)</span>
</span><span class='line'><span class="c1">; Comparing ops</span>
</span><span class='line'><span class="p">(</span><span class="nb">= </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nb">&lt; </span><span class="mi">1</span> <span class="nv">a</span> <span class="mi">3</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>需要注意的几点：</p>

<ol>
<li>iScheme中的操作符可以接受不止两个参数——这在一定程度上控制了括号的数量。</li>
<li>iScheme逻辑操作使用<code>and</code>, <code>or</code>和<code>not</code>代替了常见的<code>&amp;&amp;</code>, <code>||</code>和<code>!</code>——这在一定程度上增强了程序的可读性。</li>
</ol>


<h3>顺序语句</h3>

<p>iScheme使用<code>begin</code>关键字标识顺序语句，并以最后一条语句的值作为返回结果。以求两个数的平均值为例：</p>

<figure class='code'><figcaption><span>C#的顺序语句</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">int</span> <span class="n">a</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">b</span> <span class="p">=</span> <span class="m">5</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">c</span> <span class="p">=</span> <span class="p">(</span><span class="n">a</span> <span class="p">+</span> <span class="n">b</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>iScheme的顺序语句</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">c</span> <span class="p">(</span><span class="nf">begin</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">def</span> <span class="nv">a</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">def</span> <span class="nv">b</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">/ </span><span class="p">(</span><span class="nb">+ </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="mi">2</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<h3>控制流操作</h3>

<p>iScheme中的控制流操作只包含<code>if</code>。</p>

<figure class='code'><figcaption><span>if语句示例</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="k">define </span><span class="nv">a</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="mi">3</span> <span class="mi">2</span><span class="p">)</span> <span class="mi">1</span> <span class="mi">2</span><span class="p">))</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="nv">a</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<h3>列表类型</h3>

<p>iScheme使用<code>list</code>关键字定义列表，并提供<code>first</code>关键字获取列表的第一个元素；提供<code>rest</code>关键字获取列表除第一个元素外的元素。</p>

<figure class='code'><figcaption><span>iScheme的列表示例</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="k">define </span><span class="nv">alist</span> <span class="p">(</span><span class="nb">list </span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">))</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nb">list </span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">first</span> <span class="nv">alist</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">rest</span> <span class="nv">alist</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>定义函数</h3>

<p>iScheme使用<code>func</code>关键字定义函数：</p>

<figure class='code'><figcaption><span>iScheme的函数定义</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">square</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">x</span> <span class="nv">x</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">sum_square</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">a</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">square</span> <span class="nv">a</span><span class="p">)</span> <span class="p">(</span><span class="nf">square</span> <span class="nv">b</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>对应的C#代码</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">Square</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">x</span> <span class="p">*</span> <span class="n">x</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">SumSquare</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">Square</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">+</span> <span class="n">Square</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>递归</h3>

<p>由于iScheme中没有<code>for</code>或<code>while</code>这种命令式语言（Imperative Programming Language）的循环结构，递归成了重复操作的唯一选择。</p>

<p>以计算最大公约数为例：</p>

<figure class='code'><figcaption><span>iScheme计算最大公约数</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">gcd</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">a</span> <span class="nv">b</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">b</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">a</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">b</span> <span class="p">(</span><span class="nf">%</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>对应的C#代码</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="kt">int</span> <span class="nf">GCD</span> <span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">GCD</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="p">%</span> <span class="n">b</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>高阶函数</h3>

<p>和Scheme一样，函数在iScheme中是头等对象，这意味着：</p>

<ul>
<li>可以定义一个变量为函数。</li>
<li>函数可以接受一个函数作为参数。</li>
<li>函数返回一个函数。</li>
</ul>


<figure class='code'><figcaption><span>iScheme的高阶函数示例</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="c1">; Defines a multiply function.</span>
</span><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">mul</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">a</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)))</span>
</span><span class='line'><span class="c1">; Defines a list map function.</span>
</span><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">map</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">f</span> <span class="nv">alist</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">empty?</span> <span class="nv">alist</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">list </span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">append </span><span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nf">f</span> <span class="p">(</span><span class="nf">first</span> <span class="nv">alist</span><span class="p">)))</span> <span class="p">(</span><span class="nb">map </span><span class="nv">f</span> <span class="p">(</span><span class="nf">rest</span> <span class="nv">alist</span><span class="p">)))</span>
</span><span class='line'>        <span class="p">)))</span>
</span><span class='line'><span class="c1">; Doubles a list using map and mul.</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="nf">mul</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="nb">list </span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nb">list </span><span class="mi">2</span> <span class="mi">4</span> <span class="mi">6</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>小结</h3>

<p>对iScheme的介绍就到这里——事实上这就是iScheme的所有元素，会不会太简单了？ &ndash;_&ndash;</p>

<p>接下来进入正题——从头开始构造iScheme的解释程序。</p>

<h2>解释器构造</h2>

<p>iScheme解释器主要分为两部分，解析（Parse）和求值（Evaluation）：</p>

<ul>
<li>解析（Parse）：解析源程序，并生成解释器可以理解的中间（Intermediate）结构。这部分包含词法分析，语法分析，语义分析，生成语法树。</li>
<li>求值（Evaluation）：执行解析阶段得到的中介结构然后得到运行结果。这部分包含作用域，类型系统设计和语法树遍历。</li>
</ul>


<h3>词法分析</h3>

<p>词法分析负责把源程序解析成一个个词法单元（Lex），以便之后的处理。</p>

<p>iScheme的词法分析极其简单——由于iScheme的词法元素只包含括号，空白，数字和变量名，因此C#自带的<code>String#Split</code>就足够。</p>

<figure class='code'><figcaption><span>iScheme的词法分析及测试</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">String</span><span class="p">[]</span> <span class="nf">Tokenize</span><span class="p">(</span><span class="n">String</span> <span class="n">text</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">String</span><span class="p">[]</span> <span class="n">tokens</span> <span class="p">=</span> <span class="n">text</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">,</span> <span class="s">&quot; ( &quot;</span><span class="p">).</span><span class="n">Replace</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">,</span> <span class="s">&quot; ) &quot;</span><span class="p">).</span><span class="n">Split</span><span class="p">(</span><span class="s">&quot; \t\r\n&quot;</span><span class="p">.</span><span class="n">ToArray</span><span class="p">(),</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">RemoveEmptyEntries</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">tokens</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Extends String.Join for a smooth API.</span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">String</span> <span class="nf">Join</span><span class="p">(</span><span class="k">this</span> <span class="n">String</span> <span class="n">separator</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Object</span><span class="p">&gt;</span> <span class="n">values</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">String</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="n">separator</span><span class="p">,</span> <span class="n">values</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Displays the lexes in a readable form.</span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">String</span> <span class="nf">PrettyPrint</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">lexes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;[&quot;</span> <span class="p">+</span> <span class="s">&quot;, &quot;</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="n">lexes</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="s">&quot;&#39;&quot;</span> <span class="p">+</span> <span class="n">s</span> <span class="p">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">)</span> <span class="p">+</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Some tests</span>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="n">PrettyPrint</span><span class="p">(</span><span class="n">Tokenize</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="p">[</span><span class="sc">&#39;a&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="n">PrettyPrint</span><span class="p">(</span><span class="n">Tokenize</span><span class="p">(</span><span class="s">&quot;(def a 3)&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="p">[</span><span class="sc">&#39;(&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">def</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;)&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="n">PrettyPrint</span><span class="p">(</span><span class="n">Tokenize</span><span class="p">(</span><span class="s">&quot;(begin (def a 3) (* a a))&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">&gt;&gt;</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">begin</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;(&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">def</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;)&#39;</span><span class="p">,</span> <span class="sc">&#39;(&#39;</span><span class="p">,</span> <span class="sc">&#39;*&#39;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;)&#39;</span><span class="p">,</span> <span class="sc">&#39;)&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h4>注意</h4>

<ul>
<li>个人不喜欢<code>String.Join</code>这个静态方法，所以这里使用C#的<a href="http://msdn.microsoft.com/zh-cn/library/bb383977.aspx">扩展方法</a>（Extension Methods）对String类型做了一个扩展。</li>
<li>相对于LINQ Syntax，我个人更喜欢LINQ Extension Methods，接下来的代码也都会是这种风格。</li>
<li>不要以为词法分析都是这么离谱般简单！vczh的<a href="http://www.cnblogs.com/geniusvczh/p/3577561.html">词法分析教程</a>给出了一个完整编程语言的词法分析教程。</li>
</ul>


<h3>语法树生成</h3>

<p>得到了词素之后，接下来就是进行语法分析。不过由于Lisp类语言的程序即是语法树，所以语法分析可以直接跳过。</p>

<p>以下面的程序为例：</p>

<figure class='code'><figcaption><span>程序即语法树</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="c1">;</span>
</span><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">x</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="nv">a</span> <span class="mi">1</span><span class="p">)</span> <span class="nv">a</span> <span class="mi">1</span><span class="p">))</span>
</span><span class='line'><span class="c1">; 换一个角度看的话：</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>    <span class="nv">def</span>
</span><span class='line'>    <span class="nv">x</span>
</span><span class='line'>    <span class="p">(</span>
</span><span class='line'>        <span class="nv">if</span>
</span><span class='line'>        <span class="p">(</span>
</span><span class='line'>            <span class="nv">&gt;</span>
</span><span class='line'>            <span class="nv">a</span>
</span><span class='line'>            <span class="mi">1</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="nv">a</span>
</span><span class='line'>        <span class="mi">1</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>更加直观的图片：</p>

<p><img src="http://i.imgur.com/NVolNQE.png" alt="抽象语法树" /></p>

<p>这使得<a href="http://zh.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E8%AA%9E%E6%B3%95%E6%A8%B9">抽象语法树</a>（Abstract Syntax Tree）的构建变得极其简单（无需考虑操作符优先级等问题），我们使用<code>SExpression</code>类型定义iScheme的语法树（事实上<a href="http://en.wikipedia.org/wiki/S-expression">S Expression</a>也是Lisp表达式的名字）。</p>

<figure class='code'><figcaption><span>抽象语法树的定义</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SExpression</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">String</span> <span class="n">Value</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">&gt;</span> <span class="n">Children</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">SExpression</span> <span class="n">Parent</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">SExpression</span><span class="p">(</span><span class="n">String</span> <span class="k">value</span><span class="p">,</span> <span class="n">SExpression</span> <span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Children</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">&gt;();</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Parent</span> <span class="p">=</span> <span class="n">parent</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="n">String</span> <span class="nf">ToString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;(&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="p">+</span> <span class="s">&quot; &quot;</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="n">Children</span><span class="p">)</span> <span class="p">+</span> <span class="s">&quot;)&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后用下面的步骤构建语法树：</p>

<ol>
<li>碰到左括号，创建一个新的节点到当前节点（<code>current</code>），然后重设当前节点。</li>
<li>碰到右括号，回退到当前节点的父节点。</li>
<li>否则把为当前词素创建节点，添加到当前节点中。</li>
</ol>


<figure class='code'><figcaption><span>抽象语法树的构建过程</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">SExpression</span> <span class="nf">ParseAsIScheme</span><span class="p">(</span><span class="k">this</span> <span class="n">String</span> <span class="n">code</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SExpression</span> <span class="n">program</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SExpression</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="k">null</span><span class="p">);</span>
</span><span class='line'>    <span class="n">SExpression</span> <span class="n">current</span> <span class="p">=</span> <span class="n">program</span><span class="p">;</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">lex</span> <span class="k">in</span> <span class="n">Tokenize</span><span class="p">(</span><span class="n">code</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">lex</span> <span class="p">==</span> <span class="s">&quot;(&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">SExpression</span> <span class="n">newNode</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SExpression</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="s">&quot;(&quot;</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">current</span><span class="p">);</span>
</span><span class='line'>            <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">newNode</span><span class="p">);</span>
</span><span class='line'>            <span class="n">current</span> <span class="p">=</span> <span class="n">newNode</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lex</span> <span class="p">==</span> <span class="s">&quot;)&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">current</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Parent</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">SExpression</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="n">lex</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">current</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">program</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>注意</h4>

<ul>
<li>使用<a href="http://msdn.microsoft.com/zh-cn/library/bb384054.aspx">自动属性</a>（Auto Property），从而避免重复编写样版代码（Boilerplate Code）。</li>
<li>使用<a href="http://msdn.microsoft.com/zh-cn/library/dd264739.aspx">命名参数</a>（Named Parameters）提高代码可读性：<code>new SExpression(value: "", parent: null)</code>比<code>new SExpression("", null)</code>可读。</li>
<li>使用<a href="http://msdn.microsoft.com/zh-cn/library/bb383977.aspx">扩展方法</a>提高代码流畅性：<code>code.Tokenize().ParseAsIScheme</code>比<code>ParseAsIScheme(Tokenize(code))</code>流畅。</li>
<li>大多数编程语言的语法分析不会这么简单！如果打算实现一个类似C#的编程语言，你需要更强大的语法分析技术：

<ul>
<li>如果打算手写语法分析器，可以参考LL(k), Precedence Climbing和Top Down Operator Precedence。</li>
<li>如果打算生成语法分析器，可以参考ANTLR或Bison。</li>
</ul>
</li>
</ul>


<h3>作用域</h3>

<p><a href="http://zh.wikipedia.org/wiki/%E4%BD%9C%E7%94%A8%E5%9F%9F">作用域</a>决定程序的运行环境。iScheme使用嵌套作用域。</p>

<p>以下面的程序为例</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">def</span> <span class="nv">x</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">def</span> <span class="nv">y</span> <span class="p">(</span><span class="k">begin </span><span class="p">(</span><span class="nf">def</span> <span class="nv">x</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">x</span> <span class="nv">x</span><span class="p">)))</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">4</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="nv">x</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://i.imgur.com/TzBY0vd.jpg" alt="作用域示例" /></p>

<p>利用C#提供的<code>Dictionary&lt;TKey, TValue&gt;</code>类型，我们可以很容易的实现iScheme的作用域<code>SScope</code>：</p>

<figure class='code'><figcaption><span>iScheme的作用域实现</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SScope</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">SScope</span> <span class="n">Parent</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">SObject</span><span class="p">&gt;</span> <span class="n">variableTable</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">SScope</span><span class="p">(</span><span class="n">SScope</span> <span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Parent</span> <span class="p">=</span> <span class="n">parent</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">variableTable</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">SObject</span><span class="p">&gt;();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">SObject</span> <span class="nf">Find</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SScope</span> <span class="n">current</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">current</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">variableTable</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">current</span><span class="p">.</span><span class="n">variableTable</span><span class="p">[</span><span class="n">name</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">current</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Parent</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="n">name</span> <span class="p">+</span> <span class="s">&quot; is not defined.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">SObject</span> <span class="nf">Define</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">SObject</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">variableTable</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">value</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">value</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>类型实现</h3>

<p>iScheme的类型系统极其简单——只有数值，Bool，列表和函数，考虑到他们都是iScheme里面的值对象（Value Object），为了便于对它们进行统一处理，这里为它们设置一个统一的父类型<code>SObject</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SObject</span> <span class="p">{</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>数值类型</h4>

<p>iScheme的数值类型只是对.Net中<code>Int64</code>（即C#里的<code>long</code>）的简单封装：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SNumber</span> <span class="p">:</span> <span class="n">SObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Int64</span> <span class="k">value</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">SNumber</span><span class="p">(</span><span class="n">Int64</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="k">value</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="n">String</span> <span class="nf">ToString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="k">value</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">Int64</span><span class="p">(</span><span class="n">SNumber</span> <span class="n">number</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">number</span><span class="p">.</span><span class="k">value</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">SNumber</span><span class="p">(</span><span class="n">Int64</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">SNumber</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意这里使用了C#的<a href="http://msdn.microsoft.com/zh-cn/library/z5z9kes2.aspx">隐式操作符重载</a>，这使得我们可以：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">SNumber</span> <span class="n">foo</span> <span class="p">=</span> <span class="m">30</span><span class="p">;</span>
</span><span class='line'><span class="n">SNumber</span> <span class="n">bar</span> <span class="p">=</span> <span class="m">40</span><span class="p">;</span>
</span><span class='line'><span class="n">SNumber</span> <span class="n">foobar</span> <span class="p">=</span> <span class="n">foo</span> <span class="p">*</span> <span class="n">bar</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>而不必：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">SNumber</span> <span class="n">foo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SNumber</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="m">30</span><span class="p">);</span>
</span><span class='line'><span class="n">SNumber</span> <span class="n">bar</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SNumber</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="m">40</span><span class="p">);</span>
</span><span class='line'><span class="n">SNumber</span> <span class="n">foobar</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SNumber</span><span class="p">(</span><span class="k">value</span><span class="p">:</span> <span class="n">foo</span><span class="p">.</span><span class="n">Value</span> <span class="p">*</span> <span class="n">bar</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>为了方便，这里也为SObject增加了<a href="http://msdn.microsoft.com/zh-cn/library/z5z9kes2.aspx">隐式操作符重载</a>（尽管<code>Int64</code>可以被转换为<code>SNumber</code>且<code>SNumber</code>继承自<code>SObject</code>，但.Net无法直接把<code>Int64</code>转化为<code>SObject</code>）：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">SObject</span><span class="p">(</span><span class="n">Int64</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">SNumber</span><span class="p">)</span><span class="k">value</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Bool类型</h4>

<p>由于Bool类型只有True和False，所以使用静态对象就足矣。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SBool</span> <span class="p">:</span> <span class="n">SObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">SBool</span> <span class="n">False</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SBool</span><span class="p">();</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">SBool</span> <span class="n">True</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SBool</span><span class="p">();</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="n">String</span> <span class="nf">ToString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">((</span><span class="n">Boolean</span><span class="p">)</span><span class="k">this</span><span class="p">).</span><span class="n">ToString</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">Boolean</span><span class="p">(</span><span class="n">SBool</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">value</span> <span class="p">==</span> <span class="n">SBool</span><span class="p">.</span><span class="n">True</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">SBool</span><span class="p">(</span><span class="n">Boolean</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">value</span> <span class="p">?</span> <span class="n">True</span> <span class="p">:</span> <span class="n">False</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里同样使用了C#的<a href="http://msdn.microsoft.com/zh-cn/library/z5z9kes2.aspx">隐式操作符重载</a>，这使得我们可以：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">SBool</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">a</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">foo</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Do something...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>而不用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">SBool</span> <span class="n">foo</span> <span class="p">=</span> <span class="n">a</span> <span class="p">&gt;</span> <span class="m">1</span> <span class="p">?</span> <span class="n">SBool</span><span class="p">.</span><span class="n">True</span><span class="p">:</span> <span class="n">SBool</span><span class="p">.</span><span class="n">False</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">foo</span> <span class="p">==</span> <span class="n">SBool</span><span class="p">.</span><span class="n">True</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Do something...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>同样，为<code>SObject</code>增加<a href="http://msdn.microsoft.com/zh-cn/library/z5z9kes2.aspx">隐式操作符重载</a>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">implicit</span> <span class="k">operator</span> <span class="nf">SObject</span><span class="p">(</span><span class="n">Boolean</span> <span class="k">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">SBool</span><span class="p">)</span><span class="k">value</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>列表类型</h4>

<p>iScheme使用.Net中的<code>IEnumberable&lt;T&gt;</code>实现列表类型<code>SList</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SList</span> <span class="p">:</span> <span class="n">SObject</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">SObject</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">SObject</span><span class="p">&gt;</span> <span class="n">values</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">SList</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">SObject</span><span class="p">&gt;</span> <span class="n">values</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">values</span> <span class="p">=</span> <span class="n">values</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="n">String</span> <span class="nf">ToString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&quot;(list &quot;</span> <span class="p">+</span> <span class="s">&quot; &quot;</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">values</span><span class="p">)</span> <span class="p">+</span> <span class="s">&quot;)&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">IEnumerator</span><span class="p">&lt;</span><span class="n">SObject</span><span class="p">&gt;</span> <span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">values</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">IEnumerator</span> <span class="n">IEnumerable</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">values</span><span class="p">.</span><span class="n">GetEnumerator</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>实现<code>IEnumerable&lt;SObject&gt;</code>后，就可以直接使用LINQ的一系列扩展方法，十分方便。</p>

<h4>函数类型</h4>

<p>iScheme的函数类型（<code>SFunction</code>）由三部分组成：</p>

<ul>
<li>函数体：即对应的<code>SExpression</code>。</li>
<li>参数列表。</li>
<li>作用域：函数拥有自己的作用域</li>
</ul>


<figure class='code'><figcaption><span>SFunction的实现</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SFunction</span> <span class="p">:</span> <span class="n">SObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">SExpression</span> <span class="n">Body</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">String</span><span class="p">[]</span> <span class="n">Parameters</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">SScope</span> <span class="n">Scope</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">Boolean</span> <span class="n">IsPartial</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">get</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">ComputeFilledParameters</span><span class="p">().</span><span class="n">Length</span><span class="p">.</span><span class="n">InBetween</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="nf">SFunction</span><span class="p">(</span><span class="n">SExpression</span> <span class="n">body</span><span class="p">,</span> <span class="n">String</span><span class="p">[]</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">SScope</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Body</span> <span class="p">=</span> <span class="n">body</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Parameters</span> <span class="p">=</span> <span class="n">parameters</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">Scope</span> <span class="p">=</span> <span class="n">scope</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">SObject</span> <span class="nf">Evaluate</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">String</span><span class="p">[]</span> <span class="n">filledParameters</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">ComputeFilledParameters</span><span class="p">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">filledParameters</span><span class="p">.</span><span class="n">Length</span> <span class="p">&lt;</span> <span class="n">Parameters</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Scope</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="n">String</span> <span class="nf">ToString</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;(func ({0}) {1})&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot; &quot;</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">SObject</span> <span class="k">value</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">((</span><span class="k">value</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Scope</span><span class="p">.</span><span class="n">FindInTop</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">return</span> <span class="n">p</span> <span class="p">+</span> <span class="s">&quot;:&quot;</span> <span class="p">+</span> <span class="k">value</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</span><span class='line'>            <span class="p">})),</span> <span class="k">this</span><span class="p">.</span><span class="n">Body</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">String</span><span class="p">[]</span> <span class="nf">ComputeFilledParameters</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">Scope</span><span class="p">.</span><span class="n">FindInTop</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">!=</span> <span class="k">null</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h5>需要注意的几点</h5>

<ul>
<li>iScheme支持部分求值（Partial Evaluation），这意味着：</li>
</ul>


<figure class='code'><figcaption><span>部分求值</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">def</span> <span class="nv">mul</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">a</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)))</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">a</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">mul</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">12</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">mul</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">a:3</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">((</span><span class="nf">mul</span> <span class="mi">3</span><span class="p">)</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">12</span>
</span></code></pre></td></tr></table></div></figure>


<p>也就是说，当<code>SFunction</code>的实际参数（Argument）数量小于其形式参数（Parameter）的数量时，它依然是一个函数，无法被求值。</p>

<p>这个功能有什么用呢？生成高阶函数。有了部分求值，我们就可以使用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">mul</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">a</span> <span class="nv">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)))</span>
</span><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">mul3</span> <span class="p">(</span><span class="nf">mul</span> <span class="mi">3</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">mul3</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">9</span>
</span></code></pre></td></tr></table></div></figure>


<p>而不用专门定义一个生成函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scm'><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">times</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">n</span><span class="p">)</span> <span class="p">(</span><span class="nf">func</span> <span class="p">(</span><span class="nf">n</span> <span class="nv">x</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">n</span> <span class="nv">x</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">def</span> <span class="nv">mul3</span> <span class="p">(</span><span class="nf">times</span> <span class="mi">3</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="p">(</span><span class="nf">mul3</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'><span class="nv">&gt;&gt;</span> <span class="mi">9</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>SFunction#ToString</code>可以将其自身还原为源代码——从而大大简化了iScheme的理解和测试。</li>
</ul>


<h3>内置操作</h3>

<p>iScheme的内置操作有四种：算术|逻辑|比较|列表操作。</p>

<p>我选择了表达力（Expressiveness）强的lambda方法表来定义内置操作：</p>

<p>首先在<code>SScope</code>中添加静态字段<code>builtinFunctions</code>，以及对应的访问属性<code>BuiltinFunctions</code>和操作方法<code>BuildIn</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SScope</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">[],</span> <span class="n">SScope</span><span class="p">,</span> <span class="n">SObject</span><span class="p">&gt;&gt;</span> <span class="n">builtinFunctions</span> <span class="p">=</span>
</span><span class='line'>        <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">[],</span> <span class="n">SScope</span><span class="p">,</span> <span class="n">SObject</span><span class="p">&gt;&gt;();</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">[],</span> <span class="n">SScope</span><span class="p">,</span> <span class="n">SObject</span><span class="p">&gt;&gt;</span> <span class="n">BuiltinFunctions</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">builtinFunctions</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">// Dirty HACK for fluent API.</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">SScope</span> <span class="nf">BuildIn</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">[],</span> <span class="n">SScope</span><span class="p">,</span> <span class="n">SObject</span><span class="p">&gt;</span> <span class="n">builtinFuntion</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SScope</span><span class="p">.</span><span class="n">builtinFunctions</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">builtinFuntion</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意：</p>

<ol>
<li><code>Func&lt;T1, T2, TRESULT&gt;</code>是C#提供的委托类型，表示一个接受<code>T1</code>和<code>T2</code>，返回<code>TRESULT</code></li>
<li>这里有一个小HACK，使用实例方法（Instance Method）修改静态成员（Static Member），从而实现一套流畅的API（参见<a href="http://en.wikipedia.org/wiki/Fluent_interface">Fluent Interface</a>）。</li>
</ol>


<p>接下来就可以这样定义内置操作：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">new</span> <span class="nf">SScope</span><span class="p">(</span><span class="n">parent</span><span class="p">:</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="n">addMethod</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="n">subMethod</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="n">mulMethod</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="n">divMethod</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>一目了然。</p>

<h4>断言（Assertion）扩展</h4>

<p>为了便于进行<a href="http://zh.wikipedia.org/wiki/%E6%96%B7%E8%A8%80_(%E7%A8%8B%E5%BC%8F)">断言</a>，我对<code>Boolean</code>类型做了一点点扩展。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">OrThrows</span><span class="p">(</span><span class="k">this</span> <span class="n">Boolean</span> <span class="n">condition</span><span class="p">,</span> <span class="n">String</span> <span class="n">message</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(!</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="n">message</span> <span class="p">??</span> <span class="s">&quot;WTF&quot;</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>从而可以写出流畅的断言：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">(</span><span class="n">a</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;Value must be less than 3.&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>而不用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;Value must be less than 3.&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>算术操作</h4>

<p>iScheme算术操作包含<code>+ - * / %</code>五个操作，它们仅应用于数值类型（也就是<code>SNumber</code>）。</p>

<p>从加减法开始：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">numbers</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">obj</span> <span class="p">=&gt;</span> <span class="n">obj</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">Cast</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">numbers</span><span class="p">.</span><span class="n">Sum</span><span class="p">(</span><span class="n">n</span> <span class="p">=&gt;</span> <span class="n">n</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">numbers</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">obj</span> <span class="p">=&gt;</span> <span class="n">obj</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">Cast</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;().</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="n">Int64</span> <span class="n">firstValue</span> <span class="p">=</span> <span class="n">numbers</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">numbers</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">-</span><span class="n">firstValue</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">firstValue</span> <span class="p">-</span> <span class="n">numbers</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Sum</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意到这里有一段重复逻辑负责转型求值（Cast then Evaluation），考虑到接下来还有不少地方要用这个逻辑，我把这段逻辑抽象成扩展方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">&gt;</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">SScope</span> <span class="n">scope</span><span class="p">)</span>
</span><span class='line'><span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">SObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">expressions</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">).</span><span class="n">Cast</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">SObject</span><span class="p">&gt;</span> <span class="n">Evaluate</span><span class="p">(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">SExpression</span><span class="p">&gt;</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">SScope</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">expressions</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">exp</span> <span class="p">=&gt;</span> <span class="n">exp</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后加减法就可以如此定义：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;(</span><span class="n">scope</span><span class="p">).</span><span class="n">Sum</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">)))</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">numbers</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;(</span><span class="n">scope</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="n">Int64</span> <span class="n">firstValue</span> <span class="p">=</span> <span class="n">numbers</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">numbers</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">-</span><span class="n">firstValue</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">firstValue</span> <span class="p">-</span> <span class="n">numbers</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Sum</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>乘法，除法和求模定义如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;(</span><span class="n">scope</span><span class="p">).</span><span class="n">Aggregate</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">a</span> <span class="p">*</span> <span class="n">b</span><span class="p">))</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">numbers</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;(</span><span class="n">scope</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="n">Int64</span> <span class="n">firstValue</span> <span class="p">=</span> <span class="n">numbers</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">firstValue</span> <span class="p">/</span> <span class="n">numbers</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Aggregate</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">a</span> <span class="p">*</span> <span class="n">b</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;%&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">2</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;Parameters count in mod should be 2&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">numbers</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;(</span><span class="n">scope</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">numbers</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">%</span> <span class="n">numbers</span><span class="p">[</span><span class="m">1</span><span class="p">];</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h4>逻辑操作</h4>

<p>iScheme逻辑操作包括<code>and</code>，<code>or</code>和<code>not</code>，即与，或和非。</p>

<p>需要注意的是iScheme逻辑操作是<a href="http://zh.wikipedia.org/wiki/%E7%9F%AD%E8%B7%AF%E6%B1%82%E5%80%BC">短路求值</a>（Short-circuit evaluation），也就是说：</p>

<ul>
<li><code>(and condA condB)</code>，如果<code>condA</code>为假，那么整个表达式为假，无需对<code>condB</code>求值。</li>
<li><code>(or condA condB)</code>，如果<code>condA</code>为真，那么整个表达式为真，无需对<code>condB</code>求值。</li>
</ul>


<p>此外和<code>+ - * /</code>一样，<code>and</code>和<code>or</code>也可以接收任意数量的参数。</p>

<p>需求明确了接下来就是实现，iScheme的逻辑操作实现如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;and&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">!</span><span class="n">args</span><span class="p">.</span><span class="n">Any</span><span class="p">(</span><span class="n">arg</span> <span class="p">=&gt;</span> <span class="p">!(</span><span class="n">SBool</span><span class="p">)</span><span class="n">arg</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;or&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">args</span><span class="p">.</span><span class="n">Any</span><span class="p">(</span><span class="n">arg</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">SBool</span><span class="p">)</span><span class="n">arg</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;not&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h4>比较操作</h4>

<p>iScheme的比较操作包括<code>= &lt; &gt; &gt;= &lt;=</code>，需要注意下面几点：</p>

<ul>
<li><code>=</code>是比较操作而非赋值操作。</li>
<li>同算术操作一样，它们应用于数值类型，并支持任意数量的参数。</li>
</ul>


<p><code>=</code>的实现如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;Must have more than 1 argument in relation operation.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">SNumber</span> <span class="n">current</span> <span class="p">=</span> <span class="p">(</span><span class="n">SNumber</span><span class="p">)</span><span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">arg</span> <span class="k">in</span> <span class="n">args</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SNumber</span> <span class="n">next</span> <span class="p">=</span> <span class="p">(</span><span class="n">SNumber</span><span class="p">)</span><span class="n">arg</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="p">==</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">current</span> <span class="p">=</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以预见所有的比较操作都将使用这段逻辑，因此把这段比较逻辑抽象成一个扩展方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">SBool</span> <span class="nf">ChainRelation</span><span class="p">(</span><span class="k">this</span> <span class="n">SExpression</span><span class="p">[]</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">SScope</span> <span class="n">scope</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">,</span> <span class="n">SNumber</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">&gt;</span> <span class="n">relation</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="n">expressions</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;Must have more than 1 parameter in relation operation.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">SNumber</span> <span class="n">current</span> <span class="p">=</span> <span class="p">(</span><span class="n">SNumber</span><span class="p">)</span><span class="n">expressions</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">obj</span> <span class="k">in</span> <span class="n">expressions</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SNumber</span> <span class="n">next</span> <span class="p">=</span> <span class="p">(</span><span class="n">SNumber</span><span class="p">)</span><span class="n">obj</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">relation</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">next</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">current</span> <span class="p">=</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">SBool</span><span class="p">.</span><span class="n">False</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">SBool</span><span class="p">.</span><span class="n">True</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来就可以很方便的定义比较操作：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">ChainRelation</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">Int64</span><span class="p">)</span><span class="n">s1</span> <span class="p">==</span> <span class="p">(</span><span class="n">Int64</span><span class="p">)</span><span class="n">s2</span><span class="p">))</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">ChainRelation</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">s1</span> <span class="p">&gt;</span> <span class="n">s2</span><span class="p">))</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">ChainRelation</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">s1</span> <span class="p">&lt;</span> <span class="n">s2</span><span class="p">))</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;&gt;=&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">ChainRelation</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">s1</span> <span class="p">&gt;=</span> <span class="n">s2</span><span class="p">))</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">ChainRelation</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">s1</span> <span class="p">&lt;=</span> <span class="n">s2</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意<code>=</code>操作的实现里面有<code>Int64</code>强制转型——因为我们没有重载<code>SNumber#Equals</code>，所以无法直接通过<code>==</code>来比较两个<code>SNumber</code>。</p>

<h4>列表操作</h4>

<p>iScheme的列表操作包括<code>first</code>，<code>rest</code>，<code>empty?</code>和<code>append</code>，分别用来取列表的第一个元素，除第一个以外的部分，判断列表是否为空和拼接列表。</p>

<p><code>first</code>和<code>rest</code>操作如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;first&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SList</span> <span class="n">list</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">list</span> <span class="p">=</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="k">as</span> <span class="n">SList</span><span class="p">))</span> <span class="p">!=</span> <span class="k">null</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;&lt;first&gt; must apply to a list.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">list</span><span class="p">.</span><span class="n">First</span><span class="p">();</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;rest&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SList</span> <span class="n">list</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">list</span> <span class="p">=</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="k">as</span> <span class="n">SList</span><span class="p">))</span> <span class="p">!=</span> <span class="k">null</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;&lt;rest&gt; must apply to a list.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">SList</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">));</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>又发现相当的重复逻辑——判断参数是否是一个合法的列表，重复代码很邪恶，所以这里把这段逻辑抽象为扩展方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">SList</span> <span class="nf">RetrieveSList</span><span class="p">(</span><span class="k">this</span> <span class="n">SExpression</span><span class="p">[]</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">SScope</span> <span class="n">scope</span><span class="p">,</span> <span class="n">String</span> <span class="n">operationName</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SList</span> <span class="n">list</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="p">(</span><span class="n">expressions</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span> <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">list</span> <span class="p">=</span> <span class="p">(</span><span class="n">expressions</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="k">as</span> <span class="n">SList</span><span class="p">))</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span> <span class="p">+</span> <span class="n">operationName</span> <span class="p">+</span> <span class="s">&quot;&gt; must apply to a list&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">list</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>有了这个扩展方法，接下来的列表操作就很容易实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;first&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">RetrieveSList</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="s">&quot;first&quot;</span><span class="p">).</span><span class="n">First</span><span class="p">())</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;rest&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">SList</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">RetrieveSList</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="s">&quot;rest&quot;</span><span class="p">).</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">)))</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;append&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SList</span> <span class="n">list0</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span> <span class="n">list1</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">2</span>
</span><span class='line'>        <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">list0</span> <span class="p">=</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="k">as</span> <span class="n">SList</span><span class="p">))</span> <span class="p">!=</span> <span class="k">null</span>
</span><span class='line'>        <span class="p">&amp;&amp;</span> <span class="p">(</span><span class="n">list1</span> <span class="p">=</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="k">as</span> <span class="n">SList</span><span class="p">))</span> <span class="p">!=</span> <span class="k">null</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;Input must be two lists&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">SList</span><span class="p">(</span><span class="n">list0</span><span class="p">.</span><span class="n">Concat</span><span class="p">(</span><span class="n">list1</span><span class="p">));</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;empty?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">RetrieveSList</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="s">&quot;empty?&quot;</span><span class="p">).</span><span class="n">Count</span><span class="p">()</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>测试</h4>

<p>iScheme的内置操作完成之后，就可以测试下初步成果了。</p>

<p>首先添加基于控制台的分析/求值（Parse/Evaluation）循环：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">KeepInterpretingInConsole</span><span class="p">(</span><span class="k">this</span> <span class="n">SScope</span> <span class="n">scope</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">SScope</span><span class="p">,</span> <span class="n">SObject</span><span class="p">&gt;</span> <span class="n">evaluate</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Gray</span><span class="p">;</span>
</span><span class='line'>            <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;&gt;&gt; &quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">code</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(!</span><span class="n">String</span><span class="p">.</span><span class="n">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">code</span> <span class="p">=</span> <span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">()))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Green</span><span class="p">;</span>
</span><span class='line'>                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;&gt;&gt; &quot;</span> <span class="p">+</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">scope</span><span class="p">));</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Console</span><span class="p">.</span><span class="n">ForegroundColor</span> <span class="p">=</span> <span class="n">ConsoleColor</span><span class="p">.</span><span class="n">Red</span><span class="p">;</span>
</span><span class='line'>            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;&gt;&gt; &quot;</span> <span class="p">+</span> <span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后在<code>SExpression#Evaluate</code>中补充调用代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">override</span> <span class="n">SObject</span> <span class="nf">Evaluate</span><span class="p">(</span><span class="n">SScope</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Int64</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">Int64</span><span class="p">.</span><span class="n">TryParse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="k">out</span> <span class="n">number</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SExpression</span> <span class="n">first</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">arguments</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">node</span> <span class="p">=&gt;</span> <span class="n">node</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">[</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">](</span><span class="n">arguments</span><span class="p">,</span> <span class="n">scope</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;THIS IS JUST TEMPORARY!&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后在<code>Main</code>中调用该解释/求值循环：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">cmdArgs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">new</span> <span class="nf">SScope</span><span class="p">(</span><span class="n">parent</span><span class="p">:</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;(</span><span class="n">scope</span><span class="p">).</span><span class="n">Sum</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">)))</span>
</span><span class='line'>        <span class="c1">// 省略若干内置函数</span>
</span><span class='line'>        <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;empty?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">RetrieveSList</span><span class="p">(</span><span class="s">&quot;empty?&quot;</span><span class="p">).</span><span class="n">Count</span><span class="p">()</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">KeepInterpretingInConsole</span><span class="p">((</span><span class="n">code</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">code</span><span class="p">.</span><span class="n">ParseAsScheme</span><span class="p">().</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>运行程序，输入一些简单的表达式：</p>

<p><img src="http://i.imgur.com/FEVEVGW.jpg" alt="运行结果" /></p>

<p>看样子还不错 :&ndash;)</p>

<p>接下来开始实现iScheme的执行（Evaluation）逻辑。</p>

<h3>执行逻辑</h3>

<p>iScheme的执行就是把语句（SExpression）在作用域（SScope）转化成对象（SObject）并对作用域（SScope）产生作用的过程，如下图所示。</p>

<p><img src="http://i.imgur.com/2j4ztfF.png" alt="编程语言的实质" /></p>

<p>iScheme的执行逻辑就在<code>SExpression#Evaluate</code>里面：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">SExpression</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="n">SObject</span> <span class="nf">Evaluate</span><span class="p">(</span><span class="n">SScope</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// TODO: Todo your ass.</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>首先明确输入和输出：</p>

<ol>
<li>处理字面量（Literals）：<code>3</code>；和具名量（Named Values）：<code>x</code></li>
<li>处理<code>if</code>：<code>(if (&lt; a 3) 3 a)</code></li>
<li>处理<code>def</code>：<code>(def pi 3.14)</code></li>
<li>处理<code>begin</code>：<code>(begin (def a 3) (* a a))</code></li>
<li>处理<code>func</code>：<code>(func (x) (* x x))</code></li>
<li>处理内置函数调用：<code>(+ 1 2 3 (first (list 1 2)))</code></li>
<li>处理自定义函数调用：<code>(map (func (x) (* x x)) (list 1 2 3))</code></li>
</ol>


<p>此外，情况1和2中的<code>SExpression</code>没有子节点，可以直接读取其<code>Value</code>进行求值，余下的情况需要读取其<code>Children</code>进行求值。</p>

<p>首先处理没有子节点的情况：</p>

<h4>处理字面量和具名量</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Int64</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">Int64</span><span class="p">.</span><span class="n">TryParse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="k">out</span> <span class="n">number</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">scope</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来处理带有子节点的情况：</p>

<p>首先获得当前节点的第一个节点：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">SExpression</span> <span class="n">first</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后根据该节点的<code>Value</code>决定下一步操作：</p>

<h4>处理<code>if</code></h4>

<p><code>if</code>语句的处理方法很直接——根据判断条件（condition）的值判断执行哪条语句即可：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;if&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SBool</span> <span class="n">condition</span> <span class="p">=</span> <span class="p">(</span><span class="n">SBool</span><span class="p">)(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">condition</span> <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">3</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>处理<code>def</code></h4>

<p>直接定义即可：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;def&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">scope</span><span class="p">.</span><span class="n">Define</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="k">new</span> <span class="n">SScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>处理<code>begin</code></h4>

<p>遍历语句，然后返回最后一条语句的值：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;begin&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SObject</span> <span class="n">result</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="k">foreach</span> <span class="p">(</span><span class="n">SExpression</span> <span class="n">statement</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">result</span> <span class="p">=</span> <span class="n">statement</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>处理<code>func</code></h4>

<p>利用<code>SExpression</code>构建<code>SFunction</code>，然后返回：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;func&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SExpression</span> <span class="n">body</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">];</span>
</span><span class='line'>    <span class="n">String</span><span class="p">[]</span> <span class="n">parameters</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Children</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">exp</span> <span class="p">=&gt;</span> <span class="n">exp</span><span class="p">.</span><span class="n">Value</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="n">SScope</span> <span class="n">newScope</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SScope</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">SFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">newScope</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>处理<code>list</code></h4>

<p>首先把获得<code>list</code>里元素的值，然后创建<code>SList</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;list&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">SList</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">exp</span> <span class="p">=&gt;</span> <span class="n">exp</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>处理内置操作</h4>

<p>首先对参数求值，然后调用对应的内置函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">arguments</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">node</span> <span class="p">=&gt;</span> <span class="n">node</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">[</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">](</span><span class="n">arguments</span><span class="p">,</span> <span class="n">scope</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>处理自定义函数调用</h4>

<p>自定义函数调用有两种情况：</p>

<ol>
<li>非具名函数调用：<code>((func (x) (* x x)) 3)</code></li>
<li>具名函数调用：<code>(square 3)</code></li>
</ol>


<p>调用自定义函数时应使用新的作用域，所以为<code>SFunction</code>增加<code>Update</code>方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">SFunction</span> <span class="nf">Update</span><span class="p">(</span><span class="n">SObject</span><span class="p">[]</span> <span class="n">arguments</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">existingArguments</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">Scope</span><span class="p">.</span><span class="n">FindInTop</span><span class="p">(</span><span class="n">p</span><span class="p">)).</span><span class="n">Where</span><span class="p">(</span><span class="n">obj</span> <span class="p">=&gt;</span> <span class="n">obj</span> <span class="p">!=</span> <span class="k">null</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">newArguments</span> <span class="p">=</span> <span class="n">existingArguments</span><span class="p">.</span><span class="n">Concat</span><span class="p">(</span><span class="n">arguments</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="n">SScope</span> <span class="n">newScope</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Scope</span><span class="p">.</span><span class="n">Parent</span><span class="p">.</span><span class="n">SpawnScopeWith</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Parameters</span><span class="p">,</span> <span class="n">newArguments</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="nf">SFunction</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Body</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">Parameters</span><span class="p">,</span> <span class="n">newScope</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>为了便于创建自定义作用域，并判断函数的参数是否被赋值，为<code>SScope</code>增加<code>SpawnScopeWith</code>和<code>FindInTop</code>方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">SScope</span> <span class="nf">SpawnScopeWith</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">names</span><span class="p">,</span> <span class="n">SObject</span><span class="p">[]</span> <span class="n">values</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">(</span><span class="n">names</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;=</span> <span class="n">values</span><span class="p">.</span><span class="n">Length</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;Too many arguments.&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">SScope</span> <span class="n">scope</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SScope</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">Int32</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">values</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">scope</span><span class="p">.</span><span class="n">variableTable</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">scope</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">public</span> <span class="n">SObject</span> <span class="nf">FindInTop</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">variableTable</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">variableTable</span><span class="p">[</span><span class="n">name</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面是函数调用的实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SFunction</span> <span class="n">function</span> <span class="p">=</span> <span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;(&quot;</span> <span class="p">?</span> <span class="p">(</span><span class="n">SFunction</span><span class="p">)</span><span class="n">first</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">SFunction</span><span class="p">)</span><span class="n">scope</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">arguments</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">function</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">arguments</span><span class="p">).</span><span class="n">Evaluate</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>完整的求值代码</h4>

<p>综上所述，求值代码如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">SObject</span> <span class="nf">Evaluate</span><span class="p">(</span><span class="n">SScope</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Int64</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">Int64</span><span class="p">.</span><span class="n">TryParse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="k">out</span> <span class="n">number</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">scope</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SExpression</span> <span class="n">first</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;if&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">SBool</span> <span class="n">condition</span> <span class="p">=</span> <span class="p">(</span><span class="n">SBool</span><span class="p">)(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">condition</span> <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">3</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;def&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">scope</span><span class="p">.</span><span class="n">Define</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="k">new</span> <span class="n">SScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)));</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;begin&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">SObject</span> <span class="n">result</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>            <span class="k">foreach</span> <span class="p">(</span><span class="n">SExpression</span> <span class="n">statement</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">result</span> <span class="p">=</span> <span class="n">statement</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;func&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">SExpression</span> <span class="n">body</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">];</span>
</span><span class='line'>            <span class="n">String</span><span class="p">[]</span> <span class="n">parameters</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Children</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">exp</span> <span class="p">=&gt;</span> <span class="n">exp</span><span class="p">.</span><span class="n">Value</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>            <span class="n">SScope</span> <span class="n">newScope</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SScope</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">new</span> <span class="nf">SFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">newScope</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;list&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">new</span> <span class="nf">SList</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">exp</span> <span class="p">=&gt;</span> <span class="n">exp</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)));</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">arguments</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">node</span> <span class="p">=&gt;</span> <span class="n">node</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">[</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">](</span><span class="n">arguments</span><span class="p">,</span> <span class="n">scope</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">SFunction</span> <span class="n">function</span> <span class="p">=</span> <span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;(&quot;</span> <span class="p">?</span> <span class="p">(</span><span class="n">SFunction</span><span class="p">)</span><span class="n">first</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">SFunction</span><span class="p">)</span><span class="n">scope</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">arguments</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">function</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">arguments</span><span class="p">).</span><span class="n">Evaluate</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>去除尾递归</h4>

<p>到了这里iScheme解释器就算完成了。但仔细观察求值过程还是有一个很大的问题，尾递归调用：</p>

<ul>
<li>处理<code>if</code>的尾递归调用。</li>
<li>处理函数调用中的尾递归调用。</li>
</ul>


<p>Alex Stepanov曾在<a href="http://www.amazon.co.uk/Elements-Programming-Alexander-Stepanov/dp/032163537X/">Elements of Programming</a>中介绍了一种将严格尾递归调用（Strict tail-recursive call）转化为迭代的方法，细节恕不赘述，以阶乘为例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// Recursive factorial.</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">fact</span> <span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="n">fact</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// First tranform to tail recursive version.</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">fact</span> <span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">result</span> <span class="o">*=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">fact</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span><span class="c1">// This is a strict tail-recursive call which can be omitted</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// Then transform to iterative version.</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">fact</span> <span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>        <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">*=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>应用这种方法到<code>SExpression#Evaluate</code>，得到转换后的版本：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">SObject</span> <span class="nf">Evaluate</span><span class="p">(</span><span class="n">SScope</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SExpression</span> <span class="n">current</span> <span class="p">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Int64</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">Int64</span><span class="p">.</span><span class="n">TryParse</span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="k">out</span> <span class="n">number</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">number</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">scope</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">SExpression</span> <span class="n">first</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;if&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">SBool</span> <span class="n">condition</span> <span class="p">=</span> <span class="p">(</span><span class="n">SBool</span><span class="p">)(</span><span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'>                <span class="n">current</span> <span class="p">=</span> <span class="n">condition</span> <span class="p">?</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">:</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">3</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;def&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">scope</span><span class="p">.</span><span class="n">Define</span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span><span class="p">,</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">].</span><span class="n">Evaluate</span><span class="p">(</span><span class="k">new</span> <span class="n">SScope</span><span class="p">(</span><span class="n">scope</span><span class="p">)));</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;begin&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">SObject</span> <span class="n">result</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>                <span class="k">foreach</span> <span class="p">(</span><span class="n">SExpression</span> <span class="n">statement</span> <span class="k">in</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">result</span> <span class="p">=</span> <span class="n">statement</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;func&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">SExpression</span> <span class="n">body</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">2</span><span class="p">];</span>
</span><span class='line'>                <span class="n">String</span><span class="p">[]</span> <span class="n">parameters</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Children</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">exp</span> <span class="p">=&gt;</span> <span class="n">exp</span><span class="p">.</span><span class="n">Value</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>                <span class="n">SScope</span> <span class="n">newScope</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SScope</span><span class="p">(</span><span class="n">scope</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span> <span class="k">new</span> <span class="nf">SFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">newScope</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;list&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="k">new</span> <span class="nf">SList</span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">exp</span> <span class="p">=&gt;</span> <span class="n">exp</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)));</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="kt">var</span> <span class="n">arguments</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">node</span> <span class="p">=&gt;</span> <span class="n">node</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">SScope</span><span class="p">.</span><span class="n">BuiltinFunctions</span><span class="p">[</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">](</span><span class="n">arguments</span><span class="p">,</span> <span class="n">scope</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">SFunction</span> <span class="n">function</span> <span class="p">=</span> <span class="n">first</span><span class="p">.</span><span class="n">Value</span> <span class="p">==</span> <span class="s">&quot;(&quot;</span> <span class="p">?</span> <span class="p">(</span><span class="n">SFunction</span><span class="p">)</span><span class="n">first</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">SFunction</span><span class="p">)</span><span class="n">scope</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">first</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
</span><span class='line'>                <span class="kt">var</span> <span class="n">arguments</span> <span class="p">=</span> <span class="n">current</span><span class="p">.</span><span class="n">Children</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">)).</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>                <span class="n">SFunction</span> <span class="n">newFunction</span> <span class="p">=</span> <span class="n">function</span><span class="p">.</span><span class="n">Update</span><span class="p">(</span><span class="n">arguments</span><span class="p">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">newFunction</span><span class="p">.</span><span class="n">IsPartial</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">return</span> <span class="n">newFunction</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">();</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">current</span> <span class="p">=</span> <span class="n">newFunction</span><span class="p">.</span><span class="n">Body</span><span class="p">;</span>
</span><span class='line'>                    <span class="n">scope</span> <span class="p">=</span> <span class="n">newFunction</span><span class="p">.</span><span class="n">Scope</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>一些演示</h4>

<p>基本的运算</p>

<p><img src="http://i.imgur.com/3417GE2.jpg" alt="基本的运算" /></p>

<p>高阶函数</p>

<p><img src="http://i.imgur.com/47a7jhf.jpg" alt="高阶函数" /></p>

<h2>回顾</h2>

<h3>小结</h3>

<p>除去注释（貌似没有注释-_-），iScheme的解释器的实现代码一共333行——包括空行，括号等元素。</p>

<p>在这300余行代码里，实现了函数式编程语言的大部分功能：算术|逻辑|运算，嵌套作用域，顺序语句，控制语句，递归，<a href="http://zh.wikipedia.org/wiki/%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0">高阶函数</a>，<a href="http://zh.wikipedia.org/wiki/%E9%83%A8%E5%88%86%E6%B1%82%E5%80%BC">部分求值</a>。</p>

<p>与我两年之前实现的Scheme方言<a href="http://www.cnblogs.com/figure9/archive/2011/07/10/2102613.html">Lucida</a>相比，iScheme除了没有字符串类型，其它功能和Lucida相同，而代码量只是前者的八分之一，编写时间是前者的十分之一（Lucida用了两天，iScheme用了一个半小时），可扩展性和易读性均秒杀前者。这说明了：</p>

<ol>
<li>代码量不能说明问题。</li>
<li>不同开发者生产效率的差别会非常巨大。</li>
<li>这两年我还是学到了一点东西的。-_&ndash;</li>
</ol>


<h3>一些设计决策</h3>

<h4>使用扩展方法提高可读性</h4>

<p>例如，通过定义<code>OrThrows</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">OrThrows</span><span class="p">(</span><span class="k">this</span> <span class="n">Boolean</span> <span class="n">condition</span><span class="p">,</span> <span class="n">String</span> <span class="n">message</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(!</span><span class="n">condition</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="n">message</span> <span class="p">??</span> <span class="s">&quot;WTF&quot;</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>写出流畅的断言：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">(</span><span class="n">a</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">).</span><span class="n">OrThrows</span><span class="p">(</span><span class="s">&quot;Value must be less than 3.&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4>声明式编程风格</h4>

<p>以<code>Main</code>函数为例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">cmdArgs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">new</span> <span class="nf">SScope</span><span class="p">(</span><span class="n">parent</span><span class="p">:</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Evaluate</span><span class="p">&lt;</span><span class="n">SNumber</span><span class="p">&gt;(</span><span class="n">scope</span><span class="p">).</span><span class="n">Sum</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">)))</span>
</span><span class='line'>        <span class="c1">// Other build</span>
</span><span class='line'>        <span class="p">.</span><span class="n">BuildIn</span><span class="p">(</span><span class="s">&quot;empty?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">args</span><span class="p">.</span><span class="n">RetrieveSList</span><span class="p">(</span><span class="s">&quot;empty?&quot;</span><span class="p">).</span><span class="n">Count</span><span class="p">()</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">KeepInterpretingInConsole</span><span class="p">((</span><span class="n">code</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">code</span><span class="p">.</span><span class="n">ParseAsIScheme</span><span class="p">().</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">scope</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>非常直观，而且</p>

<ul>
<li>如果需要添加新的操作，添加写一行<code>BuildIn</code>即可。</li>
<li>如果需要使用其它语法，替换解析函数<code>ParseAsIScheme</code>即可。</li>
<li>如果需要从文件读取代码，替换执行函数<code>KeepInterpretingInConsole</code>即可。</li>
</ul>


<h3>不足</h3>

<p>当然iScheme还是有很多不足：</p>

<p>语言特性方面：</p>

<ol>
<li>缺乏实用类型：没有<code>Double</code>和<code>String</code>这两个关键类型，更不用说复合类型（Compound Type）。</li>
<li>没有IO操作，更不要说网络通信。</li>
<li>效率低下：尽管去除尾递归挽回了一点效率，但iScheme的执行效率依然惨不忍睹。</li>
<li>错误信息：错误信息基本不可读，往往出错了都不知道从哪里找起。</li>
<li>不支持延续调用（Call with current continuation，即call/cc）。</li>
<li>没有并发。</li>
<li>各种bug：比如可以定义文本量，无法重载默认操作，空括号被识别等等。</li>
</ol>


<p>设计实现方面：</p>

<ol>
<li>使用了可变（Mutable）类型。</li>
<li>没有任何注释（因为觉得没有必要 &ndash;_-）。</li>
<li>糟糕的类型系统：Lisp类语言中的数据和程序可以不分彼此，而iScheme的实现中确把数据和程序分成了<code>SObject</code>和<code>SExpression</code>，现在我依然没有找到一个融合他们的好办法。</li>
</ol>


<p>这些就留到以后慢慢处理了 &ndash;_-（TODO YOUR ASS）</p>

<h2>延伸阅读</h2>

<h3>书籍</h3>

<ol>
<li>Compilers: Priciples, Techniques and Tools Principles: <a href="http://www.amazon.co.uk/Compilers-Principles-Techniques-V-Aho/dp/1292024348/">http://www.amazon.co.uk/Compilers-Principles-Techniques-V-Aho/dp/1292024348/</a></li>
<li>Language Implementation Patterns: <a href="http://www.amazon.co.uk/Language-Implementation-Patterns-Domain-Specific-Programming/dp/193435645X/">http://www.amazon.co.uk/Language-Implementation-Patterns-Domain-Specific-Programming/dp/193435645X/</a></li>
<li>*The Definitive ANTLR4 Reference: <a href="http://www.amazon.co.uk/Definitive-ANTLR-4-Reference/dp/1934356999/">http://www.amazon.co.uk/Definitive-ANTLR-4-Reference/dp/1934356999/</a></li>
<li>Engineering a compiler: <a href="http://www.amazon.co.uk/Engineering-Compiler-Keith-Cooper/dp/012088478X/">http://www.amazon.co.uk/Engineering-Compiler-Keith-Cooper/dp/012088478X/</a></li>
<li>Flex &amp; Bison: <a href="http://www.amazon.co.uk/flex-bison-John-Levine/dp/0596155972/">http://www.amazon.co.uk/flex-bison-John-Levine/dp/0596155972/</a></li>
<li>*Writing Compilers and Interpreters: <a href="http://www.amazon.co.uk/Writing-Compilers-Interpreters-Software-Engineering/dp/0470177071/">http://www.amazon.co.uk/Writing-Compilers-Interpreters-Software-Engineering/dp/0470177071/</a></li>
<li>Elements of Programming: <a href="http://www.amazon.co.uk/Elements-Programming-Alexander-Stepanov/dp/032163537X/">http://www.amazon.co.uk/Elements-Programming-Alexander-Stepanov/dp/032163537X/</a></li>
</ol>


<p>注：带*号的没有中译本。</p>

<h3>文章</h3>

<p>大多和编译前端相关，自己没时间也没能力研究后端。-_&ndash;</p>

<p>为什么编译技术很重要？看看Steve Yegge（没错，就是被王垠黑过的Google高级技术工程师）是怎么说的（需要翻墙）。</p>

<p><a href="http://steve-yegge.blogspot.co.uk/2007/06/rich-programmer-food.html">http://steve-yegge.blogspot.co.uk/2007/06/rich-programmer-food.html</a></p>

<p>本文重点参考的Peter Norvig的两篇文章：</p>

<ol>
<li>How to write a lisp interpreter in Python: <a href="http://norvig.com/lispy.html">http://norvig.com/lispy.html</a></li>
<li>An even better lisp interpreter in Python: <a href="http://norvig.com/lispy2.html">http://norvig.com/lispy2.html</a></li>
</ol>


<p>几种简单实用的语法分析技术：</p>

<ol>
<li>LL(k) Parsing：

<ul>
<li><a href="http://eli.thegreenplace.net/2008/09/26/recursive-descent-ll-and-predictive-parsers/">http://eli.thegreenplace.net/2008/09/26/recursive-descent-ll-and-predictive-parsers/</a></li>
<li><a href="http://eli.thegreenplace.net/2009/03/20/a-recursive-descent-parser-with-an-infix-expression-evaluator/">http://eli.thegreenplace.net/2009/03/20/a-recursive-descent-parser-with-an-infix-expression-evaluator/</a></li>
<li><a href="http://eli.thegreenplace.net/2009/03/14/some-problems-of-recursive-descent-parsers/">http://eli.thegreenplace.net/2009/03/14/some-problems-of-recursive-descent-parsers/</a></li>
</ul>
</li>
<li>Top Down Operator Precendence：<a href="http://javascript.crockford.com/tdop/tdop.html">http://javascript.crockford.com/tdop/tdop.html</a></li>
<li>Precendence Climbing Parsing：<a href="http://en.wikipedia.org/wiki/Operator-precedence_parser">http://en.wikipedia.org/wiki/Operator-precedence_parser</a></li>
</ol>


<h2>关于本文作者</h2>

<p>曾经的Windows/.Net/C#程序员，研究生毕业后糊里糊涂变成Linux/Java开发者。所谓一入Java深似海，现在无比怀念使用C#的岁月。</p>

<p>对解释器/编译器感兴趣，现在正在自学Coursera的<a href="https://class.coursera.org/compilers-004">Compiler课程</a>。</p>

<p>欢迎来信交流技术：lunageek#gmail#com</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[如何阅读书籍]]></title>
    <link href="http://lucida.github.io/blog/on-reading-books/"/>
    <updated>2014-03-15T20:05:35+00:00</updated>
    <id>http://lucida.github.io/blog/on-reading-books</id>
    <content type="html"><![CDATA[<h1>如何阅读书籍</h1>

<h2>摘要</h2>

<p>这篇文章从如何阅读书籍出发，简单讨论了如何选择书籍、是否阅读原版和阅读数量这几个常见问题，然后自己的阅读问题进行了分析和总结。</p>

<h2>注意</h2>

<ol>
<li>“如何阅读”指“What to read”而非“How to read”，Mortimer J. Adler的<a href="http://book.douban.com/subject/1013208/">怎样阅读一本书</a>对How to read有着精彩的描述。</li>
<li>“书籍”指非小说（Non-fiction）类书籍。</li>
</ol>


<h2>目标</h2>

<p>我是一个功利主义者（<a href="http://en.wikipedia.org/wiki/Utilitarianism">Utilitarianism</a>），因此我认为阅读的目标在于为自己创造实际价值，所以：</p>

<ol>
<li>我不会因为某本书看起来很有趣就去阅读（机会成本）。</li>
<li>也不会因为很多人推荐某本书就去阅读（从众）。</li>
<li>更不会因为某本书难就去阅读（追求智商优越感）</li>
</ol>


<p>一本书值得阅读，当且仅当：</p>

<ol>
<li>它可以直接为我创造价值。</li>
<li>它可以间接为我创造价值。</li>
</ol>


<p>我的阅读目标：</p>

<blockquote><p>形成T型知识结构：专业知识尽可能深入，专业周边知识尽可能精炼。</p></blockquote>

<h2>如何选择？</h2>

<h3>专业书籍</h3>

<blockquote><p>专业知识尽可能深入。</p></blockquote>

<p>我是一个软件开发者（Software Developer），因此这里的专业书籍均和软件开发有关。</p>

<p>这里介绍我自己用的两种方法：</p>

<h4>根据引用列表</h4>

<p>从一本经典书籍出发，深度优先遍历它的引用列表，通过书评和摘要了解这些引用书籍，再根据自己的实际情况决定自己的阅读次序。</p>

<p>这里以<a href="http://book.douban.com/subject/1477390/">代码大全</a>为例（为了方便和一致性，这里使用英文书名）：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Code Complete：软件构建全程最佳实践指南。
</span><span class='line'>|
</span><span class='line'>|----How to Solve it：系统解决问题。
</span><span class='line'>|
</span><span class='line'>|----Conceptual Blockbusting：跳出思维的壁垒。
</span><span class='line'>|
</span><span class='line'>|----Mythical Man Month：软件工程不能做什么。
</span><span class='line'>|
</span><span class='line'>|----Programming Pearls：极简算法手册。
</span><span class='line'>     |
</span><span class='line'>     |----The Science of Programming：编写正确的程序。
</span><span class='line'>     |
</span><span class='line'>     |----Writing Efficient Programs：编写高效的程序。
</span><span class='line'>|
</span><span class='line'>|----Pragmatic Programmer：高效程序员的实践。
</span><span class='line'>|
</span><span class='line'>|----Refactoring：如何改进自己的代码。
</span><span class='line'>|
</span><span class='line'>|----Programming on Purposes：用正确的编程模式处理问题。
</span><span class='line'>|
</span><span class='line'>|----Software Tools：用合适的抽象封装复杂度。
</span><span class='line'>     |
</span><span class='line'>     |----The Practice of Programming：极简编程风格指南。
</span><span class='line'>          |
</span><span class='line'>          |---- Writing Solid Code：减少调试的时间。
</span><span class='line'>          |
</span><span class='line'>          |---- Elements of Programming Style：极简编程风格指南。</span></code></pre></td></tr></table></div></figure>


<p>可以发现，通过<a href="http://book.douban.com/subject/1477390/">代码大全</a>一本书，经过短短两层引用联系，几乎可以找到2004年以前所有软件开发的经典书籍。事实上，我阅读的80%以上的软件开发经典书籍，都源自于<a href="http://book.douban.com/subject/1477390/">代码大全</a>的引用列表。</p>

<p>这种方法的好处：</p>

<ul>
<li>简单直接：相对于从茫茫书海里找出10本经典书籍，找1本经典书籍再从它的引用列表里面找到20本经典书籍要容易的多。</li>
<li>质量保证：靠谱书籍的引用书籍的质量一般都很高。</li>
<li>发现一些被忽视的经典：相当一部分的书籍随着时间的流逝而淡出人们的视野，但这并不代表它们本身没有价值，例如：

<ul>
<li><a href="http://book.douban.com/subject/1989284/">Programming on Purposes</a></li>
<li><a href="http://book.douban.com/subject/1815459/">Software Tools</a></li>
<li><a href="http://book.douban.com/subject/2350559/">The Science of Programming</a></li>
<li><a href="http://book.douban.com/subject/1456967/">Writing Solid Code</a></li>
<li><a href="http://book.douban.com/subject/1768600/">Writing Efficient Programs</a></li>
<li>等等&hellip; 这些书或者绝版，但它们都对我的软件开发理念产生了巨大影响。</li>
</ul>
</li>
<li>形成知识体系：引用书籍彼此具有天然的联系，这使得创建知识体系更加容易。</li>
</ul>


<p>我认为这种方法适用于任何需要严肃阅读的领域：</p>

<ol>
<li>锚点：找到一本经典书籍。</li>
<li>撒网：了解该书引用列表中的书籍。</li>
<li>收网：根据自己实际需要，精读相关书籍。</li>
</ol>


<h4>根据作者</h4>

<p>这里以计算机书籍为例（以下仅代表个人口味）：</p>

<ol>
<li>Richard Stevens：善。</li>
<li>Brian Kernighan：极善。</li>
<li>Deitel Series：翔。</li>
<li>Bruce Eckel：废话连篇。</li>
<li>Jon Bentley：善。</li>
<li>Andrew S Tanenbaum：大善。</li>
<li>Jeffrey D Ullman：善。</li>
<li>P.J. Plauger：大善。</li>
<li>Robert C Martin：善。</li>
<li>Bjarne Stroustrup：善，但略神叨（神侃世界观方法论有点顶不住）。</li>
<li>Martin Fowler：善，但略唠叨。</li>
<li>Ron Jeffries：翔（好吧我是故意来黑的，尼玛连个<a href="http://devgrind.com/2007/04/25/how-to-not-solve-a-sudoku/">Sudoku</a>都解不出来写毛程序）</li>
</ol>


<p>这种方法的问题在于需要一定阅读经验，但是它非常有效——以至于不用看内容就对书的质量有七八成把握。</p>

<h3>非本专业书籍</h3>

<blockquote><p>专业周边知识尽可能精炼。</p></blockquote>

<ol>
<li>对于专业周边知识，了解关键概念及指导思想即可。</li>
<li>不需要，也没有必要对专业周边知识进行深入了解。</li>
<li>&ldquo;Know what&rdquo; is enough, &ldquo;Know how&rdquo; is expensive.</li>
</ol>


<p>以我2年前编写手机应用，学习用户体验为例：</p>

<ol>
<li>分别在现实中（身边有几个很不错的交互设计师）和线上（Quora和知乎）进行提问和搜索，得到一个书单。</li>
<li>按照下面的原则过滤书单：

<ul>
<li>去掉教科书和大部头。</li>
<li>去掉包含大量原理或论证的书籍。</li>
<li>保留结论型书籍。</li>
<li>保留指南型书籍。</li>
</ul>
</li>
<li>总结出书单，迅速的阅读并找到关键点。

<ul>
<li><a href="http://book.douban.com/subject/3323633/">给大家看的设计书</a>：CRAP原则，字体与配色。</li>
<li><a href="http://book.douban.com/subject/4606471/">设计心理学</a>：心智模型，心智摩擦，最小惊讶。</li>
<li><a href="http://book.douban.com/subject/1493316/">交互设计之路</a>：为什么需要交互，交互有哪些坑。</li>
<li><a href="http://book.douban.com/subject/4254166/">Tapworthy</a>：具有实际操作性的移动平台交互设计指南。</li>
</ul>
</li>
</ol>


<p>了解设计的人可能认为上面的书单过于初级——没错，它们都是结论型或指南型书籍，没有原理，也没有论证——但这正是对于我这样的非专业者所需要的书籍：我不需要知道这些知识是怎么来的，知道怎么用足矣。</p>

<p>此外，受价值驱动，而非兴趣——大多数情况下兴趣只是把自己脱离当前困境的接口。</p>

<h3>学习型书籍</h3>

<p>学习型书籍是一种元（Meta）方法书籍：这类书籍用于提升学习能力，换句话说，就是缩短吸收知识所需要的时间。</p>

<p>这类书籍我只读过下面的几本，效果有但不明显：</p>

<ul>
<li><a href="http://book.douban.com/subject/2345548/">学习之道</a>：冥想，体会。</li>
<li><a href="http://book.douban.com/subject/1013208/">如何阅读一本书</a>：检视阅读，主题阅读。</li>
<li><a href="http://www.scotthyoung.com/learnmorestudyless/">Learn more, study less</a>：建立知识体系及联系。</li>
</ul>


<p>需要注意的是，不要陷入到寻求最优学习方法的误区——Best is the worthest enemy of better。</p>

<h2>阅读原版？</h2>

<h3>如何在翻译版和原版做选择？</h3>

<ol>
<li>优先选择翻译版。计算机书籍这种描述精确知识的书籍更是如此。</li>
<li>此外，如果阅读中出现难以理解的问题，不要下意识的把其归咎于翻译问题——多数情况是理解问题。</li>
</ol>


<h3>为什么还有那么多人阅读原版？</h3>

<ol>
<li>因为翻译版还没出版。</li>
<li>知识的价值有其时效性。</li>
<li>逼格。</li>
</ol>


<h2>越多越好？</h2>

<p>我经常逛豆瓣，豆瓣有一个很有意思的现象就是人们喜欢去比较自己每年读书的数量，或者是截图炫耀自己读过几千本书云云。</p>

<p>我在这里酸一下：书的数量并没有什么参考价值，就好比无法用盖一栋大楼的砖数评价这栋大楼的质量；换个说法，Effort不等于Progress。</p>

<blockquote><p>关键在于读过书的质量，吸收的程度，以及创造的价值。</p></blockquote>

<p>此外，盲目追求读书的数量会带来另一个问题——浅尝辄止。本应花在专业书籍上的时间被分配到其它无关紧要的事情上，导致该学好的没学好，没必要的学了一滩但用不上。</p>

<h2>总结</h2>

<ol>
<li>形成T型知识结构：专业知识尽可能深入，专业周边知识尽可能精炼。

<ul>
<li>按照引用列表和作者深入阅读专业书籍。</li>
<li>利用结论型/指南型书籍精炼阅读专业周边书籍。</li>
<li>不断强化自己的按需学习能力。</li>
</ul>
</li>
<li>不一定非要阅读原版。</li>
<li>读书并非多多益善。</li>
<li>读书之前回答下面几个问题：

<ul>
<li>这本书能给自己带来什么改变？</li>
<li>自己是否需要这种改变？</li>
<li>如果均为Yes，继续；如果有一个No，砍掉。</li>
</ul>
</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[网络上瘾及其解决方法]]></title>
    <link href="http://lucida.github.io/blog/on-suppressing-the-internet-addiction/"/>
    <updated>2014-03-09T17:14:28+00:00</updated>
    <id>http://lucida.github.io/blog/on-suppressing-the-internet-addiction</id>
    <content type="html"><![CDATA[<h1>网络上瘾及其解决方法</h1>

<h2>症状</h2>

<h3>起床后</h3>

<p>拿起手机，微博->论坛A->论坛B->知乎->人人，大概20分钟。</p>

<h3>工作中</h3>

<p>大概每隔半小时刷一下微博或论坛，点进去看两分钟再切回来。</p>

<h3>睡觉前</h3>

<p>拿起手机，微博->论坛A->论坛B->知乎->人人->草榴（-_-），大概30分钟。</p>

<h2>原因</h2>

<h3>智能手机带来的极其便利的信息可访问性</h3>

<p>平板和智能手机使互联网的可访问性（accessibility）提升了至少两个数量级——三年前我的NOKIA E51只能在WIFI环境下浏览简单的文字信息，而现在我的iPhone5可以无时无刻的阅读/观看互联网上几乎所有的信息，得益于4G，即便是包含大量图片甚至视频的信息也可以轻松阅读。</p>

<h3>碎片化时间不知如何处理</h3>

<p>无论是工作还是学习，都会有疲倦或无聊的时刻，大概10分钟左右。</p>

<p>微博这种碎片化信息的出现正好填补了碎片化时间。但比较恶心的是这种东西会上瘾——慢慢的它会占据越来越多的时间：清晨，睡眠甚至路上和正常阅读的时间。</p>

<h3>长时间从事同一种工作带来的无聊感</h3>

<p>无论多么有激情有兴趣，长时间从事同一种工作总会无聊的，低智力门槛的社交网络就成了一个打发时间的好选择。</p>

<p>然后时间就都耗里面了。-_&ndash;</p>

<h2>现实 V.S. 虚拟</h2>

<p>人是社会性动物，社会性动物通过与其他对象建立联系来确定自己的存在感，也就是交流（Communication），现实和虚拟中都是如此。交流包括一对一交流和一对多交流：现实中，一对一交流通过谈话/电话/信件，一对多交流通过电视/广播；虚拟中，一对一交流通过IM（Instant Messenger），一对多交流通过微博/论坛/博客。</p>

<h3>一对一交流：</h3>

<ol>
<li>现实中，一对一交流通过谈话/电话/信件，一对一交流通过IM（Instant Messenger）。</li>
<li>现实的一对一交流大多无状态——双方的交流同时开始，同时结束。虚拟的一对一交流大多有状态——双方的交流可以从某一方开始，然后若干小时后另一方看到消息回复，然后如此继续。</li>
<li>现实中的一对一交流需要考虑对方的状态——也就是交流需要建立在双方都有时间的基础上；虚拟的一对一交流无需考虑对方的状态，有意交流的一方可以随时给对方发送信息。</li>
</ol>


<p>虚拟带来的问题：</p>

<ol>
<li>任何人都可以与你交流，无论你愿意与否。</li>
<li>你可以与任何人交流，无论是否值得。</li>
<li>可能会陷入一种等待交流的焦虑中。</li>
</ol>


<h3>一对多交流：</h3>

<ol>
<li>现实的一对多交流需要大量人力物力（广播/电视/报纸），虚拟的一对多交流几乎零成本（微博/博客/社交网络）。</li>
<li>现实的一对多交流需要信息审核/证伪，虚拟的一对多交流几乎没有信息审核。</li>
<li>现实的一对多交流中接收方是完全被动的，虚拟的一对多交流接收方和广播方之间可以有交互。</li>
</ol>


<p>虚拟带来的问题：</p>

<ol>
<li>没有审核带来的大量低质量无意义信息（通常会以一种很有趣或是令人热血沸腾的形式出现）。</li>
<li><a href="http://book.douban.com/subject/1012611/">乌合之众</a>，最热门的信息不是最有价值的，而是吵的最响（或是争议最多）的。</li>
<li>与广播方（例如名人）的交流会带来成就感，也会使自己陷入等待回复的焦虑中。</li>
<li>可能会陷入一种不断查看新信息（尽管这些信息毫无意义）的焦虑中。</li>
</ol>


<h2>解决方法</h2>

<p>为此在豆瓣阅读买了一本<a href="http://book.douban.com/subject/24383461/">网络素养</a>，原版：<a href="http://www.amazon.com/Net-Smart-How-Thrive-Online/dp/0262526131/">Net Smart: How to thrive online</a>。</p>

<p><img src="http://img5.douban.com/lpic/s26842036.jpg" title="网络素养" alt="网络素养" /></p>

<p><img src="http://ecx.images-amazon.com/images/I/41LRFD-SVlL._BO2,204,203,200_PIsitb-sticker-arrow-click,TopRight,35,-76_SX385_SY500_CR,0,0,385,500_SH20_OU02_.jpg" title="Net Smart" alt="Net Smart" /></p>

<p>这本书废话极多，关键的两点：控制注意力，鉴别垃圾信息。</p>

<h3>控制注意力</h3>

<ul>
<li>下意识的控制注意力，可以通过关注自己的呼吸来调节。</li>
<li>即便忽略几条微博几条信息，也不会对生活造成多大影响。</li>
<li>此外可以使用冥想提升自己的集中力（Focus）。</li>
<li>番茄工作法（没看明白要点，25分钟休息一次是什么原理，如果这样岂不是更不靠谱）。</li>
</ul>


<h3>鉴别垃圾信息</h3>

<ul>
<li>冷静面对夸张的标题，此类信息一般有意断章取义，或是掩盖上下文。</li>
<li>恰当的使用三点式验证争议信息：使用三个不同可信来源验证信息的有效性。</li>
<li>选取可信/有效/有价值的信息来源，屏蔽哗众取宠/断章取义的信息源。</li>
</ul>


<h3>集中时间处理社交网络</h3>

<ul>
<li>在固定的时间段（例：12:40 &ndash; 13:10, 20:20 &ndash; 21:00）处理社交网络信息，而非随时随地的查看状态。</li>
<li>如有特别需求，可以编写Crawler来发送Reminder邮件，替代人工轮询。</li>
</ul>


<h2>用不上瘾的行为填充碎片化时间</h2>

<p>碎片化时间可以进行其它益智或体育活动，包括但不限于：</p>

<ul>
<li>拆解/还原九连环。</li>
<li>单手还原魔方。</li>
<li>背诵单词。</li>
<li>绘画。</li>
<li>乒乓。</li>
<li>桌球。</li>
</ul>


<h2>尝试其它活动</h2>

<p>为了得到新鲜感，包括但不限于：</p>

<ul>
<li>学习自己感兴趣但不了解的技术（例如ANTLR）或学科（例如经济/心理学）。</li>
<li>尝试集体运动（例如攀岩，射箭）。</li>
<li>尝试旅行（例如在周末去荷兰、芬兰或瑞典进行两日游）。</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[TARQIE——一种量化成长的方法（上）]]></title>
    <link href="http://lucida.github.io/blog/tarqie-a-quantized-continous-growing-approach/"/>
    <updated>2014-03-02T23:31:27+00:00</updated>
    <id>http://lucida.github.io/blog/tarqie-a-quantized-continous-growing-approach</id>
    <content type="html"><![CDATA[<h1>TARQIE——一种量化成长的方法（上）</h1>

<h2>问题</h2>

<p>工作到现在大概三个多月，但始终感觉有些不对——没有之前高速成长的感觉，换句话说，就是感觉自己相比三个月之前没有多大进步。</p>

<p>这是一个很危险的讯息——如果三个月还没感受到实质性的成长，那么就相当于倒退，尤其还是在Google这种奇人遍地的公司。</p>

<p>反复思考后发现自己现在掉到几个怪圈里——</p>

<h3>选择瘫痪（Analysis Paralysis）</h3>

<ol>
<li>想做事情A，做了一小半。</li>
<li>想做事情B。</li>
<li>发现事情C也有必要搞。</li>
<li>结果A，B，C都没有搞定。</li>
<li>陷入深深的自责。</li>
<li>回到步骤A。</li>
</ol>


<h3>呆滞沉浸（Dumb Dump）</h3>

<ol>
<li>看着电脑屏幕发呆。</li>
<li>或者不停的刷微博。</li>
<li>或者开始看一部早已经看过的美剧。</li>
<li>或者撸来撸去。</li>
<li>总之就是一种知道不该继续但又停不下来的感觉。-_&ndash;</li>
</ol>


<h3>拖延（Procrastination）</h3>

<ol>
<li>无法持续一件事情。（比如看书或是锻炼）</li>
<li>缺乏行动力，做事之前束手束脚。</li>
</ol>


<h2>分析</h2>

<p>回想自己过去并不是这个样子——不断成长（Continuous Growing）是自己过去几年的关键字，某种上来所自己有一种强迫症，极端的说：</p>

<blockquote><p>如果自己大脑里面一半都是半年以前的东西，那么证明自己这半年什么都没做。</p></blockquote>

<p>但自己现在处于一个更好的环境，没有理由比之前做的差。于是我决定从之前的成功经历里找到答案，试着用简短的关键字回顾自己前10年的几个关键点：</p>

<h3>关键点（Milestones）</h3>

<h4>高考</h4>

<ul>
<li>目标

<ol>
<li>考上一个不错的大学。</li>
</ol>
</li>
<li>量化

<ol>
<li>考到年级60名以内。</li>
<li>或者是班级第一。</li>
</ol>
</li>
<li>改进

<ol>
<li>海量习题练习。</li>
<li>规律作息。</li>
<li>每天至少踢腿二十分钟。</li>
</ol>
</li>
<li>验证

<ol>
<li>月考成绩。</li>
<li>模拟成绩。</li>
</ol>
</li>
</ul>


<h4>考研</h4>

<ul>
<li>目标

<ol>
<li>考上北航计算机系。</li>
</ol>
</li>
<li>量化

<ol>
<li>超过提档线50分。</li>
</ol>
</li>
<li>改进

<ol>
<li>海量习题练习。</li>
<li>规律作息。</li>
<li>禁欲（即停止手淫，保存精力）。</li>
</ol>
</li>
<li>验证

<ol>
<li>前期：监测学习进度。</li>
<li>后期：各种模拟试卷，给自己打分。</li>
</ol>
</li>
</ul>


<h4>找工作</h4>

<ul>
<li>目标

<ol>
<li>找到一个不错的外企工作。</li>
</ol>
</li>
<li>量化

<ol>
<li>解答Top Coder D2L1和D1L2区段的题目。</li>
<li>在纸上流畅写出可运行的算法C代码。</li>
</ol>
</li>
<li>改进

<ol>
<li>每天练习Top Coder一道大题，若干道小题。</li>
<li>用EOP的思路编写纸上代码。</li>
</ol>
</li>
<li>验证

<ol>
<li>找到MS正式员工为自己做模拟面试+评估。</li>
<li>独立解答CareerCup上7成以上的编程题目。</li>
<li>不断拿到新的Offer。</li>
</ol>
</li>
</ul>


<h3>总结</h3>

<p>我惊奇的发现自己找到了一个和《机器学习》里几乎雷同的模型：</p>

<ul>
<li>目标（TARget）：一个清晰的目标。</li>
<li>量化（Quantization）：该目标可以被量化成具体数据。</li>
<li>改进（Improvement）：有一种或几种改进途径不断接近目标。</li>
<li>验证（Evaluation）：有一种或几种验证方法确认（Verify）自己正在接近目标。</li>
</ul>


<p>综合到一起——TARQIE，即标题里这个奇怪的词汇（很高兴这个词压根不存在）。</p>

<h2>应用</h2>

<p>根据自己的现状，对自己的工作和生活（或学习），分别创建对应的Tarqie模型，这里我称其为Tarqie-J（ob）和Tarqie-L（ife）。</p>

<h3>Tarqie-J</h3>

<ul>
<li>目标

<ol>
<li>高效完成Q1 OKR。</li>
</ol>
</li>
<li>量化

<ol>
<li>成功迁移124个Test。</li>
<li>为这些Test配置一个可稳定运行的环境。</li>
</ol>
</li>
<li>改进

<ol>
<li>恬着脸皮向不同的同事请教。</li>
<li>理解当前Test的架构和流程。</li>
<li>阅读The Art Of Unit Test，Guice Book和GuiceBerry Manual，了解如何用Guice写良好的Test。</li>
<li>阅读Java Best Practices和Effective Java。</li>
<li>阅读Java Performance，了解JVM。</li>
</ol>
</li>
<li>验证

<ol>
<li>每周与mentor交流，进行进度控制/难点求助。</li>
<li>Test的数量不断增加。</li>
<li>CL中review的数量持续降低。</li>
<li>逐步理解项目代码背后的机理。</li>
</ol>
</li>
</ul>


<h3>Tarqie-L</h3>

<ul>
<li>目标

<ol>
<li>提高精力，理解Python。</li>
</ol>
</li>
<li>量化

<ol>
<li>精力提高（自然醒，不赖床）。</li>
<li>熟悉Python及其实现。</li>
<li>理解4个开源项目的架构。</li>
</ol>
</li>
<li>改进

<ol>
<li>早睡早起（11:30 PM ~ 8:30 AM）+每天运动20分钟。</li>
<li>阅读相关技术书籍（Python源码剖析，开源项目架构等）。</li>
<li>增强学习能力（阅读《Study Less, Learn More》）</li>
<li>控制手淫频率至两周一次。</li>
</ol>
</li>
<li>验证

<ol>
<li>早睡早起+运动不间断。</li>
<li>学习能力增强（+系统学习能力）。</li>
<li>逐步理解Python各个部分的实现（对象，语句，元组，列表，字典，控制流，异常，自定义类型，列表理解，生成器，模块，从源码了解其机制）。</li>
<li>每周理解1个开源项目的架构。</li>
</ol>
</li>
</ul>


<h2>实验</h2>

<h3>内容</h3>

<p>在接下来的一个月（2014年3月），分别应用Tarqie-J和Tarqie-L到自己的工作和学习中。</p>

<h3>假设</h3>

<ol>
<li>效率比之前提升50%。</li>
<li>掌握两样新技能。</li>
</ol>


<h3>实验开始</h3>

<h2>未完待续</h2>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[从挣钱的角度回忆下自己的研究生三年]]></title>
    <link href="http://lucida.github.io/blog/memoirs-on-my-postgraduate-life/"/>
    <updated>2014-02-16T22:08:39+00:00</updated>
    <id>http://lucida.github.io/blog/memoirs-on-my-postgraduate-life</id>
    <content type="html"><![CDATA[<h2>2010年9月 &ndash; 2010年12月</h2>

<h3>主要事项</h3>

<ul>
<li>09月：研究生入学。。</li>
<li>10月：认真学习计算机专业基础。</li>
<li>11月：认真学习计算机专业基础。</li>
<li>12月：认真学习计算机专业基础。</li>
</ul>


<h3>收入来源</h3>

<ul>
<li>二等奖学金（￥270/月 * 3）</li>
<li>学校研究生补贴（￥200/月 * 3）</li>
</ul>


<p>总计收入：￥1,410</p>

<h2>2011年1月 &ndash; 2011年12月</h2>

<h3>主要事项</h3>

<ul>
<li>01月：玩iPad。</li>
<li>02月：玩iPad。</li>
<li>03月：糊里糊涂参加了某.NET大师的技术演讲并成为现场口译，得到某司的实习机会和某社的译书机会。</li>
<li>04月：听译某印度大师等访谈，痛不欲生。</li>
<li>05月

<ul>
<li>实习（做Code Coverage Analysis）</li>
<li>由于三周完成了原定三个月的项目，mentor表示你可以看看书调调研啥的，别捣乱就成。</li>
<li>实习（看书）。</li>
</ul>
</li>
<li>06月：实习（看书）。</li>
<li>07月

<ul>
<li>实习（看书）。</li>
<li>完成某js书籍的翻译。</li>
</ul>
</li>
<li>08月：实习（看书）。</li>
<li>09月：实习（看书）。</li>
<li>10月

<ul>
<li>退出实习。</li>
<li>玩iPod Touch。</li>
</ul>
</li>
<li>11月：加入某创业团队。</li>
<li>12月

<ul>
<li>开题，被老板黑出翔。</li>
<li>撤出创业团队。</li>
<li>开始自己编写手机应用，发布上线半月内进入市场排行TOP20。</li>
</ul>
</li>
</ul>


<h3>收入来源</h3>

<ul>
<li>二等奖学金（￥270/月 * 10）</li>
<li>学校研究生补贴（￥200/月 * 7 + ￥300/月 * 3）</li>
<li>某司实习工资（￥4000/月 * 6）</li>
<li>某社翻译图书一本（￥4200）</li>
<li>听译文章两篇（￥2000）</li>
<li>某创业公司兼职（￥4000 * 1）</li>
<li>编写手机应用（￥0）</li>
</ul>


<p>总计收入：￥39,200</p>

<h2>2012年11月 &ndash; 2012年12月</h2>

<h3>主要事项</h3>

<ul>
<li>01月：编写手机应用。</li>
<li>02月

<ul>
<li>重回某司继续实习（这次搞手机应用）。</li>
<li>认识了两位天赋异禀的设计师，学到大量设计知识。</li>
</ul>
</li>
<li>03月

<ul>
<li>实习。</li>
<li>做成第一份手机应用私活A。</li>
<li>教训惨痛，价值10k+的工作量只收了对方900，学会如何计价私活。</li>
<li>开始制作自己的手机应用生产线。</li>
</ul>
</li>
<li>04月

<ul>
<li>实习。</li>
<li>制作某色情应用，当日收入￥600，但次日即被下架。</li>
<li>完成手机应用生产线初版，在市场外试投放。</li>
</ul>
</li>
<li>05月

<ul>
<li>实习。</li>
<li>手机应用生产线搞定。

<ul>
<li>意味着我可以不用写代码，直接生成手机应用。</li>
<li>也就是说我可以毫不费力的一天&#8221;写&#8221;50+个应用。</li>
<li>投放应用到市场，利用数量+广告盈利。</li>
</ul>
</li>
</ul>
</li>
<li>06月

<ul>
<li>实习。</li>
<li>手机应用私活B。</li>
<li>准备小论文。</li>
</ul>
</li>
<li>07月

<ul>
<li>实习。</li>
<li>发表小论文。</li>
</ul>
</li>
<li>08月

<ul>
<li>实习（看书）。</li>
<li>手机应用私活C。</li>
<li>开始找工作。</li>
</ul>
</li>
<li>09月

<ul>
<li>实习（看书）。</li>
<li>找工作。</li>
</ul>
</li>
<li>10月

<ul>
<li>实习（看书）。</li>
<li>找工作。</li>
<li>准备毕设。</li>
</ul>
</li>
<li>11月

<ul>
<li>实习（看书）。</li>
<li>找到工作。</li>
<li>编写毕设项目。</li>
</ul>
</li>
<li>12月

<ul>
<li>退出实习。</li>
<li>毕业答辩。</li>
</ul>
</li>
</ul>


<h3>收入来源</h3>

<ul>
<li>二等奖学金（￥270/月 * 10）</li>
<li>学校研究生补贴（￥300/月 * 10）</li>
<li>某司实习工资（￥4000/月 * 10）</li>
<li>手机应用私活A（￥900）</li>
<li>手机应用私活B（￥12000）</li>
<li>手机应用私活C（￥15000）</li>
<li>个人手机应用（￥4500 * 10 + ￥600）</li>
</ul>


<p>总计收入：￥119,200</p>

<h2>2013年1月 &ndash; 2013年10月</h2>

<h3>主要事项</h3>

<ul>
<li>01月

<ul>
<li>毕业典礼。</li>
<li>重回某司继续实习（本屌就是闲不下来-_-）</li>
</ul>
</li>
<li>02月

<ul>
<li>实习（这次搞平板应用）。</li>
<li>手机应用私活D。</li>
</ul>
</li>
<li>03月

<ul>
<li>毕业。</li>
<li>某司实习转兼职。</li>
</ul>
</li>
<li>04月

<ul>
<li>某司兼职。</li>
<li>平板应用私活A。</li>
</ul>
</li>
<li>05月

<ul>
<li>某司兼职。

<ul>
<li>面试若干人。</li>
</ul>
</li>
</ul>
</li>
<li>06月

<ul>
<li>某司兼职。</li>
<li>平板应用私活B。</li>
<li>手机应用私活E。</li>
</ul>
</li>
<li>07月

<ul>
<li>某司兼职。</li>
</ul>
</li>
<li>08月

<ul>
<li>某司兼职。</li>
</ul>
</li>
<li>09月

<ul>
<li>实习（看书）。</li>
<li>平板应用私活C。</li>
<li>开始练习日常英语。</li>
</ul>
</li>
<li>10月

<ul>
<li>实习（看书）。</li>
<li>为某C++大师义务口译。</li>
</ul>
</li>
<li>11月

<ul>
<li>正式入职！</li>
</ul>
</li>
</ul>


<h3>收入来源</h3>

<ul>
<li>某司实习工资（￥4000/月 * 2）</li>
<li>某司兼职工资（￥7700/月 * 8）</li>
<li>手机应用私活D（￥12000）</li>
<li>手机应用私活E（￥15000）</li>
<li>平板应用私活A（￥12000）</li>
<li>平板应用项目B（￥10000）</li>
<li>平板应用项目C（￥7000）</li>
<li>个人手机应用（￥3500 * 10）</li>
</ul>


<p>总计收入：￥160,600</p>

<p>三年总收入：￥320,410</p>

<h2>消费的东东</h2>

<p>大多都是屌丝货 &ndash;_&ndash; 可以看到电脑，书籍和耳机占据了非常大的比例。</p>

<p>此外还有电影饭局等若干，不过这些不比实物，实在记不清。</p>

<p>至于衣服本屌一直优衣库，因为只有优衣库有价格标签 &ndash;_&ndash;</p>

<p>AKG</p>

<ul>
<li>K26P ￥200</li>
<li>K324P ￥320</li>
<li>K450 ￥550</li>
<li>K518DJ ￥450</li>
<li>K518LE ￥420</li>
</ul>


<p>LENOVO</p>

<ul>
<li>X200 RY7 ￥7200</li>
<li>YOGA i5 3300 ￥6300</li>
</ul>


<p>SONY</p>

<ul>
<li>A806 ￥900</li>
<li>S739F ￥1300</li>
<li>EX310 * 2 ￥200</li>
<li>A866 ￥1100</li>
<li>S755 ￥550</li>
<li>XB910 ￥650</li>
<li>X10 ￥800</li>
</ul>


<p>JVC</p>

<ul>
<li>M55X ￥400</li>
</ul>


<p>僵尸</p>

<ul>
<li>PR2+阻线 ￥500</li>
<li>PR401 ￥400</li>
<li>PR200 ￥220</li>
<li>PR300MKII ￥320</li>
</ul>


<p>Apple</p>

<ul>
<li>Macbook AIR 11 ￥7200</li>
<li>iPod Touch 4 ￥900</li>
<li>iPod Touch 5 ￥2200</li>
<li>iPhone 5 ￥3700</li>
<li>iPhone 5s ￥5100（送女神）</li>
<li>iPad 1 ￥2500</li>
<li>iPad 4 ￥3000</li>
<li>iPad MINI ￥2500</li>
<li>iPad Air ￥4300</li>
<li>Ear Pod * 2 ￥400</li>
</ul>


<p>NOKIA</p>

<ul>
<li>E70 ￥2550</li>
<li>E51 ￥800</li>
<li>E72i ￥1200</li>
<li>Asha 210 ￥520</li>
<li>Lumia 710 ￥0（活动奖品）</li>
<li>Lumia 1520 ￥4100（送老妈）</li>
</ul>


<p>Logitech</p>

<ul>
<li>TF10 ￥1200</li>
<li>UE BOOM ￥1500</li>
</ul>


<p>Monster Beats</p>

<ul>
<li>Studio ￥1800</li>
</ul>


<p>SOL REPUBLIC</p>

<ul>
<li>V8 黑 ￥900</li>
<li>V10 红 ￥1200</li>
</ul>


<p>漫步者</p>

<ul>
<li>M5 * 2 ￥1100</li>
</ul>


<p>Samsung</p>

<ul>
<li>iGH 907 ￥900</li>
</ul>


<p>购买书籍</p>

<ul>
<li>技术书籍 350余本 约￥28,000</li>
<li>非技术书籍 150余本 约￥6,000</li>
</ul>


<p>总计支出：￥106,350</p>

<h2>小结</h2>

<ul>
<li>三年大约收入：￥320,410</li>
<li>三年消费的电子东东及书籍：￥106,350</li>
<li>剩下的基本都花在吃喝玩。</li>
</ul>


<p>感觉这个数字还不错，应该能到中上水平吧。</p>

<p>最后</p>

<h3>一点经验</h3>

<ul>
<li>网上兼职大多是骗子，尤其是遮遮掩掩不肯说自己到底是干啥的。</li>
<li>兼职要和自己专业相关

<ul>
<li>比如，除非你学的教育专业，否则家教就是一个糟糕透顶的选择。</li>
<li>更不用说学计算机的去兼职卖衣服了，尼玛放着月入上万的活不干尼玛是闹哪样！</li>
</ul>
</li>
<li>码农干私活的建议

<ul>
<li>打听好行情，先定好价格，不要因为自己是学生就不好意思加价。</li>
<li>对对方做充分的信用调研。</li>
<li>事前三成，半成品再三成，最后成品再四成，不到最后时刻，不要交代码。</li>
<li>做的东西要超出对方的期望，这样有助于长期合作。</li>
</ul>
</li>
<li>最后，除非你是高富帅，否则追女神既耗精力又耗钱财，有这个时间不如干点实在的，等自己牛逼了再追女神也不迟。</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[London的新玩具]]></title>
    <link href="http://lucida.github.io/blog/new-toys-in-london/"/>
    <updated>2014-02-15T21:16:16+00:00</updated>
    <id>http://lucida.github.io/blog/new-toys-in-london</id>
    <content type="html"><![CDATA[<h2>Bose Companion 20</h2>

<p>之前一直用<a href="http://www.amazon.com/Ultimate-Ears-Wireless-Bluetooth-Speaker/dp/B00CM0XHNS/">UE Boom</a>，但用久了就感觉声音有些憋屈，考虑到每天至少有一个小时在听音乐，所以搞个不错的印象很有必要。</p>

<p>要求如下：</p>

<ol>
<li>低音带感。</li>
<li>体积小。</li>
<li>外观拉风。</li>
</ol>


<p>Google了几篇Speaker的Review，初步锁定<a href="http://www.amazon.co.uk/Bose-Companion-Series-Multimedia-Speaker/dp/B00CL83JVQ/">Bose Companion2</a>和<a href="http://www.amazon.co.uk/Logitech-980-000659-Z600-Bluetooth-Speakers/dp/B00DUBIZ7G/">Logitech Z600</a>。</p>

<p>不过观察实物时才发现，C2虽然体积合适，但非常丑；Z600虽然外观不错，但比想象的大了一圈。失望之余，意外发现了<a href="http://www.amazon.co.uk/Bose-Companion-Multimedia-Speaker-System/dp/B005EPOFTI/">Bose Companion20</a>。</p>

<p><img src="http://ecx.images-amazon.com/images/I/71RYZKiBvCL._SL1500_.jpg" alt="Bose Companion20" /></p>

<p>金属银的外观和声音都不错，就是价格比预计的多了一倍——199磅，不过还是买了下来，这种天天用的东西有必要好一点。</p>

<h2>IRON GYM+</h2>

<p>为了能够在家做引体向上，所以在Google了一圈Pull up bar，发现最快最稳的方法还是去Decathlon买，于是就从Islington坐Overground去，之后就找到这个<a href="http://www.decathlon.co.uk/iron-gym-chin-up-bar-id_8194140.html">IRON GYM+</a>，正好他们在做活动，20磅买下。</p>

<p><img src="http://www.decathlon.co.uk/media/819/8194140/big_800PX_65269548.jpg" alt="Decathlon IRON GYM+" /></p>

<p>试用了下，还是很结实的，不过现在一个引体向上也做不起来-_&ndash; 不过还好有凳子的辅助。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[关于中国合伙人]]></title>
    <link href="http://lucida.github.io/blog/about-movie-chinese-dream/"/>
    <updated>2014-01-11T12:06:29+00:00</updated>
    <id>http://lucida.github.io/blog/about-movie-chinese-dream</id>
    <content type="html"><![CDATA[<h2>About</h2>

<p>之前就想写一篇关于中国合伙人的评论了，为此重新看了一遍，小结下细节和感受。</p>

<h3>色情杂志</h3>

<p>成东青收到孟晓骏寄来的色情杂志仔细研读，如果观察仔细的话会发现成的裤腰带解开，下身膨胀——以至于苏梅回来时惊慌的拿了一本杂志盖在下体上面。</p>

<p><img src="http://imgur.com/nOTfcbu.jpg" title="看黄色杂志被发现" alt="看黄色杂志被发现" /></p>

<h3>转变</h3>

<p>成东青的教学风格从照本宣科昏昏欲睡到妙趣横生引人入胜，发生在他得知自己被学校开除的那一刻，他失去了学校的工作，但得到了学生的尊敬。</p>

<p>之前我认为这一段是影片的一个败笔——一个人怎么可能如此快的从这一个极端走到另一个极端，在这一遍观看时我明白了——成失去学校的铁饭碗，但也卸下了学校的铁担子，成作为大学教师有太多的taboo，以至于只能通过照本宣科的方式教学；而作为私人教师则不需要顾忌那么多传统，可以用自己的方式，提高学生学习的兴趣，<strong>缓解</strong>学生学习的不适。</p>

<p>这也是&#8221;新梦想&#8221;能够在某些方面胜出传统教育的原因——&#8221;新梦想&#8221;通过幽默的语言和夸张的肢体动作缓解学习时的痛苦，使得一些忍耐力低的学生可以持续的学习，所&#8221;新梦想&#8221;可以提高平庸学生的成绩。但&#8221;新梦想&#8221;无法培养出卓越的学生——there is only a hard way to excellence。</p>

<p>任何教育就其本质而言都是填鸭式教育，&#8221;新梦想&#8221;在做的不过是在填鸭时加一点料让这件事不那么痛苦而已，这种事周星星在<strong>国产凌凌漆</strong>早就玩过：</p>

<blockquote><p>&ldquo;古時有關雲長全神貫注捉象棋刮骨療毒，今日有我凌凌漆聚精會神睇鹹帶鑿骨攞彈頭&rdquo;</p></blockquote>

<p><img src="http://i.imgur.com/9ga1qcg.jpg" alt="挖骨取弹头" /></p>

<h3>国营工厂</h3>

<p>将一个新兴的教育企业建立在破败的国营工厂里，这正是90年代的写照——国营工厂的破败，私人企业的兴起，而且有相当的私人企业是发源自破败的国营企业的，比如<a href="http://zh.wikipedia.org/wiki/%E6%B5%B7%E5%B0%94">海尔</a>。</p>

<h3>办公楼与北大</h3>

<p>电影开头王阳在两座未建成的&#8221;新梦想&#8221;办公楼面前讲课，这两座楼其实就是新东方在中关村的两座办公楼，这两座楼屹立在中关村，也就是北大的北面，骄傲的俯视着曾经把自己逐出校园的对方。</p>

<p><img src="http://i.imgur.com/mbsCVVd.jpg" title="新梦想" alt="新梦想" /></p>

<h3>Lucy的离开</h3>

<p>这个细节十分隐晦，Lucy的离开正处在1988年到1993年中间——也就是敏感的<strong>1989</strong>，这一年发生的八八事件使得中国政府在国际社会上的声望一落千丈，将中国与西方国家的关系降到了最低点，一些国内的外国人也由于此次事件离开。</p>

<p>八八事件戳破了国内充满理想的年轻人——尤其是大学生的理想，用残酷的事实告诉他们中国的现状，王阳在Lucy离开剪发剃须痛哭青春破灭不只是因为Lucy，而是因为时代。</p>

<p><img src="http://imgur.com/akYME1S.jpg" title="梦想破灭" alt="梦想破灭" /></p>

<h3>苏梅</h3>

<p>国内上映的中国合伙人有一段被剪辑了——苏梅在对成东青说分手之前是一段和外国人在草地上打炮的戏。</p>

<h3>Bug</h3>

<p>成东青为了反对公司上市将公司股权稀释到每个人身上，孟晓骏愤怒的说</p>

<blockquote><p>资治通鉴，釜底抽薪，绝对的明朝万历年间的事。</p></blockquote>

<p>不过资治通鉴里面哪来的明朝 &ndash;_&ndash;</p>

<h3>小结</h3>

<p>导演很牛逼，可以在不触犯政府敏感地带的前提下将一个跨越80年到05年的影片拍出如此的真实感，而且在商业和声誉上取得双赢，国内恐怕没有几个导演可以做到。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[第一篇博文]]></title>
    <link href="http://lucida.github.io/blog/my-first-article/"/>
    <updated>2014-01-05T17:03:00+00:00</updated>
    <id>http://lucida.github.io/blog/my-first-article</id>
    <content type="html"><![CDATA[<h2>为什么要使用Octopress</h2>

<p>之前用过不少博客，其中最长的一个<a href="http://www.cnblogs.com/figure9/">博客园博客</a>用了五年，写了不少文章，也不乏不少关注者，但我始终觉得不太爽：</p>

<ul>
<li>博客园上的文章水平太低：

<ul>
<li>倒不是装x，我并不否认博客园在国内的程序社区的地位，但这仅限于国内，一个首页上充满python入门教程或是常用排序算法的站点更适合初学者。</li>
<li>所以可以理解一些用户在&#8221;成名&#8221;之后反而选择离开。</li>
</ul>
</li>
<li>提供的编辑器不好用，尤其是代码样式难看的一B。</li>
<li>缺乏对站点的控制，尽管有一些主题但可塑性不强，自己想放一些脚本进去也不方便。</li>
<li>缺乏Mobile Readability，无论在我的iPhone 5还是Nexus 5上，精心设计的文章排版都会变成翔。</li>
</ul>


<p>直到前天和<a href="http://contributors.rubyonrails.org/contributors/oscar-del-ben/commits">Oscar</a>打桌球，我提到一直打算做一个独立博客，但由于不清楚uk这边申请域名和空间的流程而一直拖到现在，Oscar很疑惑的说如果只是一个静态博客那么用Github做host不就成了么。</p>

<p>于是这个周末做了下调研，最后目标锁定在<a href="http://octopress.org/">Octopress</a>。</p>

<h3>免费的空间</h3>

<p>Octopress是一个静态博客生成系统，使用<a href="http://jekyllrb.com/">Jekyll</a>生成静态站点，而Jekyll是Github默认的<a href="http://pages.github.com">pages</a>生成系统，因此Octopress生成的静态站点可以很方便的部署到Github Pages上。而Github提供了免费的空间，因此申请空间这步就轻松的跳过了。</p>

<h3>接近完美的样式</h3>

<p>Octopress默认的样式已经很不错，尤其是在<code>code</code>的展现和对<strong>Markdown</strong>的支持上，除此之外对<code>Markdown</code>做了一系列扩展，使得排版更加精致。
下面的代码效果令我十分满意：</p>

<figure class='code'><figcaption><span>Hello world in java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">org</span><span class="o">.</span><span class="na">java</span><span class="o">.</span><span class="na">fun</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Sample</span><span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Hello world!&quot;</span><span class="o">);</span>   
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Mobile Readablity</h3>

<p>无论是在iPad Air，还是在iPhone 5和NEXUS 5上面，Octopress的表现都堪称完美。</p>

<h3>新技术的训练</h3>

<p>很惭愧的承认自己并没有用过git，也没有用过Markdown。以至于Basia在得知我没用过git时十分惊讶</p>

<blockquote><p>How could a programmer never use git before?</p></blockquote>

<p>使用Octopress写博客可以强制自己使用git，此外如果想要对站点做一点tweak，还需要html5+css3+js+ror这一系列web开发前后端的知识，考虑到自己有做full stack developer的打算，用这个博客练手不失为一个好办法。</p>

<h2>接下来会写些什么</h2>

<ul>
<li>读过的书</li>
<li>写的代码</li>
<li>以及在london的生活感受</li>
</ul>

]]></content>
  </entry>
  
</feed>
